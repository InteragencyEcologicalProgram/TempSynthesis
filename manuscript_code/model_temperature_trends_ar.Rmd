---
title: "model_temperature_trends"
author: "Catarina Pien"
date: '2023-03-13'
output: html_document
editor_options: 
  chunk_output_type: console
---

# This is the most recent version of temperature trend modeling, including year, region + season
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(readr)
library(lubridate)
library(lme4) # glmm
library(lmerTest) #glmm p values
library(effects)
library(wateRshedTools)
library(mgcv)
library(visreg)
library(emmeans)
library(multcomp)
```

## Read in data
```{r}
tempMonthly <- readRDS(here::here("manuscript_code","Data", "tempMonthly.rds")) %>%
  filter(!(Year == 2012 & Station == "BLP" & Month == 12)) 

# Removed one month of BLP because there were only 4 values in the month that had high maximum temperatures, causing one big outlier.


tempDaily <- readRDS(here::here("manuscript_code", "Data", "tempDaily.rds"))
# temp20 <- readRDS(here("Data", "temp20years_20220125.rds"))
```

# Make metadata table for Appendix A
```{r}
LatLon <- read.csv(here::here("manuscript_code/Data/StationsMetadata.csv"))
tempTable <- tempDaily %>% left_join(LatLon) %>%
  group_by(Station) %>%
  mutate(first = min(Date),
         last = max(Date)) %>%
  dplyr::select(Station, StationName, Region, Latitude, Longitude, first, last) %>%
  distinct() %>%
  arrange(Station) %>%
  mutate(Region = case_when(Region == "Sac River" ~ "Confluence",
                            Region == "San Joaquin" ~ "Central",
                            TRUE ~ Region))
# write_csv(tempTable, "manuscript_code/Data/tables/Stations_included_10year.csv")
```

```{r}
max(tempDaily$rangeTemp)
temp_q <- tempDaily %>%
  group_by(Station) %>%
  mutate(qmax = quantile(maxDaily,0.99),
         qrange = quantile(rangeTemp, 0.995),
         qmin= quantile(minDaily, 0.99))

temp_qr <- temp_q %>%
  group_by(Station) %>%
  filter(rangeTemp<qrange)

VCU <- tempDaily %>% filter(Station == "VCU")
BLP <- temp_qr %>% filter(Station == "BLP")
South <- temp_qr %>% filter(Region == "South")
SM <- temp_qr %>% filter(Region %in% c("Suisun Marsh"))
Central <- temp_qr %>% filter(Region %in% c("San Joaquin"))
ND <- temp_qr %>% filter(Region %in% c("North Delta"))
Con <- temp_qr %>% filter(Region %in% c("Sac River"))
staOfInterest <- temp_qr %>%
  mutate(Month =  month(Date)) %>%
  filter(Station%in% c("SJR", "TEA", "BLL")) %>%
  filter(!(year(Date) == 2017 & Station == "VER" & rangeTemp>2)) %>%
  filter(!(year(Date) == 2019 & Station == "VER" & rangeTemp > 3.4)) %>%
  filter(!(year(Date) == 2018 & Station == "VER" & rangeTemp > 6)) %>%
  filter(!(year(Date) %in% c(2012, 2013) & Station == "SJR" & rangeTemp > 6)) %>%
  filter(!(year(Date) ==2010 & Station == "SJR" & rangeTemp > 4)) %>%
  filter(!(year(Date) ==2012 & Station == "VER" & Month == 11 & rangeTemp > 3)) %>%
  filter(!(year(Date) ==2018 & Station %in% c("VER", "SJR") & Month == 7 & rangeTemp <2)) %>%
  filter(Station != "VER") %>%

  mutate(StationName = case_when(Station == "BLL" ~ "Blacklock (Suisun Marsh)",
                                 Station == "TEA" ~ "Frank Horan Slough (Suisun Marsh)",
                                 Station == "SJR" ~ "San Joaquin River near Vernalis (South)")) %>% 
  mutate( Season = case_when(Month<=3~ "Winter",
                            Month %in% c(4, 5, 6)~ "Spring",
                            Month %in% c(7, 8, 9)~ "Summer", 
                            Month >=10~ "Fall",
                            TRUE~as.character(NA)))

ggplot(South) + geom_point(aes(Date, rangeTemp)) + theme_bw() +
  facet_wrap(~Station, nrow = 3)

ggplot(South) + geom_point(aes(Date, maxDaily)) + theme_bw() +
  facet_wrap(~Station, nrow = 3)

ggplot(South) + geom_point(aes(Date, minDaily)) + theme_bw() +
  facet_wrap(~Station, nrow = 3)

ggplot(VCU) + geom_point(aes(Date, maxDaily)) + theme_bw() +
  geom_point(aes(Date, minDaily), color = "blue") 

ggplot(SM) + geom_point(aes(Date, rangeTemp)) + theme_bw() +
  facet_wrap(~Station, nrow = 2) 

ggplot(Central) + geom_point(aes(Date, rangeTemp)) + theme_bw() +
  facet_wrap(~Station, nrow = 3) 

ggplot(ND) + geom_point(aes(Date, rangeTemp)) + theme_bw() +
  facet_wrap(~Station, nrow = 3) 

ggplot(Con) + geom_point(aes(Date, rangeTemp)) + theme_bw() +
  facet_wrap(~Station, nrow = 3) 



ggplot(BLP) + geom_point(aes(Date, maxDaily)) + theme_bw() +
  geom_point(aes(Date, minDaily), color = "blue") 
```

## Random range plot
```{r}
(range_plot <- ggplot(staOfInterest) + 
  geom_point(aes(Date, rangeTemp, color = Season), size = 0.6) + theme_bw() +
  facet_wrap(~StationName, nrow = 3) +
  scale_x_date(breaks = "year", date_labels = "%Y") +
  scale_color_viridis(option = "turbo", discrete = TRUE) +
  labs(y = "Daily Temperature Range (Â°C)") +
  theme(strip.text = element_text(size = 11),
        axis.title.x = element_blank()) )

png(filename = "manuscript_code/Figures/Range_plot.png", height = 5, width = 7,units = "in", 
    res = 300, pointsize = 12, family = "sans")
range_plot
dev.off()
```


## Manipulations

### 10 year
```{r}
temp <- tempMonthly  %>%
  dplyr::select(Region, Station, HabitatType,Year,  WY, WYType2_Sac, Index_c, Month, maxTemp, maxAvTemp, minAvTemp, everything())%>%
  mutate(fWY = factor(WY),
         fMonth = factor(Month),
         Season = ifelse(Month %in% c(5,6,7,8,9), "Dry", "Wet"),
         Season = factor(Season, levels = c("Wet", "Dry"))) %>%
  # mutate(Region = case_when(Region == "Far North" ~ "North Delta",
  #                           TRUE ~ Region)) %>%
  mutate(Region2 = case_when(
                            Region == "Sac River" ~ "Confluence",
                            Region == "Suisun Bay" ~ "SuisunBay",
                            Region == "San Joaquin" ~ "Central",
                            Region == "Suisun Marsh" ~ "SuisunMarsh",
                            Region == "North Delta" ~ "NorthDelta",
                            TRUE~ Region)) %>%
  mutate(Region2 = factor(Region2),
         Station = factor(Station)) %>%
  filter(WY > 2009) %>%
  filter(maxAvTemp > 7) # removed two outliers
```

# 10-year dataset

## Correlation max and min
```{r}
lm_maxmin <- lm(temp$maxAvTemp ~ temp$minAvTemp)
summary(lm_maxmin)
```

## Run models

# AR Models
```{r}
library(glmmTMB)
library(itsadug)

#need a new time variable that is year + month as a factor
temp2 = mutate(temp, 
              WM = case_when(Month %in% c(10, 11, 12) ~ Month-9,
                             TRUE ~ Month +3),
              fMonthYear = as.factor(paste(fWY, WM)),
              fMY2 = as.numeric(fMonthYear),
              MonthYear = WY+(WM-12)/12,
              fYM = factor(MonthYear))

m.maxsAR1 =  glmmTMB(maxAvTemp ~ fWY + Season * Region2 + (1|Station)+ ar1(fYM + 0|Station), data = temp2)
summary(m.maxsAR1)
emmeans(m.maxsAR1, pairwise ~ fWY)

#some of the tutorials have you do it like this instaed, seems to be pretty much the same results
m.maxsAR1b =  glmmTMB(maxAvTemp ~ fWY + Season * Region2 + (1|Station)+ ar1(fYM - 1|Station), data = temp2)
summary(m.maxsAR1b)



# Test 
library(ggplot2)
library(glmmTMB)

# Extract residuals
resid_ar1 <- resid(m.maxsAR1b, type = "pearson")

# Plot ACF and PACF
acf(resid_ar1, main = "Autocorrelation of Residuals")
pacf(resid_ar1, main = "Partial Autocorrelation of Residuals")




summary(m.maxs9 <- lmer(maxAvTemp ~ fWY + Season * Region2 + (1|Station) +(1|fMonth), data = temp))
anova(m.maxs9, type = 2)
write.csv(summary(m.maxs9)$coefficients, here("manuscript_code/Data/lmer_results/maxs9_coef.csv"))
summary <- summary(m.maxs9)
```


```{r}
summary(m.maxs9 <- lmer(maxAvTemp ~ fWY + Season * Region2 + (1|Station) +(1|fMonth), data = temp))
anova(m.maxs9, type = 2)
write.csv(summary(m.maxs9)$coefficients, here("manuscript_code/Data/lmer_results/maxs9_coef.csv"))
summary <- summary(m.maxs9)

summary(m.mins9 <- lmer(minAvTemp ~ fWY + Season * Region2 + (1|Station) +(1|fMonth), data = temp))
write.csv(summary(m.mins9)$coefficients, here("manuscript_code/Data/lmer_results/mins9_coef.csv"))

summary(m.means9 <- lmer(meanTemp ~ fWY + Season * Region2 + (1|Station) +(1|fMonth), data = temp))
```





### random effects
#### max
```{r}
re_m.maxs9 <- as.data.frame(ranef(m.maxs9)) 

re_sta_max <- re_m.maxs9 %>% filter(grpvar == "Station")%>%
  left_join(temp %>% dplyr::select(Region2, grp=Station)) %>%
  mutate(grp = factor(grp),
         grp = fct_reorder(grp, condval))

re_sta_max1 <- re_m.maxs9 %>% 
  filter(grpvar == "fMonth")%>%
  left_join(temp %>% dplyr::select(Season, grp=fMonth)) %>%
  mutate(grp = factor(grp),
         grp = fct_reorder(grp, condval))

re_max_plot <- ggplot(re_sta_max) + 
  geom_point(aes(grp, condval, color = Region2)) +
  geom_errorbar(aes(x = grp, ymin = condval-condsd, ymax = condval+condsd), width = 0.3) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95),
        axis.title = element_blank())

ggplot(re_sta_max1) + 
  geom_point(aes(grp, condval, color = Season)) +
  geom_errorbar(aes(x = grp, ymin = condval-condsd, ymax = condval+condsd), width = 0.3) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95),
        axis.title = element_blank())

library(sjPlot)
library(sjmisc)
library(sjlabelled)
sjPlot::plot_model(m.maxs9)

```

#### min
```{r}
re_m.mins9 <- as.data.frame(ranef(m.mins9))

re_sta_min <- re_m.mins9 %>% filter(grpvar == "Station")%>%
  left_join(temp %>% dplyr::select(Region2, grp=Station)) %>%
  mutate(grp = factor(grp),
         grp = fct_reorder(grp, condval))

re_sta_min1 <- re_m.mins9 %>% 
  filter(grpvar == "fMonth")%>%
  left_join(temp %>% dplyr::select(Season, grp=fMonth)) %>%
  mutate(grp = factor(grp),
         grp = fct_reorder(grp, condval))

ggplot(re_m.mins) + 
  geom_point(aes(grp, condval)) +
  geom_errorbar(aes(x = grp, ymin = condval-condsd, ymax = condval+condsd), width = 0.3) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95),
        axis.title = element_blank())
```

#### mean
```{r}
re_m.means <- as.data.frame(ranef(m.means))

ggplot(re_m.means) + 
  geom_point(aes(grp, condval)) +
  geom_errorbar(aes(x = grp, ymin = condval-condsd, ymax = condval+condsd), width = 0.3) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95),
        axis.title = element_blank())
```


### model validation
#### max
```{r}

png(filename = "manuscript_code/Figures/plots_residuals_maxmodel.png", width = 9, height = 7, units = "in", res = 300)
par(mfrow = c(2,4))
resid.maxs9 = resid(m.maxs9, type = "pearson")
lev2a = hatvalues(m.maxs9)
plot(m.maxs9)
qqnorm(resid(m.maxs9))
qqline(resid(m.maxs9))
hist(resid.maxs9)
plot(resid.maxs9)
plot(temp$Region2, resid.maxs9)
plot(temp$fWY, resid.maxs9)
plot(temp$Season, resid.maxs9)
acf(resid.maxs9)
dev.off()

#### GGPLOT VERSION
resid <- data.frame(resid.maxs9)
res_max <- cbind(temp, resid)
dat <- ggeffects::ggpredict(m.maxs9)
fitted <- fitted(m.maxs9, level = 0:1)

theme_vis <- theme_bw() +
  theme(strip.background = element_rect(color = "black", fill = "white"),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 10),
        strip.text = element_text(size = 11),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 10),
        legend.position = "top",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

### ACF Plots
conf.level <- 0.95
ciline <- qnorm((1 - conf.level)/2)/sqrt(length(resid.maxs9))
bacf <- acf(resid.maxs9, plot = FALSE)
bpacf <- pacf(resid.maxs9, plot = FALSE)
bacfdf <- with(bacf, data.frame(lag, acf))
bpacfdf <- with(bpacf, data.frame(lag, acf))
(acf <- ggplot(data = bacfdf, mapping = aes(x = lag, y = acf)) +
    geom_hline(aes(yintercept = 0)) +
    geom_hline(aes(yintercept = ciline), color = "blue", linetype = "dashed") +
    geom_hline(aes(yintercept = ciline*-1), color = "blue", linetype = "dashed") +
    geom_segment(mapping = aes(xend = lag, yend = 0)) +
    labs(y = "ACF", x = "Lag") +
    theme_vis)
(pacf <- ggplot(data = bpacfdf, mapping = aes(x = lag, y = acf)) +
    geom_hline(aes(yintercept = 0)) +
    geom_hline(aes(yintercept = ciline), color = "blue", linetype = "dashed") +
    geom_hline(aes(yintercept = ciline*-1), color = "blue", linetype = "dashed") +
    geom_segment(mapping = aes(xend = lag, yend = 0)) +
    labs(y = "pACF", x = "Lag") +
    theme_vis)


(p1 <- ggplot(res_max) + geom_point(aes(fitted, resid.maxs9)) +
    labs(x = "Fitted", y = "Residuals") +
    theme_vis)
(pq <- ggplot(res_max, aes(sample = resid.maxs9)) +
  geom_qq() +
  geom_qq_line() +
    labs(x = "Theoretical Quantiles", y = "Sample Quantiles") + 
    theme_bw())
(p2 <- ggplot(res_max) +
    geom_histogram(aes(resid.maxs9), binwidth = 0.3, color = "black", fill = "gray80") +
    labs(x = "Residuals") +
    theme_vis +
    theme(axis.title.y = element_blank()))
#(d_p3 <- acf(resid))
(p3 <- acf)
(p4 <- ggplot(res_max) +  geom_boxplot(aes(fWY, resid.maxs9)) +
    labs(x = "WY", y = "Residuals")+
      theme_vis+
   theme(axis.text.x = element_text(angle = 90, hjust = 0.95)))
(p5 <- ggplot(res_max) +  geom_boxplot(aes(Season, resid.maxs9)) +
    labs(x = "Season", y = "Residuals")+
    theme_vis+
   theme(axis.text.x = element_text(angle = 90, hjust = 0.95)))
(p6 <- ggplot(res_max) +  geom_boxplot(aes(Region2, resid.maxs9)) +
    labs(x = "Region", y = "Residuals")+
      theme_vis+
   theme(axis.text.x = element_text(angle = 90, hjust = 0.95)))
(p7 <- ggplot(re_sta_max) + 
  geom_point(aes(grp, condval, color = Region2)) +
  geom_errorbar(aes(x = grp, ymin = condval-condsd, ymax = condval+condsd), width = 0.3) +
  viridis::scale_color_viridis(option = "turbo", discrete = "TRUE")+
    labs(title = "Random Effect of Station",
         color = "Region") + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95),
        legend.position = "bottom",
        axis.title = element_blank()))
(p8 <- ggplot(re_sta_max1) + 
  geom_point(aes(grp, condval)) +
  geom_errorbar(aes(x = grp, ymin = condval-condsd, ymax = condval+condsd), width = 0.3) +
  labs(title = "Random Effect of Month") + 
    theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95),
        axis.title = element_blank()))
(p9 <- pacf)

library(patchwork)
(max_val_plots <- p1 +  pq+p2 + p3 + p4 + p5 + p6 +  p9 + plot_layout(nrow = 2))
ggsave("manuscript_code/Figures/model_validation_max_model.png", width = 8.5, height = 5.5, units = "in")

(re_plots <- p8 / p7)
ggsave("manuscript_code/Figures/model_validation_max_model_re.png", width = 7, height = 6, units = "in")


```


#### min
```{r}
#### GGPLOT VERSION
resid.mins9 = resid(m.mins9, type = "pearson")
residmin <- data.frame(resid.mins9)
res_min <- cbind(temp, residmin)
dat <- ggeffects::ggpredict(m.mins9)
fitted_min <- fitted(m.mins9, level = 0:1)

theme_vis <- theme_bw() +
  theme(strip.background = element_rect(color = "black", fill = "white"),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 10),
        strip.text = element_text(size = 11),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 10),
        legend.position = "top",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

### ACF Plots
conf.level <- 0.95
ciline <- qnorm((1 - conf.level)/2)/sqrt(length(resid.mins9))
bacf <- acf(resid.mins9, plot = FALSE)
bpacf <- pacf(resid.mins9, plot = FALSE)
bacfdf <- with(bacf, data.frame(lag, acf))
bpacfdf <- with(bpacf, data.frame(lag, acf))
(acf_min <- ggplot(data = bacfdf, mapping = aes(x = lag, y = acf)) +
    geom_hline(aes(yintercept = 0)) +
    geom_hline(aes(yintercept = ciline), color = "blue", linetype = "dashed") +
    geom_hline(aes(yintercept = ciline*-1), color = "blue", linetype = "dashed") +
    geom_segment(mapping = aes(xend = lag, yend = 0)) +
    labs(y = "ACF", x = "Lag") +
    theme_vis)
(pacf_min <- ggplot(data = bpacfdf, mapping = aes(x = lag, y = acf)) +
    geom_hline(aes(yintercept = 0)) +
    geom_hline(aes(yintercept = ciline), color = "blue", linetype = "dashed") +
    geom_hline(aes(yintercept = ciline*-1), color = "blue", linetype = "dashed") +
    geom_segment(mapping = aes(xend = lag, yend = 0)) +
    labs(y = "pACF", x = "Lag") +
    theme_vis)


(p1_min <- ggplot(res_min) + geom_point(aes(fitted_min, resid.mins9)) +
    labs(x = "Fitted", y = "Residuals") +
    theme_vis)
(pq_min <- ggplot(res_min, aes(sample = resid.mins9)) +
  geom_qq() +
  geom_qq_line() +
    labs(x = "Theoretical Quantiles", y = "Sample Quantiles") + 
    theme_bw())
(p2_min <- ggplot(res_min) +
    geom_histogram(aes(resid.mins9), binwidth = 0.3, color = "black", fill = "gray80") +
    labs(x = "Residuals") +
    theme_vis +
    theme(axis.title.y = element_blank()))
#(d_p3 <- acf(resid))
(p3_min <- acf_min)
(p4_min <- ggplot(res_min) +  geom_boxplot(aes(fWY, resid.mins9)) +
    labs(x = "WY", y = "Residuals")+
      theme_vis+
   theme(axis.text.x = element_text(angle = 90, hjust = 0.95)))
(p5_min <- ggplot(res_min) +  geom_boxplot(aes(Season, resid.mins9)) +
    labs(x = "Season", y = "Residuals")+
    theme_vis+
   theme(axis.text.x = element_text(angle = 90, hjust = 0.95)))
(p6_min <- ggplot(res_min) +  geom_boxplot(aes(Region2, resid.mins9)) +
    labs(x = "Region", y = "Residuals")+
      theme_vis+
   theme(axis.text.x = element_text(angle = 90, hjust = 0.95)))
(p7_min <- ggplot(re_sta_min) + 
  geom_point(aes(grp, condval, color = Region2)) +
  geom_errorbar(aes(x = grp, ymin = condval-condsd, ymax = condval+condsd), width = 0.3) +
  viridis::scale_color_viridis(option = "turbo", discrete = "TRUE")+
    labs(title = "Random Effect of Station",
         color = "Region") + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95),
        legend.position = "bottom",
        axis.title = element_blank()))
(p8_min <- ggplot(re_sta_min1) + 
  geom_point(aes(grp, condval)) +
  geom_errorbar(aes(x = grp, ymin = condval-condsd, ymax = condval+condsd), width = 0.3) +
  labs(title = "Random Effect of Month") + 
    theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95),
        axis.title = element_blank()))
(p9_min <- pacf_min)

library(patchwork)
(min_val_plots <- p1_min +  pq_min+p2_min + p3_min + p4_min + p5_min + p6_min +  p9_min + plot_layout(nrow = 2))
ggsave("manuscript_code/Figures/model_validation_min_model.png", width = 8.5, height = 5.5, units = "in")

(re_plots_min <- p8_min / p7_min)
ggsave("manuscript_code/Figures/model_validation_min_model_re.png", width = 7, height = 6, units = "in")

```

```{r}
par(mfrow = c(2,4))
resid.means9 = resid(m.means9, type = "pearson")
lev2a = hatvalues(m.means9)
plot(m.means9)
qqnorm(resid(m.means9))
qqline(resid(m.means9))
plot(lev2a, y = resid.means9)
hist(resid.means9)
plot(resid.means9)
plot(temp$Region2, resid.means9)
plot(temp$fWY, resid.means9)
plot(temp$Season, resid.means9)
acf(resid.means9)


par(mfrow = c(2,4))
resid.mins9 = resid(m.mins9, type = "pearson")
lev2a = hatvalues(m.mins9)
plot(m.mins9)
qqnorm(resid(m.mins9))
qqline(resid(m.mins9))
plot(lev2a, y = resid.mins9)
hist(resid.mins9)
plot(resid.mins9)
plot(temp$Region2, resid.mins9)
plot(temp$fWY, resid.mins9)
plot(temp$Season, resid.mins9)
acf(resid.mins9)
```

## Max temps


### emmeans
```{r}
emm_options(pbkrtest.limit = 8608)
# WY-------------------------------------
max9.emm <- emmeans(m.maxsAR1, "fWY") # Change model name depending on AR or not
plot(max9.emm, comparisons = TRUE) + theme_bw()
#save a dataframe of all the things the plotting function uses so we can plot with ggplot later
plotmax9 = plot(max9.emm, comparisons = TRUE, plotit = T, adjust = "bonferroni", alpha = 0.01)
ci_max9_wy = cld(max9.emm, Letters = LETTERS, alpha = 0.01, p.adj.methods = "bonferroni") %>%
  left_join(plotmax9$data) %>%
  mutate(.group = gsub(" ", "", .group))

results_max9.emm = as.data.frame(pairs(max9.emm, adjust = "bonferroni", alpha = 0.01)) %>%
  mutate(sig = ifelse(p.value<0.01, "yes",  "no")) %>%
  arrange(p.value)

# Region/Season ------------------------------
max9.emm2 <- emmeans(m.maxsAR1, ~Region2:Season) # Change model name here if desired
(plotmax9.rs = plot(max9.emm2, comparisons = TRUE, plotit = T, adjust = "bonferroni", alpha = 0.01))
# add letters
letters.rs <- cld(max9.emm2, Letters = LETTERS, alpha = 0.01, p.adj.methods = "bonferroni")%>%
  mutate(.group = gsub(" ", "", .group))

ci_max9_rs <- as.data.frame(max9.emm2) %>%
  left_join(letters.rs) %>%
  mutate(Season = ifelse(Season == "Wet", "Wet Season", ifelse(Season == "Dry", "Dry Season", NA))) %>%
  mutate(Season = factor(Season, levels = c("Wet Season", "Dry Season")))

results_max9.emm2 = as.data.frame(pairs(max9.emm2, adjust = "bonferroni", alpha = 0.01)) %>%
  mutate(sig = ifelse(p.value<0.01, "yes", "no")) %>%
  arrange(p.value)


  
# other suggested plots but a bit too crazy
emmip(m.maxs9, Region2~Season, CI = TRUE, plotit = FALSE)
plotmax9.rs <- emmeans(m.maxs9, ~ Region2*Season, adjust = "bonferroni", alpha = 0.01)
(data <- pwpp(plotmax9.rs, type = "response", adjust = "bonferroni", plotit = F))
rs <- data$data
pwpp(plotmax9.rs, type = "response", adjust = "bonferroni", by = "Season")


# results_max9.emm2 = as.data.frame(pairs(max9.emm2, adjust = "bonferroni")) %>%
#   mutate(sig = ifelse(p.value<0.01, "yes",  "no")) %>%
#   arrange(p.value)
# #multcomp::cld(pairs(max9.emm2, adjust = "bonferroni"))
```

### Year plot
```{r}
(plot_ci_max9_wy <- ggplot(data = ci_max9_wy) + 
   geom_errorbar(aes(x = fWY, ymin = upper.CL, ymax = lower.CL), size = 0.5,  width = 0.3) +
   geom_text( aes(label = .group, x = fWY, y = upper.CL + 0.3), position = position_dodge2(width = 0.75)) + 
  # geom_segment(aes(x=fWY, y=emmean, xend =fWY, yend = rcmpl), color = "orange",
  #              linewidth = 3, arrow = arrow(length = unit(.1,"inches"),
  #                                           ends = "last"))+
  # geom_segment(aes(x=fWY, y=emmean, xend = fWY, yend = lcmpl), color = "orange",
  #              linewidth = 3, arrow = arrow(unit(.1,"inches"), ends = "last"))+
  geom_segment(aes(x = fWY, y = emmean, xend = fWY, yend = rcmpl, color = .group), size = 6, color = "cadetblue3", lineend = "butt") +
    geom_segment(aes(x = fWY, y = emmean, xend = fWY, yend = lcmpl, color = .group), size = 6, color = "cadetblue3", lineend = "butt") +
     annotate(geom = "text", label = "B", x = 1, y = 22, size = 5) + 
  geom_point( aes(x=fWY, y=emmean), size = 2.5, shape = 18) +     
  viridis::scale_color_viridis(discrete = TRUE, option = "turbo") +
  scale_y_continuous(breaks = seq(14, 28, by = 1))+
  labs(y = "Water Temperature (Â°C) with 95% Confidence Intervals") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 11),
        legend.position = "top",
        axis.title.x = element_blank(),
        panel.grid.major.y = element_line(size = .1, color = "gray85")) )
```


### Region-Season plot
```{r}
# ggplot(newdata) + geom_boxplot(aes(x = fWY, y = Predicted_maxtemp))

(plot_ci_max9 <- ggplot() + 
   geom_errorbar(data = ci_max9_rs, aes(x = Season, ymin = lower.CL, ymax = upper.CL, color = Region2), size = 0.5,  width = 0.75, position = position_dodge2()) +
  geom_text(data = ci_max9_rs, aes(label = .group, x = Season, y = upper.CL + 0.5), position = position_dodge2(width = 0.75)) + 
  geom_point(data = ci_max9_rs, aes(x=Season, y=emmean), color = "black", size = 3, shape = 5, position = position_dodge2(width = 0.75)) + 
     annotate(geom = "text", label = "C", x =0.53, y = 26, size = 5) + 
  viridis::scale_color_viridis(discrete = TRUE, option = "turbo") + 
  scale_y_continuous(breaks = seq(10, 30, by = 2))+
  labs(y = "Water Temperature (Â°C) with 95% Confidence Intervals", color = "Region") +
   theme_classic() +
  theme(axis.text.x = element_text(size = 11),
        legend.position = c(0.78, 0.25),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"),
        legend.spacing.y = unit(0, "mm"), 
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.major.y = element_line(size = .1, color = "gray85")) +
   guides(color=guide_legend(ncol=2))) 

# 
# emmip(m.maxs9, ~ Region2 | Season, CIs = TRUE, type = "response") +
#     geom_point(aes(x = Region2, y = maxAvTemp), data = temp, pch = 2, color = "blue") +
#   theme_bw()
```

### Anomalies
```{r}
tempDailyb <- tempDaily %>%
  mutate(Month = month(Date),
         fWY = factor(WY),
         Season = ifelse(Month >4 & Month <10, "Dry Season", "Wet Season")) %>%
  mutate(Region = factor(Region))

temp10anomaly <- tempDailyb %>%
  group_by(Region) %>%
  mutate(meanMax = mean(maxDaily),
         meanMin = mean(minDaily)) %>%
  ungroup() %>%
  mutate(maxDiff = maxDaily-meanMax,
         minDiff = minDaily-meanMin)
  
tempAnomaly10Summary <- temp10anomaly %>%
  group_by(Region, fWY, WY, WYType2_Sac) %>%
  summarize(meanmaxAnomaly = mean(maxDiff),
            meanminAnomaly = mean(minDiff),
            sdMax = sd(maxDiff)) %>%
  ungroup()

tempAnomaly10SummaryAll <- tempAnomaly10Summary %>%
  group_by(fWY, WY, WYType2_Sac) %>%
  summarize(meanmaxAnomaly2 = mean(meanmaxAnomaly),
            meanminAnomaly2 = mean(meanminAnomaly),
            sdMax2 = sd(sdMax),
            se = sdMax2/sqrt(n())) %>%
  ungroup()

theme_fig = theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, size = 14),
        strip.text = element_text(size = 14),
        axis.title = element_text(size = 14),
        axis.text.y = element_text(size = 14),
        legend.text = element_text(size =10),
        legend.title = element_text(size = 11))

(bar10yrAnomMax <- ggplot(tempAnomaly10SummaryAll) + 
  geom_col(aes(x = fWY, y = meanmaxAnomaly2, fill = WYType2_Sac), width = 0.75, size = 1.5, alpha = 0.75) +
    geom_errorbar(aes(x = fWY, ymax = meanmaxAnomaly2 + se, ymin = meanmaxAnomaly2 - se), width = 0.2) + 
    annotate(geom = "text", label = "A", x = 1, y = 1.5, size = 5) + 
  # scale_x_continuous(breaks = seq(from = 1999, to = 2019, by = 1)) +
   scale_y_continuous(breaks = seq(-1, 2, 0.5))+
  viridis::scale_fill_viridis(discrete = TRUE) +
  labs(x = "Water Year", y = "Mean Maximum Daily Temperature (Â°C)", fill = "Water Year Type")+
  theme_classic() +
  theme(axis.text.x = element_text(size = 11),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"),
                legend.spacing.y = unit(0, "mm"), 
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.major.y = element_line(size = .1, color = "gray85"),
        legend.position = c(0.8, 0.85),
        legend.direction = "horizontal"))


# (box10yrAnomMax <- ggplot(tempAnomaly10Summary) + 
#   geom_boxplot(aes(x = fWY, y = meanmaxAnomaly, fill = WYType2_Sac), alpha = 0.3) +
#   geom_jitter(aes(x = fWY, y = meanmaxAnomaly, fill = WYType2_Sac, shape = Region), size = 1.5) +
#     geom_hline(yintercept = 0) + 
#   # scale_x_continuous(breaks = seq(from = 1999, to = 2019, by = 1)) +
#    scale_y_continuous(breaks = seq(-1, 2, 0.5))+
#   scale_fill_viridis(discrete = TRUE) +
#   labs(x = "Water Year", y = "Mean Maximum Daily Temperature (Â°C)", fill = "Water Year Type")+
#   theme_fig +
#    theme(legend.position = "top",
#          axis.title.x = element_blank(),
#          panel.grid.major = element_blank()))
```

### Combined Plot
```{r}
library(patchwork)
p4 <- ggplot(data.frame(l = "Maximum Water Temperature (Â°C)\nwith 95% Confidence Intervals", x = 1, y = 1)) +
      geom_text(aes(x, y, label = l), angle = 90) + 
      theme_void() +
      coord_cartesian(clip = "off")
plot_ci_max9_wy$labels$y <- plot_ci_max9$labels$y <- " "

png(filename = "Figures/Watertemp_trends_max2.png", height = 7.5, width = 7,units = "in", 
    res = 300, pointsize = 12, family = "sans")
(maxplot <- p4 + (plot_ci_max9_wy/plot_ci_max9) + plot_layout(widths = c(2.5,25)))

dev.off()


p5 <- ggplot(data.frame(l = "Maximum Water \nTemperature Anomaly (Â°C) \nwith Standard Error", x = 1, y = 1)) +
      geom_text(aes(x, y, label = l), angle = 90) + 
      theme_void() +
      coord_cartesian(clip = "off")
bar10yrAnomMax$labels$y <- bar10yrAnomMax$labels$y <- " "

(updated <- (p5+bar10yrAnomMax) + plot_layout(widths = c(2.5,25)))

png(filename = "manuscript_code/Figures/Watertemp_trends_max3.png", height = 8.5, width = 7,units = "in", 
    res = 300, pointsize = 12, family = "sans")
(updated/maxplot + plot_layout(heights = c(2,6.5)))
dev.off()
```


#### Effects
```{r}
effects_max9 <- effects::effect(term = "Region2", mod = m.maxs9)
summary(effects_max9)

Effect(focal.predictors = c("Region2", "Season"), mod =  m.maxs9)
eff.max9 <- allEffects(m.maxs9, fixed.predictors = c("Region2", "Season", "fWY"))
eff.max9

# Make plots
plot(eff.max9)
plot(allEffects(m.maxs9, residuals = TRUE, se = list(type = "scheffe")))
```


#------------------------

## Min temps
### emmeans
```{r}
# WY-------------------------------------
min9.emm <- emmeans(m.mins9, "fWY")
plot(min9.emm, comparisons = TRUE) + theme_bw()
#save a dataframe of all the things the plotting function uses so we can plot with ggplot later
plotmin9 = plot(min9.emm, comparisons = TRUE, plotit = F, adjust = "bonferroni", alpha = 0.01)
results_min92 = cld(min9.emm, Letters = LETTERS, alpha = 0.01, p.adj.methods = "bonferroni") %>%
  left_join(plotmin9) %>%
  mutate(.group = gsub(" ", "", .group))%>%
   mutate(across(emmean:upper.CL,~round(.x, 3))) 

results_min92 = cld(min9.emm, Letters = LETTERS, alpha = 0.01, p.adj.methods = "bonferroni") %>%
  left_join(plotmin9) %>%
  mutate(.group = gsub(" ", "", .group))%>%
   mutate(across(emmean:asymp.UCL,~round(.x, 3))) 

results_min9.emm = as.data.frame(pairs(min9.emm, adjust = "bonferroni", alpha = 0.01)) %>%
  mutate(sig = ifelse(p.value<0.01, "yes",  "no")) %>%
  arrange(p.value)



# Region/Season ------------------------------
min9.emm2 <- emmeans(m.mins9, ~ Region2:Season)
# min9.emm2 <- emmeans(m.mins9, Region2:Season)
plotmin9.rs = plot(min9.emm2, comparisons = TRUE, plotit = T, adjust = "bonferroni", alpha = 0.001)

# add letters
letters.rs.min <- cld(min9.emm2, Letters = LETTERS, alpha = 0.01, p.adj.methods = "bonferroni")%>%
  mutate(.group = gsub(" ", "", .group))

ci_min9_rs <- as.data.frame(min9.emm2) %>%
  left_join(letters.rs.min) %>%
   mutate(across(c(emmean, SE, upper.CL, lower.CL),~round(.x, 3))) %>%
  mutate(Season = ifelse(Season == "Wet", "Wet Season", ifelse(Season == "Dry", "Dry Season", NA))) %>%
  mutate(Season = factor(Season, levels = c("Wet Season", "Dry Season")))

ci_min9_rs <- as.data.frame(min9.emm2) %>%
  left_join(letters.rs.min) %>%
   mutate(across(c(emmean, SE, asymp.UCL, asymp.LCL),~round(.x, 3))) %>%
  mutate(Season = ifelse(Season == "Wet", "Wet Season", ifelse(Season == "Dry", "Dry Season", NA))) %>%
  mutate(Season = factor(Season, levels = c("Wet Season", "Dry Season")))

results_min9.emm2 = as.data.frame(pairs(min9.emm2, adjust = "bonferroni", alpha = 0.01)) %>%
  mutate(sig = ifelse(p.value<0.01, "yes", "no")) %>%
  arrange(p.value)

write_csv(results_min92, "manuscript_code/Data/emmeans_results/emmeans_min_wy.csv")
write_csv(ci_min9_rs, "manuscript_code/Data/emmeans_results/ci_rs_min.csv")
```


### Year plot
```{r}
(plot_ci_min9_wy <- ggplot(results_min92) + 
   geom_errorbar(aes(x = fWY, ymin = asymp.LCL, ymax = asymp.UCL), size = 0.5,  width = 0.3) +
      geom_text( aes(label = .group, x = fWY, y = asymp.UCL + 0.3), position = position_dodge2(width = 0.75)) + 
  # geom_segment(aes(x=fWY, y=emmean, xend =fWY, yend = rcmpl), color = "orange",
  #              linewidth = 3, arrow = arrow(length = unit(.1,"inches"),
  #                                           ends = "last"))+
  # geom_segment(aes(x=fWY, y=emmean, xend = fWY, yend = lcmpl), color = "orange",
  #              linewidth = 3, arrow = arrow(unit(.1,"inches"), ends = "last"))+
  geom_segment(aes(x = fWY, y = emmean, xend = fWY, yend = rcmpl, color = .group), size = 6, color = "cadetblue3", lineend = "butt") +
    geom_segment(aes(x = fWY, y = emmean, xend = fWY, yend = lcmpl, color = .group), size = 6, color = "cadetblue3", lineend = "butt") +
  geom_point(aes(x=fWY, y=emmean), size = 3, shape = 18) + 
  viridis::scale_color_viridis(discrete = TRUE, option = "turbo") + 
    annotate(geom = "text", label = "A", x = 1, y = 21, size = 5) + 
  scale_y_continuous(breaks = seq(14, 28, by = 1))+
  labs(y = "Water Temperature (Â°C) with 95% Confidence Intervals") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 11),
        legend.position = "top",
        axis.title.x = element_blank(),
        panel.grid.major.y = element_line(size = .1, color = "gray85")) )
```


### Region-Season plot
```{r}
# ggplot(newdata) + geom_boxplot(aes(x = fWY, y = Predicted_mintemp))

(plot_ci_min9 <- ggplot() + 
  geom_errorbar(data = ci_min9_rs, aes(x = Season, ymin = asymp.LCL, ymax = asymp.UCL, color = Region2), size = 0.5,  width = 0.75, position = position_dodge2()) +
  # geom_errorbar(data = ci_min9_rs, aes(x = Season, ymin = emmean-SE, ymin = emmean+SE ), color = "black", size = 0.2,  width = 0.75, position = position_dodge2())+
  geom_text(data = ci_min9_rs, aes(label = .group, x = Season, y = asymp.UCL + 0.5), position = position_dodge2(width = 0.75)) + 
  geom_point(data = ci_min9_rs, aes(x=Season, y=emmean, color = Region2), size = 2.5, shape = 5, position = position_dodge2(width = 0.75)) + 
        annotate(geom = "text", label = "B", x =0.53, y = 26, size = 5) + 
  viridis::scale_color_viridis(discrete = TRUE, option = "turbo") + 
  scale_y_continuous(breaks = seq(10, 30, by = 2))+
  labs(y = "Water Temperature (Â°C) with 95% Confidence Intervals", color = "Region") +
   theme_classic() +
  theme(axis.text.x = element_text(size = 11),
        legend.position = c(0.78, 0.25),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"),
        legend.spacing.y = unit(0, "mm"), 
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.major.y = element_line(size = .1, color = "gray85")) +
   guides(color=guide_legend(ncol=2))) 
```

### Combined Plot
```{r}
library(patchwork)
p4 <- ggplot(data.frame(l = "Minimum Water Temperature (Â°C) with 95% Confidence Intervals", x = 1, y = 1)) +
      geom_text(aes(x, y, label = l), angle = 90) + 
      theme_void() +
      coord_cartesian(clip = "off")
plot_ci_min9_wy$labels$y <- plot_ci_min9$labels$y <- " "




png(filename = "manuscript_code/Figures/Watertemp_trends_min.png", height = 7.5, width = 7,units = "in", 
    res = 300, pointsize = 12, family = "sans")
p4 + (plot_ci_min9_wy/plot_ci_min9) + plot_layout(widths = c(1,25))

dev.off()
```

#------------------------
## Mean temps
### emmeans
```{r}
# WY-------------------------------------
mean9.emm <- emmeans(m.means9, "fWY")
plot(mean9.emm, comparisons = TRUE) + theme_bw()
#save a dataframe of all the things the plotting function uses so we can plot with ggplot later
plotmean9 = plot(mean9.emm, comparisons = TRUE, plotit = F, adjust = "bonferroni", alpha = 0.01)
results_mean92 = cld(mean9.emm, Letters = LETTERS, alpha = 0.01, p.adj.methods = "bonferroni") %>%
  left_join(plotmean9) %>%
  mutate(.group = gsub(" ", "", .group))%>%
   mutate(across(emmean:asymp.UCL,~round(.x, 3))) 

results_mean9.emm = as.data.frame(pairs(mean9.emm, adjust = "bonferroni", alpha = 0.01)) %>%
  mutate(sig = ifelse(p.value<0.01, "yes",  "no")) %>%
  arrange(p.value)

# Region/Season ------------------------------
mean9.emm2 <- emmeans(m.means9, specs = pairwise ~ Region2:Season)
# mean9.emm2 <- emmeans(m.means9, Region2:Season)
plotmean9.rs = plot(mean9.emm2, comparisons = TRUE, plotit = F, adjust = "bonferroni", alpha = 0.01)

# add letters
letters.rs <- cld(mean9.emm2, Letters = LETTERS, alpha = 0.01, p.adj.methods = "bonferroni")%>%
  mutate(.group = gsub(" ", "", .group))
ci_mean9_rs <- as.data.frame(mean9.emm2$emmeans) %>%
  left_join(letters.rs) %>%
  mutate(across(c(emmean, SE, asymp.UCL, asymp.LCL),~round(.x, 3))) %>%
  mutate(Season = ifelse(Season == "Wet", "Wet Season", ifelse(Season == "Dry", "Dry Season", NA))) %>%
  mutate(Season = factor(Season, levels = c("Wet Season", "Dry Season")))
  
```


### Year plot
```{r}
(plot_ci_mean9_wy <- ggplot(results_mean92) + 
   geom_errorbar(aes(x = fWY, ymin = asymp.LCL, ymax = asymp.UCL), size = 0.5,  width = 0.3) +
      geom_text( aes(label = .group, x = fWY, y = asymp.UCL + 0.3), position = position_dodge2(width = 0.75)) + 
  # geom_segment(aes(x=fWY, y=emmean, xend =fWY, yend = rcmpl), color = "orange",
  #              linewidth = 3, arrow = arrow(length = unit(.1,"inches"),
  #                                           ends = "last"))+
  # geom_segment(aes(x=fWY, y=emmean, xend = fWY, yend = lcmpl), color = "orange",
  #              linewidth = 3, arrow = arrow(unit(.1,"inches"), ends = "last"))+
  geom_segment(aes(x = fWY, y = emmean, xend = fWY, yend = rcmpl, color = .group), size = 6, color = "cadetblue3", lineend = "butt") +
    geom_segment(aes(x = fWY, y = emmean, xend = fWY, yend = lcmpl, color = .group), size = 6, color = "cadetblue3", lineend = "butt") +
  geom_point(aes(x=fWY, y=emmean), size = 3, shape = 18) + 
  viridis::scale_color_viridis(discrete = TRUE, option = "turbo") + 
  scale_y_continuous(breaks = seq(14, 28, by = 1))+
  labs(y = "Water Temperature (Â°C) with 95% Confidence Intervals") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 11),
        legend.position = "top",
        axis.title.x = element_blank(),
        panel.grid.major.y = element_line(size = .1, color = "gray85")) )
```


### Region-Season plot
```{r}
# ggplot(newdata) + geom_boxplot(aes(x = fWY, y = Predicted_meantemp))

(plot_ci_mean9 <- ggplot() + 
  geom_errorbar(data = ci_mean9_rs, aes(x = Season, ymin = asymp.LCL, ymax = asymp.UCL, color = Region2), size = 0.5,  width = 0.75, position = position_dodge2()) +
  # geom_errorbar(data = ci_mean9_rs, aes(x = Season, ymean = emmean-SE, ymean = emmean+SE ), color = "black", size = 0.2,  width = 0.75, position = position_dodge2())+
  
  geom_text(data = ci_mean9_rs, aes(label = .group, x = Season, y = asymp.UCL + 0.5), position = position_dodge2(width = 0.75)) + 
  
  geom_point(data = ci_mean9_rs, aes(x=Season, y=emmean, color = Region2), size = 2.5, shape = 5, position = position_dodge2(width = 0.75)) + 
  
  viridis::scale_color_viridis(discrete = TRUE, option = "turbo") + 
  scale_y_continuous(breaks = seq(10, 30, by = 2))+
  
  labs(y = "Water Temperature (Â°C) with 95% Confidence Intervals", color = "Region") +

   theme_classic() +
  theme(axis.text.x = element_text(size = 11),
        legend.position = c(0.15, 0.7),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"),
        legend.spacing.y = unit(0, "mm"), 
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.major.y = element_line(size = .1, color = "gray85")))
```

### Combined Plot
```{r}
library(patchwork)
p4 <- ggplot(data.frame(l = "Mean Water Temperature (Â°C) with 95% Confidence Intervals", x = 1, y = 1)) +
      geom_text(aes(x, y, label = l), angle = 90) + 
      theme_void() +
      coord_cartesian(clip = "off")
plot_ci_mean9_wy$labels$y <- plot_ci_mean9$labels$y <- " "




png(filename = "manuscript_code/Figures/Watertemp_trends_mean.png", height = 7.5, width = 7,units = "in", 
    res = 300, pointsize = 12, family = "sans")
p4 + (plot_ci_mean9_wy/plot_ci_mean9) + plot_layout(widths = c(1,25))

dev.off()
```

## Write emmeans results
```{r}
write_csv(pairs_mmaxs_rs, "manuscript_code/Data/emmeans_results/seasonal_emmeans_m.maxrs.csv")
write_csv(pairs_mmeans_rs, "manuscript_code/Data/emmeans_results/seasonal_emmeans_m.meanrs.csv")
write_csv(pairs_mmins_rs, "manuscript_code/Data/emmeans_results/seasonal_emmeans_m.minrs.csv")
write_csv(pairs_mmaxs_wy, "manuscript_code/Data/emmeans_results/seasonal_emmeans_m.maxwy.csv")
write_csv(pairs_mmeans_wy, "manuscript_code/Data/emmeans_results/seasonal_emmeans_m.meanwy.csv")
write_csv(pairs_mmins_wy, "manuscript_code/Data/emmeans_results/seasonal_emmeans_m.minwy.csv")

write_csv(ci_max9_rs, "manuscript_code/Data/emmeans_results/ci_rs.csv")
write_csv(results_max92, "manuscript_code/Data/emmeans_results/ci_wy.csv")

write_csv(ci_min9_rs, "manuscript_code/Data/emmeans_results/ci_rs_min.csv")
write_csv(results_min92, "manuscript_code/Data/emmeans_results/ci_wy_min.csv")

write_csv(ci_mean9_rs, "manuscript_code/Data/emmeans_results/ci_rs_mean.csv")
write_csv(results_mean92, "manuscript_code/Data/emmeans_results/ci_wy_mean.csv")

```
