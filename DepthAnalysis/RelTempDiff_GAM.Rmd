---
title: "RelTempDiff_GAMs"
author: "Catarina Pien"
date: "8/5/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

#Current GAMs

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
### load all libraries, added all libraries from previous depthdatavisualiztion.rmd whether we necessarily needed them or not.
library(tidyverse)
library(lubridate)
library(readr)
library(plotly)
library(tidyr)
library(visreg)
library(itsadug)
library(mgcv)
library(ggplot2)
library(dplyr)
library(ggpubr)
library(viridis)
library(stargazer)
```

WD, Read in Data, Separate by Station
```{r}
## set wd, read in CSV relative tempdiff, bring over all data
relativetempdiff <- readRDS("DepthAnalysis/Data/RelativeTempDiff2.rds")
## relativetempdiff has all of our parameters: julian day, WY, sinejulian, sinehour etc and is the correct timeframe

relativetempdiff <- relativetempdiff %>% select(-Stress)

# Add factor variables
relativetempdiff$fWY = factor(relativetempdiff$WY)
relativetempdiff$fYear = factor(relativetempdiff$Year)

# Filter to just water years 2013-2019 
relativetempdiff <- filter(relativetempdiff, WY < 2020 & WY > 2012)

# filter to only those on the hour
relativetempdiff$minute <- minute(relativetempdiff$Datetime)
relativetempdiff <- filter(relativetempdiff, minute == "0")

relativetempdiff <- filter(relativetempdiff, !is.na(RelTempDiff))

info <- relativetempdiff %>%
  group_by(Station, fWY) %>%
  summarize(n =  n())

## filter the relativetempdiff for each station so I can bring in the models or try the models first
RelTempDiff_MRZ <- relativetempdiff %>% filter(Station == "MRZ") %>% ungroup()
RelTempDiff_RRI <- relativetempdiff %>% filter(Station == "RRI") %>% ungroup()
RelTempDiff_MAL <- relativetempdiff %>% filter(Station == "MAL")
RelTempDiff_ANH <- relativetempdiff %>% filter(Station == "ANH")

```

# Plot of all 4 stations
```{r}
relativetempdiff <- filter(relativetempdiff, !is.na(TOD))
relativetempdiff$TOD <- recode_factor(relativetempdiff$TOD,
                                      `Early:0-7` = "Early:0-7",
                                      `Mid:7-15` = "Mid:8-15")
levels(relativetempdiff$TOD)


ggplot(relativetempdiff, aes(x= julian, y = RelTempDiff))+ 
  geom_smooth(aes(color = TOD), method = "loess", se = T, fullrange = T) +
  facet_wrap(~Station) + 
  theme_bw() + theme(
    strip.text = element_text(size = 13, colour = "white", face = "bold"),
    strip.background = element_rect(fill = "black"),
    axis.text = element_text(size = 13),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13)) +
    scale_x_continuous(expand = c(0,0)) +
    scale_y_continuous(expand = c(0,0))+
  #scale_color_viridis(discrete = TRUE) + guides(colour = guide_legend(override.aes = list(size=4)))+
  labs(y = expression("Temperature difference from surface " ( degree~C)),
       x = "Day of year") +
  scale_color_viridis(discrete = TRUE) + guides(colour = guide_legend(title = "Time of Day", override.aes = list(size=4)))
```

# Plot Surface temps 4 stations
```{r}
relativetempdiff <- filter(relativetempdiff, !is.na(TOD))

ggplot(relativetempdiff, aes(x= julian, y = Surface))+ 
  geom_smooth(aes(color = TOD), method = "loess", se = T, fullrange = T) +
  facet_wrap(~Station) + 
  theme_bw() + theme(
    strip.text = element_text(size = 13, colour = "white", face = "bold"),
    strip.background = element_rect(fill = "black"),
    axis.text = element_text(size = 13),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13)) +
    scale_x_continuous(expand = c(0,0)) +
    scale_y_continuous(expand = c(0,0))+
  #scale_color_viridis(discrete = TRUE) + guides(colour = guide_legend(override.aes = list(size=4)))+
  labs(y = expression("Temperature difference from surface " ( degree~C)),
       x = "Day of year") +
  scale_color_viridis(discrete = TRUE) + guides(colour = guide_legend(title = "Time of Day", override.aes = list(size=4)))
```

# Surface temp all

```{r}
Surfacesummary <- relativetempdiff %>%
  group_by(Station, WY) %>%
  summarize(meanSurface = mean(Surface),
            minSurface = min(Surface))

ggplot(Surfacesummary, aes(x = WY, y = meanSurface, color = Station)) + geom_point(size = 4) + theme_bw()
```

# Surface temp RRI
```{r}
RRIST <- ggplot(RelTempDiff_RRI, aes(x= julian, y = Surface))+ geom_smooth(aes(color = TOD), 
  method = "loess", se = T, fullrange = T) +
  facet_wrap(~fWY) + 
  theme_bw() + theme(strip.text = element_text(size = 14),
                     axis.text = element_text(size = 14),
                     axis.text.x = element_text(angle = 90),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14)) +
  #scale_color_viridis(discrete = TRUE) + guides(colour = guide_legend(override.aes = list(size=4)))+
  labs(y = "Surface Temp (C)",
       x = "Julian Day") +
  scale_color_viridis(discrete = TRUE) + guides(colour = guide_legend(title = "Time of Day", override.aes = list(size=4)))

RRIST
```

Surface temperature differences
```{r}
ggplot(RelTempDiff_RRI, aes(x= julian, y = Surface))+ geom_smooth(aes(color = TOD), 
  method = "loess", se = T, fullrange = T) +
  facet_wrap(~fWY) + 
  theme_bw() + theme(strip.text = element_text(size = 14),
                     axis.text = element_text(size = 14),
                     axis.text.x = element_text(angle = 90),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14)) +
  #scale_color_viridis(discrete = TRUE) + guides(colour = guide_legend(override.aes = list(size=4)))+
  labs(y = "Surface Temperature (C)",
       x = "Julian Day") +
  scale_color_viridis(discrete = TRUE) + guides(colour = guide_legend(title = "Time of Day", override.aes = list(size=4)))


ggplot(RelTempDiff_MRZ, aes(x= julian, y = Surface))+ geom_smooth(aes(color = TOD), 
  method = "loess", se = T, fullrange = T) +
  facet_wrap(~fWY) + 
  theme_bw() + theme(strip.text = element_text(size = 14),
                     axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     axis.text.x = element_text(angle = 90),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14)) +
  scale_color_viridis(discrete = TRUE) + guides(colour = guide_legend(override.aes = list(size=4)))+
  labs(y = "Surface Temperature (C)",
       x = "Julian Day") +
  scale_color_viridis(discrete = TRUE) + guides(colour = guide_legend(title = "Time of Day", override.aes = list(size=4)))


```

# Rel temp diff RRI and MRZ
```{r}
RelTempDiff_RRI <- filter(RelTempDiff_RRI, !is.na(TOD))
RelTempDiff_MRZ <- filter(RelTempDiff_MRZ, !is.na(TOD))

RRIlines <- ggplot(RelTempDiff_RRI, aes(x= julian, y = RelTempDiff))+ geom_smooth(aes(color = TOD), 
  method = "loess", se = T, fullrange = T) +
  facet_wrap(~fWY) + 
  theme_bw() + theme(strip.text = element_text(size = 14),
                     axis.text = element_text(size = 14),
                     axis.text.x = element_text(angle = 90),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14)) +
  #scale_color_viridis(discrete = TRUE) + guides(colour = guide_legend(override.aes = list(size=4)))+
  labs(y = "Relative Temperature Difference (C)",
       x = "Julian Day") +
  scale_color_viridis(discrete = TRUE) + guides(colour = guide_legend(title = "Time of Day", override.aes = list(size=4)))

RRIlines

MRZlines <- ggplot(RelTempDiff_MRZ, aes(x= julian, y = RelTempDiff))+ geom_smooth(aes(color = TOD), 
  method = "loess", se = T, fullrange = T) +
  facet_wrap(~fWY) + 
  theme_bw() + theme(strip.text = element_text(size = 14),
                     axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     axis.text.x = element_text(angle = 90),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14)) +
  scale_color_viridis(discrete = TRUE) + guides(colour = guide_legend(override.aes = list(size=4)))+
  labs(y = "Relative Temperature Difference (C)",
       x = "Julian Day") +
  scale_color_viridis(discrete = TRUE) + guides(colour = guide_legend(title = "Time of Day", override.aes = list(size=4)))

MRZlines

```

## RRI


```{r}
gamRRISimp <- bam(RelTempDiff~ fWY + s(julian, by = fWY , k=14, bs = "cc"), data = RelTempDiff_RRI,family = scat,method = "fREML", nthreads = 3, discrete = TRUE)
summary(gamRRISimp)
par(mfrow=c(2,2))
gam.check(gamRRISimp)
plot(gamRRISimp, pages = 1, all.terms = TRUE)
par(mfrow=c(1,1))
vis.gam(x = gamRRISimp,
        view = c("julian", "Hour"),
        color = "heat", plot.type = "contour", type = "response")
```


```{r}
gamHour <- bam(RelTempDiff~te(Hour, by = fWY, k = 14, bs = "cc"),                          data = RelTempDiff_RRI,
                         family = scat, method = "fREML",
                         nthreads = 3,
                         discrete = TRUE)
par(mfrow=c(2,2))
gam.check(gamHour)
plot(gamHour, pages = 1, all.terms = TRUE)
par(mfrow=c(1,1))
vis.gam(x = gamRRISimp,
        view = c("julian", "Hour"),
        color = "heat", plot.type = "contour", type = "response")
```


Create anomaly (same as Brian's) using model of surface data. Add anomaly to data. 
Use lowest k possible - don't want it to be too fitted.
```{r}
gamAnomaly <- bam(Surface~te(julian,Hour, k = c(5,5), bs = c("cc", "cc")), 
                         data = RelTempDiff_RRI,
                         family = scat, method = "fREML",
                         nthreads = 3,
                         discrete = TRUE)
par(mfrow = c(2,2))
gam.check(gamAnomaly)
acf(resid(gamAnomaly))
par(mfrow = c(1,1))
plot(gamAnomaly, all.terms = TRUE, pages = 1)

# data-fitted values is type = response
# Use residuals from surface temperature as Anomaly 


```


Original anomaly (use this)
```{r}
# Add residuals in
RelTempDiff_RRI <- RelTempDiff_RRI%>%
  mutate(Anomaly = resid(gamAnomaly, type = "response"))

range(RelTempDiff_RRI$Anomaly)

RelTempDiff_RRI <- RelTempDiff_RRI %>%
  group_by(julian, Hour) %>%
  mutate(meanTemp = mean(Surface),
         Anomaly2 = Surface-meanTemp) %>%
  ungroup()

str(RelTempDiff_RRI)
hist(RelTempDiff_RRI$RelTempDiff)
```

### Model 1
Original anomaly
```{r}
RelTempDiff_RRI <- RelTempDiff_RRI %>%
  group_by(julian, Hour) %>%
  mutate(meanTemp = mean(Surface),
         Anomaly2 = Surface-meanTemp) %>%
  ungroup()

range(RelTempDiff_RRI$Anomaly2)
str(RelTempDiff_RRI)
hist(RelTempDiff_RRI$RelTempDiff)
```


Model with anomaly
```{r}
gamRRI1 <- bam(RelTempDiff~ te(julian, Hour, Anomaly,  k = c(14,7,6), bs = c("cc", "cc", "tp")), data = RelTempDiff_RRI,family = scat,method = "fREML", nthreads = 3, discrete = TRUE)
summary(gamRRI1)
par(mfrow=c(2,2))
gam.check(gamRRI1)
par(mfrow=c(1,1))
vis.gam(x = gamRRI1,
        view = c("julian", "Hour"),
        color = "heat", plot.type = "contour", type = "response")

```

Model with year
```{r}
gamRRI2 <- bam(RelTempDiff~ fWY + te(julian, Hour, by = fWY,  k = 15, bs = "cc"), data = RelTempDiff_RRI, family = scat, method = "fREML", nthreads = 3, discrete = TRUE)
summary(gamRRI2)

par(mfrow=c(2,2))
gam.check(gamRRI2)
par(mfrow=c(1,1))
plot(gamRRI2, pages = 1, all.terms = TRUE)
vis.gam(x = gamRRI2,
        view = c("julian", "Hour"),
        color = "heat", plot.type = "contour", type = "response")
```

Model with Anomaly2
```{r}
gamRRI3 <- bam(RelTempDiff~ te(julian, Hour, Anomaly2,  k = c(12,6,5), bs = c("cc", "cc", "tp")), data = RelTempDiff_RRI,family = scat,method = "fREML", nthreads = 3, discrete = TRUE)

par(mfrow=c(2,2))
gam.check(gamRRI3)
par(mfrow=c(1,1))
vis.gam(x = gamRRI3,
        view = c("julian", "Hour"),
        color = "heat", plot.type = "contour", type = "response")
```

TOD
```{r}
RelTempDiff_RRI <- filter(RelTempDiff_RRI,!is.na(TOD))
RelTempDiff_RRI$TOD <- as.factor(RelTempDiff_RRI$TOD)

gamRRI4 <- bam(RelTempDiff~ TOD + s(julian, Anomaly, by=TOD, k = c(12,6), bs = c("cc", "cc")), data = RelTempDiff_RRI, family = scat, method = "fREML", nthreads = 3, discrete = TRUE)

summary(gamRRI4)
par(mfrow=c(2,2))
gam.check(gamRRI4)
plot(gamRRI4, pages = 1, all.terms = TRUE)
vis.gam(x = gamRRI4,
        #view = c("julian", "TOD"),
        color = "heat", plot.type = "contour", type = "response")
```


```{r}
RelTempDiff_RRI <- filter(RelTempDiff_RRI,!is.na(TOD))
RelTempDiff_RRI$TOD <- as.factor(RelTempDiff_RRI$TOD)

gamRRI5 <- bam(RelTempDiff~ TOD + s(julian, by=TOD, k = 10, bs = "cc") + fWY + s(julian, by = fWY, k = 12, bs = "cc"), data = RelTempDiff_RRI, family = scat, method = "fREML", nthreads = 3, discrete = TRUE)

gamMRZ5 <- bam(RelTempDiff~ TOD + s(julian, by=TOD, k = 10, bs = "cc") + fWY + s(julian, by = fWY, k = 12, bs = "cc"), data = RelTempDiff_MRZ, family = scat, method = "fREML", nthreads = 3, discrete = TRUE)

summary(gamRRI5)
par(mfrow=c(2,2))
gam.check(gamRRI5)
plot(gamRRI5, pages = 1, all.terms = TRUE)
vis.gam(x = gamRRI3,
        #view = c("julian", "TOD"),
        color = "heat", plot.type = "contour", type = "response")
```


### Predictions for GAMs
```{r}
### GAM 1
newdataRRI1 <- expand.grid(#Create all combinations of predictor variables
                       julian = with(RelTempDiff_RRI, min(julian):max(julian)),
                       Anomaly = c(-3, -1.5, 0, 1.5, 3),
                       Hour = 1:24) %>%
                       # Standardize each variable based on full dataset for model
          mutate(julian_s=(julian-mean(RelTempDiff_RRI$julian, na.rm=T))/sd(RelTempDiff_RRI$julian, na.rm=T),
                 Hour_s=(Hour-mean(RelTempDiff_RRI$Hour, na.rm=T))/sd(RelTempDiff_RRI$Hour, na.rm=T),
                 Anomaly_s=(Anomaly-mean(RelTempDiff_RRI$Anomaly, na.rm=T))/sd(RelTempDiff_RRI$Anomaly, na.rm=T))


gamRRI1_pred<-predict(gamRRI1, newdata=newdataRRI1, type="terms", se.fit=TRUE, discrete=T)

### GAM 3
newdataRRI3 <- expand.grid(#Create all combinations of predictor variables
                       julian = with(RelTempDiff_RRI, min(julian):max(julian)),
                       Anomaly2 = c(-3, -1.5, 0, 1.5, 3),
                       Hour = 1:24) %>%
                       # Standardize each variable based on full dataset for model
          mutate(julian_s=(julian-mean(RelTempDiff_RRI$julian, na.rm=T))/sd(RelTempDiff_RRI$julian, na.rm=T),
                 Hour_s=(Hour-mean(RelTempDiff_RRI$Hour, na.rm=T))/sd(RelTempDiff_RRI$Hour, na.rm=T),
                 Anomaly2_s=(Anomaly2-mean(RelTempDiff_RRI$Anomaly2, na.rm=T))/sd(RelTempDiff_RRI$Anomaly2, na.rm=T))

gamRRI3_pred<-predict(gamRRI3, newdata=newdataRRI3, type="terms", se.fit=TRUE, discrete=T)

```

### Plots
Plot predictions model 1
```{r}
library(viridis)
library(grid)
library(gridExtra)
library(metR)

predictions1 <- data.frame(gamRRI1_pred$fit, gamRRI1_pred$se.fit)
colnames(predictions1) <- c("fit", "se.fit")
range(gamRRI1_pred$fit)
RRIPlot1 <- cbind(newdataRRI1, predictions1) %>%
  mutate(fit = round(fit,2),
         se.fit = round(se.fit,2))


# Plotting function
AnomalyPlot <- function(df, Anomaly = 0) {
  Anomaly = enquo(Anomaly)
  breaks = seq(-3,1, by = 0.2)
  
  dplyr::filter(df, Anomaly == UQ(Anomaly)) %>%
    ggplot(mapping = aes(x = julian, y = Hour, z = fit)) +
    geom_raster(mapping = aes(fill = fit)) + 
    scale_fill_viridis_c(breaks = seq(from = -2.5, to = 1.0, by = 0.5), na.value="white",limits = c(-2.5,1))+
    geom_contour(colour = "white") +
    geom_text_contour(stroke = 0.2, breaks = breaks, check_overlap = TRUE) +
    theme_classic() +
    theme(axis.text = element_text(size = 13),
          plot.title = element_text(hjust = 0.5))+
    labs(title = Anomaly) +
    guides(fill=guide_colorbar(title="RelDiff"))
}

# Make Plots
pvcool <-AnomalyPlot(RRIPlot1, -3)
pcool <- AnomalyPlot(RRIPlot1, Anomaly = -1.5) + theme(legend.position = "none")
pavg <- AnomalyPlot(RRIPlot1, Anomaly = 0)  + theme(legend.position = "none")
pwarm <- AnomalyPlot(RRIPlot1, Anomaly = +1.5)  + theme(legend.position = "none")
pvwarm <- AnomalyPlot(RRIPlot1, Anomaly = +3)

# Plots combined
grid.arrange(pvcool, pcool, pavg, pwarm, pvwarm, nrow = 2)


```


Exploring Anomaly values
```{r}
# How does Anomaly compare with original Anomaly? Pretty close to linear.
ggplot(RelTempDiff_RRI, aes(Anomaly, Anomaly2)) + geom_point() + geom_smooth(method = "lm")
# Are there only certain years that reached anomaly of -1.5? Two primary cool years - 2017, 2019
ggplot(RelTempDiff_RRI, aes(x = fWY, y = Anomaly, fill = fWY)) + geom_boxplot() +scale_fill_viridis(discrete = TRUE)
ggplot(RelTempDiff_RRI, aes(x = fWY, y = RelTempDiff, color = Anomaly)) + geom_jitter()+scale_color_viridis()

Anom0 <- ggplot(subset(RelTempDiff_RRI, Anomaly > -0.5 & Anomaly < 0.5), aes(x = fWY, y = RelTempDiff, color = Anomaly)) + geom_jitter()+scale_color_viridis() +
  labs(title = "Anomaly -0.5 to 0.5")
AnomNeg15 <- ggplot(subset(RelTempDiff_RRI, Anomaly > -2 & Anomaly < -1), aes(x = fWY, y = RelTempDiff, color = Anomaly, text = paste('Date: ', Date,
                                 '<br>Anomaly: ', Anomaly))) + geom_jitter()+scale_color_viridis() +  labs(title = "Anomaly -2 to -1")
grid.arrange(Anom0, AnomNeg15)
ggplotly(AnomNeg15, tooltip = c("y", "text"))

ggplot(subset(RelTempDiff_RRI, Anomaly > -3 & Anomaly < 3), aes(x = Anomaly, y = RelTempDiff, color = fWY), alpha = 0.3) + geom_jitter() + scale_color_viridis(discrete = TRUE)


# Is reltempdiff lower during lower anomalies? Yes but specifically around -1.5.
v1 <- ggplot(subset(RelTempDiff_RRI, Anomaly > -3 & Anomaly < 3), aes(x = Anomaly, y = RelTempDiff, color = julian)) + geom_jitter() + scale_color_viridis()
v2 <- ggplot(RRIPlot1, aes(x = Anomaly, y = fit, color = julian)) + geom_jitter() + scale_color_viridis()
grid.arrange(v1,v2, nrow = 1)


```

```{r}
meanMonthly = RelTempDiff_RRI %>%
  group_by(fWY, Month) %>%
  summarize(meanSurface = mean(Surface),
            meanAnomaly = mean(Anomaly),
            meanBottom = mean(Bottom),
            meanDiff = mean(RelTempDiff))

plotS <- ggplot(meanMonthly, aes(Month, meanSurface, color = fWY)) + geom_point() + geom_smooth(aes(color = fWY), se = FALSE) + labs(title = "Surface")

plotB <- ggplot(meanMonthly, aes(Month, meanBottom, color = fWY)) + geom_point() + geom_smooth(aes(color = fWY), se = FALSE) + labs(title = "Bottom")

grid.arrange(plotS, plotB)

(ggplot(meanMonthly, aes(color = fWY)) +
  geom_line(aes(Month, meanSurface)) +
  geom_line(aes(Month, meanDiff)) + theme_bw())
```

Relative Temp Difference greater in cooler years of 2017 and 2019 during July - August - why?
For other years, relative temp difference greatest in May. Not sure why...


Make plots for model 3
```{r}
predictions3 <- data.frame(gamRRI3_pred$fit, gamRRI3_pred$se.fit)
colnames(predictions3) <- c("fit", "se.fit")
range(gamRRI3_pred$fit)
RRIPlot3 <- cbind(newdataRRI3, predictions3) %>%
  mutate(fit = round(fit,2),
         se.fit = round(se.fit,2))

# Plotting function
Anomaly2Plot <- function(df, Anomaly2 = 0) {
  Anomaly2 = enquo(Anomaly2)
  breaks = seq(-3,1, by = 0.2)
  
  dplyr::filter(df, Anomaly2 == UQ(Anomaly2)) %>%
    ggplot(mapping = aes(x = julian, y = Hour, z = fit)) +
    geom_raster(mapping = aes(fill = fit)) + 
    scale_fill_viridis_c(breaks = seq(from = -3, to = 1.0, by = 0.5), na.value="white",limits = c(-3,1))+
    geom_contour(colour = "white") +
    geom_text_contour(stroke = 0.2, breaks = breaks, check_overlap = TRUE) +
    theme_classic() +
    theme(axis.text = element_text(size = 14))+
    labs(title = Anomaly2) +
    guides(fill=guide_colorbar(title="RelDiff"))
}

# Make Plots
pvcool3 <-Anomaly2Plot(RRIPlot3, Anomaly2 = -3)
pcool3 <- Anomaly2Plot(RRIPlot3, Anomaly2 = -1.5)
pavg3 <- Anomaly2Plot(RRIPlot3, Anomaly2 = 0)
pwarm3 <- Anomaly2Plot(RRIPlot3, Anomaly2 = 1.5)
pvwarm3 <- Anomaly2Plot(RRIPlot3, Anomaly2 = 3)

# Plots combined
grid.arrange(pvcool3, pcool3, pavg3, pwarm3, pvwarm3, nrow = 2)
```

















## MRZ

Create anomaly using model of surface data. Add anomaly to data. 
Use lowest k possible - don't want it to be too fitted.
```{r}
gamAnomaly2 <- bam(Surface~te(julian,Hour, k = c(5,5), bs = c("cc", "cc")), 
                         data = RelTempDiff_MRZ,
                         family = scat, method = "fREML",
                         nthreads = 3,
                         discrete = TRUE)
par(mfrow = c(2,2))
gam.check(gamAnomaly2)
par(mfrow = c(1,1))
plot(gamAnomaly2, all.terms = TRUE, pages = 1)

# data-fitted values is type = response
# Use residuals from surface temperature as Anomaly 

RelTempDiff_MRZ <- RelTempDiff_MRZ%>%
  mutate(Anomaly = resid(gamAnomaly2, type = "response"))

range(RelTempDiff_MRZ$Anomaly)
```

Original anomaly
```{r}
RelTempDiff_MRZ <- RelTempDiff_MRZ %>%
  group_by(julian, Hour) %>%
  mutate(meanTemp = mean(Surface),
         Anomaly2 = Surface-meanTemp) %>%
  ungroup()

str(RelTempDiff_MRZ)
hist(RelTempDiff_MRZ$RelTempDiff)
```


Model with anomaly
```{r}
gamMRZ1 <- bam(RelTempDiff~ te(julian, Hour, Anomaly,  k = c(14,8,6), bs = c("cc", "cc", "tp")), data = RelTempDiff_MRZ,family = scat,method = "fREML", nthreads = 3, discrete = TRUE)

summary(gamMRZ1)
par(mfrow=c(2,2))
gam.check(gamMRZ1)
par(mfrow=c(1,1))
vis.gam(x = gamMRZ1,
        view = c("julian", "Hour"),
        color = "heat", plot.type = "contour", type = "response")

```


```{r}
gamMRZ2 <- bam(RelTempDiff~ te(julian, Hour, fWY, d = c(2,1), k = c(15,7), bs = c("cc", "tp")), data = RelTempDiff_MRZ, family = scat, method = "fREML", nthreads = 3, discrete = TRUE)
```

TOD
```{r}
RelTempDiff_MRZ <- filter(RelTempDiff_MRZ,!is.na(TOD))
RelTempDiff_MRZ$TOD <- as.factor(RelTempDiff_MRZ$TOD)

gamMRZ3 <- bam(RelTempDiff~ TOD + s(julian, by=TOD, k = 16, bs = "cc"), data = RelTempDiff_MRZ, family = scat, method = "fREML", nthreads = 3, discrete = TRUE)
summary(gamMRZ3)
par(mfrow=c(2,2))
gam.check(gamMRZ3)
plot(gamMRZ3, pages = 1, all.terms = TRUE)
vis.gam(x = gamMRZ3,
        #view = c("julian", "TOD"),
        color = "heat", plot.type = "contour", type = "response")

```

```{r}
RelTempDiff_MRZ <- filter(RelTempDiff_MRZ,!is.na(TOD))
RelTempDiff_MRZ$TOD <- as.factor(RelTempDiff_MRZ$TOD)

gamMRZ4 <- bam(RelTempDiff~ TOD + s(julian, by=TOD, k = 18, bs = "cc") +  te(julian, Anomaly, k = c(14,6), bs = c("cc", "tp")), data = RelTempDiff_MRZ, family = scat, method = "fREML", nthreads = 3, discrete = TRUE)

summary(gamMRZ4)
par(mfrow=c(2,2))
gam.check(gamMRZ4)
plot(gamMRZ4, pages = 1, all.terms = TRUE)
vis.gam(x = gamMRZ3,
        #view = c("julian", "TOD"),
        color = "heat", plot.type = "contour", type = "response")
```


```{r}
RelTempDiff_MRZ <- filter(RelTempDiff_MRZ,!is.na(TOD))
RelTempDiff_MRZ$TOD <- as.factor(RelTempDiff_MRZ$TOD)

gamMRZ5 <- bam(RelTempDiff~ TOD + s(julian, by=TOD, k = 10, bs = "cc") + fWY + s(julian, by = fWY, k = 12, bs = "cc"), data = RelTempDiff_MRZ, family = scat, method = "fREML", nthreads = 3, discrete = TRUE)

summary(gamMRZ5)
par(mfrow=c(2,2))
gam.check(gamMRZ5)
plot(gamMRZ5, pages = 1, all.terms = TRUE)
vis.gam(x = gamMRZ3,
        #view = c("julian", "TOD"),
        color = "heat", plot.type = "contour", type = "response")
```


Predictions
```{r}
newdataMRZ <- expand.grid(#Create all combinations of predictor variables
                       julian = with(RelTempDiff_MRZ, min(julian):max(julian)),
                       Anomaly = c(-3, -1.5, 0, 1.5, 3),
                       Hour = 1:24) %>%
                       # Standardize each variable based on full dataset for model
          mutate(julian_s=(julian-mean(RelTempDiff_MRZ$julian, na.rm=T))/sd(RelTempDiff_MRZ$julian, na.rm=T),
                 Hour_s=(Hour-mean(RelTempDiff_MRZ$Hour, na.rm=T))/sd(RelTempDiff_MRZ$Hour, na.rm=T),
                 Anomaly_s=(Anomaly-mean(RelTempDiff_MRZ$Anomaly, na.rm=T))/sd(RelTempDiff_MRZ$Anomaly, na.rm=T))

gamMRZ1_pred<-predict(gamMRZ1, newdata=newdataMRZ, type="terms", se.fit=TRUE, discrete=T)
```

Plot predictions
```{r}
library(viridis)
library(grid)
library(gridExtra)
library(metR)

predictions2 <- data.frame(gamMRZ1_pred$fit, gamMRZ1_pred$se.fit)
colnames(predictions2) <- c("fit", "se.fit")
range(gamMRZ1_pred$fit)
MRZPlot <- cbind(newdataMRZ, predictions2) %>%
  mutate(fit = round(fit,2),
         se.fit = round(se.fit,2))


# How does Anomaly compare with original Anomaly? Pretty close to linear.
ggplot(RelTempDiff_MRZ, aes(Anomaly, Anomaly2)) + geom_point() + geom_smooth(method = "lm")
# Are there only certain years that reached anomaly of -1.5? 
ggplot(RelTempDiff_MRZ, aes(x = fWY, y = Anomaly, color = fWY)) + geom_boxplot() 
ggplot(subset(RelTempDiff_MRZ, Anomaly > -3 & Anomaly < 3), aes(x = Anomaly, y = RelTempDiff, color = fWY), alpha = 0.3) + geom_jitter() + scale_color_viridis(discrete = TRUE)


# Is reltempdiff lower during lower anomalies? No. much lower during high anomalies.
vis1 <- ggplot(subset(RelTempDiff_MRZ, Anomaly > -3 & Anomaly < 3), aes(x = Anomaly, y = RelTempDiff, color = julian)) + geom_jitter() + scale_color_viridis()
vis2 <- ggplot(MRZPlot, aes(x = Anomaly, y = fit, color = julian)) + geom_jitter() + scale_color_viridis()
grid.arrange(vis1,vis2, nrow = 1)

breaks = seq(-3,1, by = 0.2)

# Plotting function
AnomalyPlot <- function(df = MRZPlot, Anomaly = 0) {
  Anomaly = enquo(Anomaly)
  
  dplyr::filter(df, Anomaly == UQ(Anomaly)) %>%
    ggplot(mapping = aes(x = julian, y = Hour, z = fit)) +
    geom_raster(mapping = aes(fill = fit)) + 
    scale_fill_viridis_c(breaks = seq(from = -2.5, to = 1.0, by = 0.5), na.value="white",limits = c(-2.5,1))+
    geom_contour(colour = "white") +
    geom_text_contour(stroke = 0.2, breaks = breaks, check_overlap = TRUE) +
    theme_classic() +
    theme(axis.text = element_text(size = 13),
          plot.title = element_text(hjust = 0.5),
          legend.position = "bottom")+
    #labs(title = Anomaly)+
    guides(fill=guide_colorbar(title="RelDiff", barwidth = 10))
}

# Make Plots
(pvcool2 <-AnomalyPlot(MRZPlot, -3))
(pcool2 <- AnomalyPlot(MRZPlot, Anomaly = -1.5) +theme(legend.position = "none"))
pavg2 <- AnomalyPlot(MRZPlot, Anomaly = 0) +theme(legend.position = "none")
pwarm2 <- AnomalyPlot(MRZPlot, Anomaly = +1.5)+theme(legend.position = "none")
pvwarm2 <- AnomalyPlot(MRZPlot, Anomaly = +3)



```

## Combined plot


Facet
```{r}
# faceted
breaks = seq(-3,1, by = 0.2)

RRIPlot1sub <- subset(RRIPlot1, Anomaly %in% c(-1.5, 0, 1.5)) %>%
  mutate(fAnomaly <- as.factor(Anomaly))
levels(RRIPlot1sub$fAnomaly) <- c("-1.5", "0", "+1.5")

RRIfacet <- ggplot(RRIPlot1sub, aes(x = julian, y = Hour, z = fit)) +
    facet_wrap(~fAnomaly) +
  geom_raster(mapping = aes(fill = fit)) + 
scale_fill_gradientn(colours = c("blue4", "blue", "slateblue1", "skyblue2", "skyblue1", "grey50", "sienna1", "sienna3"),
                      breaks = seq(from = -2.5, to = 1.0, by = 0.5), na.value="white",limits = c(-2.5,1))+
    geom_contour(colour = "white") +
    geom_text_contour(stroke = 0.2, breaks = breaks, check_overlap = TRUE) +
    theme_classic() +
    theme(axis.text = element_text(size = 13),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank(),
          strip.text = element_text(size = 13, colour = "white", face = "bold"),
          strip.background = element_rect(fill = "black"),
          legend.position = "none")+
  scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0,0))+
    #labs(title = Anomaly)+
    guides(fill=guide_colorbar(title="RelDiff", barwidth = 10))

MRZfacet <- ggplot(subset(MRZPlot, Anomaly %in% c(-1.5, 0, 1.5)), aes(x = julian, y = Hour, z = fit)) +
    facet_wrap(~Anomaly) +
  geom_raster(mapping = aes(fill = fit)) + 
  #scale_fill_viridis_c(breaks = seq(from = -2.5, to = 1.0, by = 0.5), na.value="white",limits = c(-2.5,1))+
  scale_fill_gradientn(colours = c("blue4", "blue", "slateblue1", "skyblue2", "skyblue1", "grey50", "sienna1", "sienna3"),
                       breaks = seq(from = -2.5, to = 1.0, by = 0.5),
                       na.value="white", 
                       limits = c(-2.5,1))+
    geom_contour(colour = "white") +
    geom_text_contour(stroke = 0.2, breaks = breaks, check_overlap = TRUE) +
    theme_classic() +
    theme(axis.text = element_text(size = 13),
          plot.title = element_text(hjust = 0.5),
          legend.position = "bottom",
          legend.text = element_text(size = 12),
          strip.text.x = element_blank(),
          strip.background = element_blank())+
    scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0,0))+
    #labs(title = Anomaly)+
    guides(fill=guide_colorbar(title="Surface-Bottom Temperature Difference", barwidth = 12))

```


Combined plot
700x500
```{r}

# save legend separately for final figure
get_legend<-function(myggplot){
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}


legendF <- get_legend(MRZfacet)



MRZfacet <- MRZfacet + theme(legend.position = "none") +labs(x = "Day of year")
MRZfacet2 <- annotate_figure(MRZfacet,
                left = text_grob("Martinez (MRZ)", color = "black", rot = 90))
RRIfacet2 <- annotate_figure(RRIfacet,
                left = text_grob("Rough and Ready Island (RRI)", color = "black", rot = 90))

DepthPlot <- grid.arrange(legendF, RRIfacet2, MRZfacet2, nrow = 3, 
            layout_matrix = rbind(1, 2, 3),
             widths = c(2), heights = c(0.5,2,2))

#DepthPlot
# ggsave("Figures/RelDiffPlot.pdf", width = 9, height = 6)
# png("Figures/RelDiffPlot2.png", width = 900, height =600)
# pdf("Figures/RelDiffPlot2.pdf", width = 9, height = 6)

```

unfaceted combination
```{r}
grid.arrange(pcool, pavg, pwarm,
             pcool2, pavg2, pwarm2, nrow = 2)

legend <- get_legend(pvcool)

# Remove titles that we don't need
(pcool <- pcool + theme(axis.title.x = element_blank()))
pavg <- pavg + theme(axis.title.x = element_blank(),
                     axis.title.y = element_blank())
pwarm <- pwarm + theme(axis.title.x = element_blank(),
                       axis.title.y = element_blank())

pcool2 <- pcool2 + labs(x = "Julian Day")
pavg2 <- pavg2 + theme(axis.title.y = element_blank()) +labs(x = "Julian Day")
pwarm2 <- pwarm2 + theme(axis.title.y = element_blank()) +labs(x = "Julian Day")

grid.arrange(legend, 
             pcool,pavg,pwarm,
             pcool2, pavg2, pwarm2, 
             nrow = 3,
             layout_matrix = rbind(c(1,1,1),c(2,3,4), c(5,6,7)),
             widths = c(2,1.8,1.8), heights = c(0.5,2,2))


```


# Calculate % of dataset with reltempdiff > 1 and < -1

```{r}
RRIused <- subset(RRIPlot1, Anomaly %in% c(-1.5, 0, 1.5)) 
context <- RRIused %>%
  mutate(diff = ifelse(fit <= -1, "negative", 
                       ifelse(fit > 0.5, "positive", "nodiff")))
nrow(filter(context, diff == "negative"))
nrow(filter(context, diff == "nodiff"))

ggplot(context, aes(x = julian, y = fit, fill = diff)) + geom_col()
ggplot(context, aes(x = Hour, y = fit, fill = diff)) + geom_col()

MRZused <- subset(MRZPlot, Anomaly %in% c(-1.5, 0, 1.5))
context2 <- MRZused %>%
  mutate(diff = ifelse(fit <= -1, "negative", 
                       ifelse(fit > 0.5, "positive", "nodiff")))
nrow(filter(context2, diff == "negative"))
6116/nrow(context2)
1249/nrow(context2)

nrow(filter(context, diff == "nodiff"))

ggplot(context2, aes(x = julian, y = fit, fill = diff)) + geom_col()
ggplot(context2, aes(x = Hour, y = fit, fill = diff)) + geom_col()

ggplot(context2, aes(x = julian, y = Hour, fill = diff)) + geom_col()

```


















# Original GAMs


GAMs - Model RRI and MRZ only 
```{r}


# https://noamross.github.io/gams-in-r-course/
  
# autoregressive
# gamm() - incorporating random effects and autocorrelation
  # look into nlme for description of autocorrelation function
  # arma, AR1
  # look up random effect notation in nlme
  # gamm model predictions - gratia
# RelTempDiff ~ interaction(julian, Hour) + re(fWY) + autocorrelation 

str(RelTempDiff_RRI)

# Use normal smooth and separate variables
gamRRI1 <- bam(RelTempDiff ~ s(julian, bs = "cc", k = 25) + s(Hour, bs = "cc", k = 15) + fWY, data = RelTempDiff_RRI, method = "REML")
par(mfrow = c(2,2))
gam.check(gamRRI1)

# Use tensor smooth for interactions of different scales
gamRRI2 <- bam(RelTempDiff ~ te(julian, Hour, k = c(15, 10), bs = c("cc")) + fWY, data = RelTempDiff_RRI, method = "REML")
par(mfrow = c(2,2))
gam.check(gamRRI2)
par(mfrow = c(1,1))
vis.gam(x = gamRRI2,
        view = c("julian", "Hour"),
        color = "heat", plot.type = "contour")

# Family = scat
gamRRI2b <- bam(RelTempDiff ~ te(julian, Hour, k = c(15,10), bs = "cc") + fWY, data = RelTempDiff_RRI, family = scat, method = "REML")
summary(gamRRI2b)
gam.check(gamRRI2b)
vis.gam(x = gamRRI2b,
        view = c("julian", "Hour"),
        color = "heat", plot.type = "contour")

# Include all 3
gamRRI3 <- bam(RelTempDiff ~ te(julian, Hour, fWY, d = c(2, 1), k = c(15,10), bs = c("cc", "tp")), data = RelTempDiff_RRI, family = scat, method = "REML")
gam.check(gamRRI3)


# Interaction with different levels
gamRRI4 <- bam(RelTempDiff ~ te(julian, Hour, by = fWY, k = c(12,12), bs = c("cc", "cc")) + fWY, data = RelTempDiff_RRI, AR.start=RelTempDiff_RRI$TempDiffLag, discrete = TRUE, family = scat, method = "REML")
par(mfrow = c(2,2))
gam.check(gamRRI4)
par(mfrow = c(1,1))
vis.gam(x = gamRRI4,
        view = c("julian", "Hour"),
        color = "heat", plot.type = "contour")
summary(gamRRI4)


# Random effect of year
gamRRI5 <- bam(RelTempDiff ~ te(julian, Hour, k = c(15,10), bs = "cc") + s(fWY, bs = "re"), data = RelTempDiff_RRI, family = scat, method = "REML")
summary(gamRRI5)
par(mfrow = c(2,2))
gam.check(gamRRI5)
par(mfrow = c(1,1))
vis.gam(x = gamRRI5,
        view = c("julian", "Hour"),
        color = "heat", plot.type = "contour")

# center and standardize TempDiffLag, easier for predictions
bam(Temperature_difference ~ te(Julian_day_s, Hour, by = fWaterYear) + fWaterYear, bs=c("cc","cc"))

# bam and gam random effects
+ s(fWaterYear,bs="re")
    # tp is default
    # cc = cyclic smooth
    # by = doesn't need a smooth
    # by = will make a smoother for each WY
    # factor smooth interaction: pooling effects by WY (see paper)

# Add WY 
# Check fit
# bam and gam have their own functions for model predictions
# gam.check() for model validation 

```

Do I need to standardize julian day or Hour?

```{r}
# Tell it what the starting event is
RelTempDiff_RRI = start_event(as.data.frame(RelTempDiff_RRI), column="Datetime", event=c("Station"), label.event="Event")

# Keep anomaly k value low in model
# Model without autocorrelation
gamRRI_0 <- bam(RelTempDiff~ te(julian, Hour, Anomaly,  k = c(12,6,6), bs = c("cc", "cc", "tp")), data = RelTempDiff_RRI, 
                family = scat, 
                method = "fREML", 
                nthreads = 3, 
                discrete = TRUE)
# Plot results for anomalies -1.5, 0, and 1.5



# Calculate rho
rAn = acf(resid(gamRRI_0),  plot=FALSE)$acf[2]

# Check model
par(mfrow = c(1,2))
acf(resid(gamRRI_0))
pacf(resid(gamRRI_0))
par(mfrow=c(2,2))
gam.check(gamRRI_0)


# Model using rho from above
gamRRI <- bam(RelTempDiff~ te(julian, Hour, Anomaly, k = c(12,6,16), bs = c("cc", "cc", "tp")), data = RelTempDiff_RRI, 
            family = scat, 
            method = "fREML", 
            rho = rAn, 
            AR.start = RelTempDiff_RRI$start.event, 
            nthreads = 3, 
            discrete = TRUE)

# Check model
par(mfrow = c(1,2))
acf(resid(gamRRI))
pacf(resid(gamRRI))
par(mfrow = c(2,2))
gam.check(gamRRI)
summary(gamRRI)
par(mfrow = c(1,1))
plot(gamRRI, all.terms = TRUE, pages = 1)
vis.gam(x = gamRRI,
        view = c("julian", "Hour"),
        color = "heat", plot.type = "contour", type = "response")

save(gamRRI_0, gamRRI, file = "gamRRIAnomaly.RData")
load("gamRRIAnomaly.RData")
```

julian by TOD
```{r}
gamRRI <- bam(RelTempDiff~ te(julian, Hour, Anomaly, k = c(12,6,16), bs = c("cc", "cc", "tp")), data = RelTempDiff_RRI, 
            family = scat, 
            method = "fREML", 
            rho = rAn, 
            AR.start = RelTempDiff_RRI$start.event, 
            nthreads = 3, 
            discrete = TRUE)
```

julian by Anomaly 
```{r}
mRRI1 <- bam(RelTempDiff~ te(julian, Anomaly, by = TOD, k = c(12,6), bs = c("cc""tp")) + s(TOD), data = RelTempDiff_RRI, 
            family = scat, 
            method = "fREML", 
            rho = rAn, 
            AR.start = RelTempDiff_RRI$start.event, 
            nthreads = 3, 
            discrete = TRUE)
```











Differencing the data - this doesn't work
```{r}
df <- RelTempDiff_RRI %>%
  arrange(Datetime) %>%
  mutate(diff1 = c(NA,diff(RelTempDiff)))

gamRRI_diff0 <- bam(RelTempDiff~ te(julian, Hour, Anomaly,  k = c(12,6,16), bs = c("cc", "cc", "tp")), data = df, 
                family = scat, 
                method = "fREML", 
                nthreads = 3, 
                discrete = TRUE,
                na.action = na.omit)

# Calculate rho
par(mfrow = c(1,2))
acf(resid(gamRRI_diff0))
pacf(resid(gamRRI_diff0))
rAn = acf(resid(gamRRI_diff0),  plot=FALSE)$acf[2]
par(mfrow=c(2,2))
gam.check(gamRRI_diff0)
```


corARMA
```{r}
library(nlme)
gammRRI <- gamm(RelTempDiff~ te(julian, Hour, Anomaly, k = c(12,6,16), bs = c("cc", "cc", "tp")), data = RelTempDiff_RRI, 
            family = scat, 
            method = "fREML", 
            correlation = corARMA())
```



Look at the anomaly values. 2015 should have higher ones, 2017 should have lower ones.
```{r}
ggplot(RRI_pred, aes(x = factor(Month), y = Anomaly)) + geom_boxplot() + facet_wrap(~fWY)

ggplot(RRI_pred, aes(x = factor(fWY), y = Anomaly)) + geom_boxplot() 

ggplot(RRI_pred, aes(x = Datetime, y = Anomaly)) + geom_point()

RelTempDiff_RRI <- left_join(RelTempDiff_RRI, RRI_pred)
```




Alternate models
```{r}
library(itsadug)

##adjusting model
# RelTempDiff_RRI = filter(RelTempDiff_RRI, !is.na(TempDiffLag), !is.na(RelTempDiff), !is.na(TempDiffLag2))
  
# Determine rho by first running the model without the AR term
gRRI1a <- bam(RelTempDiff~ te(julian, Hour, k = c(6, 12), bs = c("cc", "cc")), data = RelTempDiff_RRI, 
            family = scat, method = "fREML", nthreads = 3, discrete = TRUE)

r1 = acf(resid(gRRI1a),  plot=FALSE)$acf[2]
acf(resid(gRRI1a))
pacf(resid(gRRI1a))

par(mfrow = c(2,2))
gam.check(gRRI1a)

gRRI1 <- bam(RelTempDiff~ te(julian, Hour, k = c(20, 10), bs = c("cc", "cc")), data = RelTempDiff_RRI, 
            family = scat, method = "fREML", rho = r1, AR.start = RelTempDiff_RRI$start.event, nthreads = 3, discrete = TRUE)

par(mfrow = c(2,2))
gam.check(gRRI1)
acf(resid(gRRI1)) # This looks the same

par(mfrow = c(1,1))
plot(gRRI1, all.terms = TRUE, pages = 1)
summary(gRRI1)
vis.gam(x = gRRI1,
        view = c("julian", "Hour"),
        color = "heat", plot.type = "contour")

# Add year in as a linear term
gRRI2a <- bam(RelTempDiff~ te(julian, Hour, k = c(20, 20), bs = c("cc", "cc")) + fWY, data = RelTempDiff_RRI, 
            family = scat, method = "fREML", nthreads = 3, discrete = TRUE)
r2 = acf(resid(gRRI2a),  plot=FALSE)$acf[2]
par(mfrow = c(2,2))
gam.check(gRRI2a)

gRRI2 <- bam(RelTempDiff~ te(julian, Hour, k = c(20, 10), bs = c("cc", "cc")) + fWY, data = RelTempDiff_RRI, 
            family = scat, method = "fREML", rho = r2, AR.start = RelTempDiff_RRI$start.event, nthreads = 3, discrete = TRUE)
par(mfrow = c(2,2))
gam.check(gRRI2)
par(mfrow = c(1,1))
plot(gRRI2, all.terms = TRUE, pages = 1)
summary(gRRI2)
vis.gam(x = gRRI2,
        view = c("julian", "Hour"),
        color = "heat", plot.type = "contour")


# Add year in as an interaction
gRRI3a <- bam(RelTempDiff ~ te(julian, Hour, by = fWY, k = c(20,12), bs = c("cc", "cc")) + fWY, data = RelTempDiff_RRI,
             family = scat, method = "fREML", nthreads = 3, discrete = TRUE)
r3 = acf(resid(gRRI3a),  plot=FALSE)$acf[2]


par(mfrow = c(2,2))
gam.check(gRRI3a)


gRRI3 <- bam(RelTempDiff ~ te(julian, Hour, by = fWY, k = c(20,12), bs = c("cc", "cc")) + fWY, data = RelTempDiff_RRI,
             family = scat, method = "fREML", rho = r3, AR.start = RelTempDiff_RRI$start.event, nthreads = 3, discrete = TRUE)
par(mfrow = c(2,2))
gam.check(gRRI3)
par(mfrow = c(2,2))
acf(resid(gRRI3a))
pacf(resid(gRRI3a))

summary(gRRI3)
par(mfrow = c(1,1))
plot(gRRI3, all.terms = TRUE, pages = 1)
par(mfrow = c(2,2))
acf(resid(gRRI3))
pacf(resid(gRRI3))

summary(gRRI3)
par(mfrow = c(1,1))
vis.gam(x = gRRI3,
        view = c("julian", "Hour"),
        color = "heat", plot.type = "contour") # Can I make plots by year?

# Add year in as a random effect

gRRI4a <- bam(RelTempDiff~ te(julian, Hour, k = c(20, 10), bs = c("cc", "cc")) + s(fWY, bs = "re"), data = RelTempDiff_RRI, 
            family = scat, method = "fREML", nthreads = 3, discrete = TRUE)
r4 = acf(resid(gRRI4a),  plot=FALSE)$acf[2]
par(mfrow = c(2,2))
gam.check(gRRI4a)


gRRI4 <- bam(RelTempDiff~ te(julian, Hour, k = c(20, 10), bs = c("cc", "cc")) + fWY, data = RelTempDiff_RRI, 
            family = scat, method = "fREML", rho = r4, AR.start = RelTempDiff_RRI$start.event, nthreads = 3, discrete = TRUE)
par(mfrow = c(2,2))
gam.check(gRRI4)
plot(gRRI4, all.terms = TRUE, pages = 1)
summary(gRRI4)
vis.gam(x = gRRI4,
        view = c("julian", "Hour"),
        color = "heat", plot.type = "contour")

acf(resid(gRRI4))


save(gRRI3a, gRRI3, file = "gamRRIWY.RData")
```



Plot models
#https://mfasiolo.github.io/mgcViz/articles/mgcviz.html













Playing with time series
```{r}
library(timetk)
library(feasts)
library(forecast)
dataset <- as_tsibble(RelTempDiff_RRI, index = Datetime) %>%
  filter(Year >15)
dataset %>% autoplot(RelTempDiff)
dataImpute <- ts_impute_vec(dataset$RelTempDiff)
dataset %>% timetk::plot_seasonal_diagnostics(.date_var = Datetime, .value = RelTempDiff)
dataset %>% plot_stl_diagnostics(.date_var = Datetime, .value = RelTempDiff)
tsdata <- ts(dataset$RelTempDiff, frequency = 8760, start = c(2015, 1) )
autoarima1 <- auto.arima(tsdata)
```

