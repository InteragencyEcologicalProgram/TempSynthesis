---
title: "Diel Trends"
author: "Catarina Pien"
date: "10/23/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
library(viridis) # color palette
library(plotly) # interactive plots
library(pscl) # glm
library(visreg) # visualize model results
library(lattice)
library(lme4) # glmm
library(lmerTest) #glmm p values
```

Read in 
```{r}
setwd("C:/Users/cpien/OneDrive - California Department of Water Resources/Work/ClimateChange/R_code/TempSynthesis/")

#tempFilt <- readRDS("Data/tempFilt.rds") 
tempToUse <- readRDS("Data/temp10years_20200922.rds")
#tempAn <- readRDS("Data/tempAnnual.rds")
tempMon <- readRDS("Data/tempMonthly.rds")
tempDaily <- readRDS("Data/tempDaily.rds")
#tempHeat <- readRDS("Data/heatstressDaily.rds")
```

Code to make sure every month has data
```{r nMon}
# Filter to only data that has temps from every month so as not to skew the data that only has part of the year represented.
nMon <- tempMon %>% group_by(Station, WY) %>%
  summarize(nMon = n())

nMon$WY <- as.numeric(nMon$WY)
```

## Daily Range
```{r Models Daily Max}
tempDaily <- filter(tempDaily, WY > 2008 & WY < 2020)
tempDaily$yday = yday(tempDaily$Date)
tempDaily$Year = year(tempDaily$Date)
tempDaily$fYear = factor(tempDaily$Year)
tempDaily$fWY = factor(tempDaily$WY)
tempDaily$Month = month(tempDaily$Date)
tempDaily$fMonth = ordered(tempDaily$Month)
tempDailyM <- left_join(tempDaily, nMon) %>%
  filter(nMon == 12)

tempDaily$WYType2_Sac = as.factor(tempDaily$WYType2_Sac)
tempToUse$Hour <- hour(tempToUse$Datetime)

#try a sine-transformation on "month" so we can include it in linear models
tempDailyM$syday = sin(pi*tempDailyM$yday/365)

# Add season
tempToUse <- tempToUse %>%
  mutate(Season = ifelse(Month %in% c(12, 1, 2), "Winter", 
                         ifelse(Month %in% c(3,4,5), "Spring", 
                                ifelse(Month %in% c(6,7,8), "Summer",
                                       "Fall"))))
tempToUse$Season <- factor(tempToUse$Season, levels = c("Spring", "Summer", "Fall", "Winter"))


# Add season
tempDailyM <- tempDailyM %>%
  mutate(Season = ifelse(Month %in% c(12, 1, 2), "Winter", 
                         ifelse(Month %in% c(3,4,5), "Spring", 
                                ifelse(Month %in% c(6,7,8), "Summer",
                                       "Fall"))))
tempDailyM$Season <- factor(tempDailyM$Season, levels = c("Spring", "Summer", "Fall", "Winter"))
```

**Scientific Questions**  

1. What is the approximate daily range? 
2. How does range change on annual scale? 
3. Does the range differ by region (taking into account month)?
4. Does the range differ at particular stations in a region? 


### Trends

```{r}
summaryRange <- tempDailyM %>%
  group_by(Region, Season, fMonth) %>%
  summarize(mean.Range = mean(rangeTemp),
            median.Range = median(rangeTemp),
            n = n(),
            sd = sd(rangeTemp),
            se = sd(rangeTemp)/sqrt(n))
```

```{r}


ggplot(data = summaryRange, aes(x = Region, y = mean.Range, fill = fMonth)) + 
  geom_bar(stat = "identity", position= position_dodge()) +
  geom_errorbar(aes(ymin = mean.Range-se, ymax = mean.Range+se), width = 0.2, position = position_dodge(0.9))+ 
  scale_fill_viridis(discrete = TRUE) + theme_bw()

ggplot(summaryRange) + geom_col(aes(Region, mean.Range, fill = Season), size = 3, position= position_dodge()) + scale_fill_viridis(discrete = TRUE) + theme_bw()
# Boxplot
ggplot(data = )


# Line Plot
ggplot(data = summaryRange, aes(x = fMonth, y = mean.Range, group = Region, color = Region)) + 
  geom_point(size = 3) +
  geom_line()+
  geom_errorbar(aes(ymin = mean.Range-se, ymax = mean.Range+se), width = 0.5, position = position_dodge(0.05))+ 
  scale_color_viridis(discrete = TRUE) + theme_bw()
```

```{r }
# Overall temperature trends by Month and Region 
temp_s <- tempToUse %>% group_by(Region) %>% sample_frac(.1)
ggplot(temp_s, aes(x = factor(Hour), y = Temp)) + geom_boxplot() + facet_grid(Region~Season)+theme_bw()
```

Monthly Median of Daily Range
```{r}
tempDailyM_2 <- tempDailyM %>%
  group_by(Region, Station, Season, WYType2_Sac ,fWY, WY, fMonth) %>%
  summarize(medianRange = median(rangeTemp),
            meanRange = mean(rangeTemp)) %>%
  ungroup()
```

By Water Year
```{r}
ggplot(tempDailyM_2, aes(x = fMonth, y = medianRange, fill = WYType2_Sac)) +   geom_boxplot() +
   scale_fill_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))

ggplot(tempDailyM_2, aes(x = fMonth, y = medianRange, color = WYType2_Sac)) +   geom_jitter() +
   scale_color_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
```

By Region
```{r}
ggplot(tempDailyM_2, aes(x = Region, y = medianRange, fill = WYType2_Sac)) +   geom_boxplot() +
   scale_fill_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))

ggplot(tempDailyM_2, aes(x = Region, y = medianRange, color = WYType2_Sac)) +   geom_jitter() +
   scale_color_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
```


By Season

```{r}
ggplot(tempDailyM_2, aes(x = Region, y = medianRange, fill = Season)) +   geom_boxplot() +
   scale_fill_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))

ggplot(tempDailyM_2, aes(x = Season, y = medianRange, fill = Region)) +   geom_boxplot() +
   scale_fill_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))

ggplot(tempDailyM_2, aes(x = fMonth, y = medianRange, fill = Region)) +   geom_boxplot() +
   scale_fill_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
```

**Median Range: Approximately 0.25 - 1.5C**  
**Larger range values and variability in the South**

Curious about those with large median ranges
```{r}
highRange <- filter(tempDailyM_2, medianRange > 3)
ggplot(highRange, aes(x = fWY, y = medianRange, color = Station, shape = Region)) + geom_jitter(size = 4)+scale_color_viridis(option = "viridis", discrete = TRUE) +
  facet_wrap(~Season) +
  theme_bw() + 
  theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14),
        strip.text = element_text(size = 14))
```
    
    Large ranges in particular in the South, mostly in Spring and especially summer. Stations VER, SJR, RPN have very high ranges. 
    

## 2. How does range change on annual scale?

* Doesn't really appear to change over time, or at least not in a consistent way
```{r}
tempDailyM_s <- tempDailyM %>% group_by(Region) %>% sample_frac(.2)

ggplot(tempDailyM_s, aes(x = Date, y = rangeTemp)) + geom_jitter() + geom_smooth(se = TRUE)

ggplot(tempDailyM_s, aes(x = Date, y = rangeTemp, color = WYType2_Sac)) + geom_jitter()

```

## 3. Does the range differ by region?

* Greater in Suisun Marsh spring, South
* High variability in Suisun Marsh
* Range generally greater in the late spring, summer
* Range generally slightly smaller in wet years
```{r}
ggplot(tempDailyM_s, aes(x = Date, y = rangeTemp, color = Region)) + geom_smooth()

ggplot(tempDailyM_2, aes(x = fWY, y = meanRange, fill = Region)) + geom_boxplot()

ggplot(tempDailyM_2, aes(x = fMonth, y = medianRange, fill = WYType2_Sac)) + facet_wrap(~Region, scales = "free_y") +  geom_boxplot() +
   scale_fill_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
```

## 4. Does the range differ at particular stations in a region?

**Suisun**
High range and range variability in BLL and SNC
```{r}
tempSuisun <- tempDailyM %>% filter(Region == "Suisun Marsh")

ggplot(tempSuisun, aes(x= fMonth, y = rangeTemp, fill = Station)) + geom_boxplot() +
  labs(title = "Suisun Marsh") + 
   scale_fill_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
```

**South**

High range and range variability in UNI and Vernalis 
```{r}
tempSouth <- tempDailyM %>% filter(Region == "South")

ggplot(tempSouth, aes(x= fMonth, y = rangeTemp, fill = Station)) + geom_boxplot() +
  labs(title = "South") +
   scale_fill_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
```

**San Joaquin**

* Not much variation
```{r}
tempSJ <- tempDailyM %>% filter(Region == "San Joaquin")

ggplot(tempSJ, aes(x= fMonth, y = rangeTemp, fill = Station)) + geom_boxplot() +
   scale_fill_viridis(option = "viridis", discrete = TRUE) + 
  labs(title = "San Joaquin") +
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
```


## Modeling

* Main variables: WY, Region, yday, lag
* Random variables: Station, possibly WY
* Possible: WY Type

Interactions

* Region*yday: possible
```{r}
tempDaily_s <-sample_n(tempDailyM, 50000)
ggplot(tempDaily_s, aes(x = fWY, y = rangeTemp, color = Region)) + geom_point() +
  scale_color_viridis(discrete =TRUE)
  
ggplot(tempDaily_s, aes(x = fWY, y = rangeTemp, color = yday)) + geom_jitter() + scale_color_viridis()

# WYType:yday
# no trend
ggplot(tempDaily_s) + 
  geom_point(aes(x = yday, y = rangeTemp, color = WYType2_Sac), alpha = 0.5) + 
  stat_smooth(aes(x = yday, y = rangeTemp, color = WYType2_Sac),method = "lm", formula = y ~ x + I(x^2), size = 2, se = TRUE)+ 
  scale_color_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:yday
# Difference by Region (more differences in summer)
ggplot(tempDaily_s) + 
  geom_point(aes(x = yday, y = rangeTemp, color = Region), alpha = 0.2) + 
  stat_smooth(aes(x = yday, y = rangeTemp, color = Region),method = "lm", formula = y ~ x + I(x^2), size = 2, se = TRUE)+ 
  scale_color_viridis(option = "magma", discrete = TRUE) + theme_bw()

# Region:WY Type -not much difference
ggplot(tempDaily_s) + 
  geom_boxplot(aes(x = Region, y = rangeTemp, fill = WYType2_Sac)) + 
  scale_fill_viridis(option = "viridis", discrete = TRUE)

```

Models
Model temp autocorrelation

```{r}
library(lme4)
library(lmerTest)

# Account for Temporal Autocorrelation 
tempDailyM <- tempDailyM %>% 
    group_by(Region, Station) %>%
  mutate(rangeDailylag1 = lag(rangeTemp, 1),
         rangeDailylag2 = lag(rangeTemp, 2))%>%
  ungroup() %>%
  mutate(rangeDailylag1_s = scale(rangeDailylag1),
         rangeDailylag2_s = scale(rangeDailylag2),
         yday_s = scale(yday))

# Remove NAs from lag 
tempDaily2 <-na.omit(tempDailyM)

# Model no lag, lag(1)
summary(M.range1 <- lmer(rangeTemp~yday + I(yday_s^2) + Region + fWY + (1|Station), data = tempDaily2, na.action = na.omit))

M.range2 <- lmer(rangeTemp~ yday + I(yday_s^2) + Region + fWY + rangeDailylag1_s + (1|Station), data = tempDaily2, na.action = na.omit)

M.range3 <- lmer(rangeTemp~ yday_s + I(yday_s^2) + Region + fWY + rangeDailylag1_s + rangeDailylag2_s + (1|Station), data = tempDaily2, na.action = na.omit)

# Check temporal autocorrelation
# How correlated day 1 is to day 2, 3, etc. 
acf(residuals(M.range1))
acf(residuals(M.range2))
acf(residuals(M.range3))


```

**Chosen but not best model: M.range2 <- lmer(rangeTemp~yday + I(yday_s^2) + Region + fWY + rangeDailylag1_s + (1|Station)**
Year as random variable is slightly better but we care about year for now

Other models:
```{r}
# no WY Type
summary(M.range4 <- lmer(rangeTemp~Season + Region + fWY + rangeDailylag1_s + (1|Station), data = tempDaily2, na.action = na.omit))

summary(M.range5 <- lmer(rangeTemp~syday + Region + fWY + rangeDailylag1_s + (1|Station), data = tempDaily2, na.action = na.omit))

AIC(M.range3, M.range4, M.range5)
```

Best model still Model 3. 

# Add Interactions into model 3.
```{r}
summary(M.range6 <- lmer(rangeTemp~ yday_s + I(yday_s^2) + Region + fWY + rangeDailylag1_s + rangeDailylag2_s + yday_s:Region + (1|Station), data = tempDailyM, na.action = na.omit))

summary(M.range7 <- lmer(rangeTemp~ yday_s + I(yday_s^2) + Region + fWY + rangeDailylag1_s + rangeDailylag2_s + fWY:Region + (1|Station), data = tempDailyM, na.action = na.omit))

summary(M.range8 <- lmer(rangeTemp~ yday_s + I(yday_s^2) + Region + fWY + rangeDailylag1_s + rangeDailylag2_s + fWY:yday_s + (1|Station), data = tempDailyM, na.action = na.omit))

AIC(M.range3, M.range6, M.range7, M.range8)
```

fWY:Region interaction helps

Diagnostic Plots

```{r}
# Diagnostic Plots
# https://www.ssc.wisc.edu/sscc/pubs/MM/MM_DiagInfer.html
# What is the right diagnostic plot for lmer?
par(mfrow = c(2,3))

res.range = resid(M.range7, type = "pearson")
lev1a = hatvalues(M.range7)
plot(M.range7)
qqnorm(res.range)
qqline(res.range)
plot(lev1a, y = res.range)

plot(res.range)
plot(tempDaily2$yday^2, res.range)
plot(tempDaily2$Region, res.range)
plot(tempDaily2$fWY, res.range)
```








## What are the hourly patterns? 
# Hourly information
* Max temp ~ 16:00
* Min temp ~ 7:00
* Diel: 14-18 vs 5-9


```{r}
tempToUse$Hour <- hour(tempToUse$Datetime)
tempToUse$Month <- month(tempToUse$Datetime)
tempInfo <- left_join(tempToUse, tempDaily) 
tempMax <- tempInfo %>%
  filter(Temp == maxDaily)
tempMin <- tempInfo %>%
  filter(Temp == minDaily)

# When do min and max temps occur for each Region?
tempMaxInfo <- tempMax %>%
  group_by(Region, Month) %>%
  summarize(HourMax = median(Hour))
tempMinInfo <- tempMin %>%
  group_by(Region, Month) %>%
  summarize(HourMin = median(Hour))

# Plots
tempMax_s <- tempMax %>% group_by(Region) %>% sample_frac(.5)
ggplot(tempMax_s, aes(x = factor(Month), y = Hour)) + geom_boxplot() + facet_wrap(~Region)

tempMin_s <- tempMin %>% group_by(Region) %>% sample_frac(.5)
ggplot(tempMin_s, aes(x = factor(Month), y = Hour)) + geom_boxplot() + facet_wrap(~Region)


# 
# Summer_hour <- temp_s %>% filter(Month %in% c(5,6,7,8,9)) 
# Winter_hour <- temp_s %>% filter(Month %in% c(10,11,12,1,2,3,4))

```

* Filter for just those hours. 
* Add variable TOD = Early vs Late
* Run model with TOD as variable 




# Calculate 10 year average of max temp by by season and station
# Calculate 10 year average of min monthly by season and station
# Number of hours >= max
# Number of hours <= min


nHours 