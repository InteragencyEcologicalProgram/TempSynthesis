---
title: "TempModelsMonthly"
author: "Catarina Pien"
date: "10/14/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---


# Monthly Temperature Trend Models {.tabset}
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
library(viridis) # color palette
library(plotly) # interactive plots
library(pscl) # glm
library(visreg) # visualize model results
library(lattice)
library(lme4) # glmm
library(lmerTest) #glmm p values
library(plotly)
library(ggeffects)
```

Read in data
```{r read}
setwd("C:/Users/cpien/OneDrive - California Department of Water Resources/Work/ClimateChange/R_code/TempSynthesis/")

# tempFilt <- readRDS("Data/tempFilt.rds") 
# tempToUse <- readRDS("Data/temp10years_20200922.rds")
# tempAn <- readRDS("Data/tempAnnual.rds")
tempMon <- readRDS("Data/tempMonthly.rds")
# tempDaily <- readRDS("Data/tempDaily.rds")
# tempHeat <- readRDS("Data/heatstressDaily.rds")
```

Code to make sure every month has data - merged with monthly data, below.
```{r nMon, message = FALSE, warning = FALSE}
# Filter to only data that has temps from every month so as not to skew the data that only has part of the year represented.
nMon <- tempMon %>% group_by(Station, WY) %>%
  summarize(nMon = n())

nMon$WY <- as.numeric(nMon$WY)
```

Add Season; Filter and alter variables
```{r filterVars}
tempMon <- tempMon %>%
  mutate(Season = ifelse(Month %in% c(12, 1, 2), "Winter", 
                         ifelse(Month %in% c(3,4,5), "Spring", 
                                ifelse(Month %in% c(6,7,8), "Summer",
                                       "Fall"))))
tempMon$Season <- factor(tempMon$Season, levels = c("Spring", "Summer", "Fall", "Winter"))
tempMon$WY <- as.numeric(tempMon$WY)
tempMon$fWY <- factor(tempMon$WY)
tempMon$fMonth <- factor(tempMon$Month, levels = c("11", "12", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10"))
tempMon$fYear <- factor(tempMon$Year)
tempMon <- filter(tempMon, WY > 2008 & WY < 2020)
tempMonM <- left_join(tempMon, nMon) %>%
  filter(nMon == 12)


#try a sine-transformation on "month" so we can include it in linear models
tempMonM$sMonth = sin(pi*tempMonM$Month/12)

#Note:I'm not 100% sure that's the best way to do it. Plus having the sign term makes it
#a little hard to interpret the results. But it does allow you to use a linear model instead of a 
#quadratic, if you like that better. Personally, I"d rather stick with the quadratic.

```

## Monthly Max Temps  
**Scientific Questions:**

1. Has maximum temperature increased over time?
2. Are there regional trends in maximum temperature increase? 
3. Do we see differences in max temp by water year type? (e.g. cooler summer temps in wet years)

**Questions for Rosie:**    

- It feels like what I am primarily interested in is: 
  (max,min,mean,range)Temp ~ WY(or year) + Region (+ WYType), with a recognition of the importance of yday, month or season
  - However, I cannot have WY and WYType in the same model, right?
  - Instead, include WYType + Year (instead of WY)?
  - When I leave WY as numeric, it comes out significant, but is this accurate? Or is it better to have it as a factor, and say "the last 5 years are higher based on slope?"

- Random variables
  - We talked about putting year as random variable. Does our question then become is there a difference in mean temp by region, wytype, time of year? Or what does the question really become? Confused what we are asking when we are using only categorical variables, and if this is useful. 
  - Can I include region in my model but also have Station as a random variable (aka nested random variable within fixed variable)? 
  - We don't really care about month, season specifically, unless there is an interaction of some sort (e.g. we can detect trends for certain months), so should this be a random variable?
  - How to incorporate random variables correctly (e.g. nested? crossed? syntax?)
  - Random variable interactions. Random effects, random intercept, random intercept plus slope models
  - Correlation structure
  - method = REML or ML

- Does it make sense to order the factors somehow for intercept and model interpretation? (aka lowest or highest variable first)

- How to interpret output
  - Reminder of interpreting parameters vs interactions
  - Are we looking at how rate of change of temp differs by season (or is this only if we have an interaction between year:season), or just how temp differs by season? E.g. a low winter coefficient just indicates that there are lower temps in the winter, not that the change in temp is lower for winter?
  - How do I plot this in a way to see the model differences by category?
  - How do I plot categorical variables in a useful way?
  - How to compare mixed models (Still AIC?) Look at Zuur
    - Start with as many variables as relevant. 1. Figure out random structure, 2. Figure out fixed structure, 3. Compare models with the same random but different fixed structures
    - AIC(), anova()
    - Try random intercept, random intercept slope
  - What do I say about the random effects? 

- Checking models for assumptions
  - Normalized residuals based on REML fit
    - Residuals vs fitted values (homogeneity)
    - Plot residuals against each explanatory variable
- Seasonal/daily decomposition to look at trends?

**Other thoughts**    

- Change regions based on dendrogram? 
- Change regions based on how they group together in results?

```{r monthlyMaxPlot}
# Monthly Trends
max1 <- ggplot(tempMonM) + 
  geom_jitter(aes(x = WY, y = maxAvTemp, color = fMonth), size = .7)+
  stat_smooth(aes(x = WY, y = maxAvTemp, color = fMonth),method = "lm", formula = y ~ x, size = 1, se = TRUE)+ 
  labs(title = "Average maximum temperature by month") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
ggplotly(max1)

# Regional Trends
max2 <- ggplot(tempMonM) + 
  geom_jitter(aes(x = WY, y = maxAvTemp, color = Region), size = .7)+
  stat_smooth(aes(x = WY, y = maxAvTemp, color = Region),method = "lm", formula = y ~ x, size = 1, se = FALSE)+ 
  labs(title = "Average maximum temperature by Region") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
ggplotly(max2)

```

### Look at interaction potential
* Month * WYType: yes
* Month * Region: yes
* Region * WYType: no
* Season * WYType: no
* Season * Region: no
```{r InteractionsPlotsMax}
# WYType:Month
# WY type trend differs by Month

ggplot(tempMonM) + 
  geom_point(aes(x = Month, y = maxAvTemp, color = WYType2_Sac)) + 
  stat_smooth(aes(x = Month, y = maxAvTemp, color = WYType2_Sac),method = "lm", formula = y ~ x + I(x^2), size = 2, se = TRUE)+ 
  labs(title = "WYType:Month") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + theme_bw()

#see what it looks like with the sin-transformed month
ggplot(tempMonM) + 
  geom_point(aes(x = sMonth, y = maxAvTemp, color = WYType2_Sac)) + 
  stat_smooth(aes(x = sMonth, y = maxAvTemp, color = WYType2_Sac),method = "lm", size = 2, se = TRUE)+ 
  labs(title = "WYType:Month with sin-transformation") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:Month
# Regional trend seems to differ by Month
ggplot(tempMonM) + 
  geom_point(aes(x = Month, y = maxAvTemp, color = Region)) + 
  stat_smooth(aes(x = Month, y = maxAvTemp, color = Region),method = "lm", formula = y ~ x + I(x^2), size = 2, se = TRUE)+ 
    labs(title = "Region:Month") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:WYType
ggplot(tempMonM) + 
  geom_boxplot(aes(x = Region, y = maxAvTemp, fill = WYType2_Sac)) + 
    labs(title = "Region:WYType") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# WYType:Season
# Not much difference... Spring lower maxAvTemp in the wet season, maybe slightly lower min in mid and wet years, other seasons look pretty similar. 
ggplot(tempMonM) + 
  geom_boxplot(aes(x = WYType2_Sac, y = maxAvTemp, fill= Season)) +
    labs(title = "WYType:Season") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:Season
# Not anything too significant
ggplot(tempMonM) + 
  geom_boxplot(aes(x = Region, y = maxAvTemp, fill = Season)) + 
    labs(title = "Region:Season") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()
```

Models 

* Interested in individual years so removed WY Type and focusing on factor(WY)

```{r Models Max Monthly Temp}

summary(M.max1 <- glm(maxAvTemp~Region + Month + I(Month^2) + fWY, data = tempMonM))
summary(M.max2 <- glm(maxAvTemp~Region + sMonth + fWY, data = tempMonM))
summary(M.max3 <- glm(maxAvTemp~Region + Season + fWY , data = tempMonM))
AIC(M.max1, M.max2, M.max3)

```

Proceed with quadratic Month as AIC lowest

```{r}
# Interactions?

summary(M.max5 <- glm(maxAvTemp~Region + Month + I(Month^2) + fWY + fWY:Region, data = tempMonM))

summary(M.max6 <- glm(maxAvTemp~Region + Month + I(Month^2) + fWY + fWY:Region + fWY:(Month + I(Month^2)), data = tempMonM))

summary(M.max7 <- glm(maxAvTemp~Region + Month + I(Month^2) + fWY + Region:(Month + I(Month^2)), data = tempMonM))

# Season
summary(M.max8 <- glm(maxAvTemp~Region + Season + fWY + fWY:Region + fWY:Season, data = tempMonM))

# Month
summary(M.max4 <- glm(maxAvTemp~Region + Month + I(Month^2) + fWY + fWY:(Month + I(Month^2)), data = tempMonM))

AIC(M.max1, M.max4, M.max5, M.max6, M.max7, M.max8)
```

Chosen Model: **(M.max4 <- glm(maxAvTemp~Region + Month + I(Month^2) + fWY + fWY:(Month + I(Month^2)), data = tempMonM))**

```{r}
par(mfrow = c(2,2))
plot(M.max4)

res.mmax1 = resid(M.max4, type = "pearson")
plot(res.mmax1)
plot(tempMonM$Month, res.mmax1)
plot(tempMonM$Region, res.mmax1)
plot(tempMonM$fWY, res.mmax1)

visreg(M.max4, "fWY", by = "Region")
visreg(M.max4, "Month", by = "Region")
visreg(M.max4, "Region", by = "Month")
visreg(M.max4, "fWY", by = "Month")
```

### Mixed Model - Station as random factor

```{r glmmmax}
summary(M.max1a <- lmer(maxAvTemp~Region + Month + I(Month^2) + fWY + fWY:(Month + I(Month^2)) + (1|Station), data = tempMonM, na.action = na.omit))

summary(M.max2a <- lmer(maxAvTemp~Region + Season + fWY + fWY:Season+ (1|Station), data = tempMonM, na.action = na.omit))

AIC(M.max1a, M.max2a)
```

Best Model: **M.max1a <- lmer(maxAvTemp~Region + Month + I(Month^2) + fWY + fWY:(Month + I(Month^2)) + (1|Station), data = tempMonM, na.action = na.omit))**

```{r}
# Using month
par(mfrow = c(2,3))

res.mmax2 = resid(M.max1a, type = "pearson")
lev1a = hatvalues(M.max1a)
plot(M.max1a)
qqnorm(resid(M.max1a))
qqline(resid(M.max1a))
plot(lev1a, y = res.mmax2)

plot(res.mmax2)
plot(tempMonM$Month, res.mmax2)
plot(tempMonM$Region, res.mmax2)
plot(tempMonM$fWY, res.mmax2)


# Using season
par(mfrow = c(2,3))

res.mmax3 = resid(M.max2a, type = "pearson")
lev2a = hatvalues(M.max2a)
plot(M.max2a)
qqnorm(resid(M.max2a))
qqline(resid(M.max2a))
plot(lev2a, y = res.mmax3)

plot(res.mmax3)
plot(tempMonM$Season, res.mmax3)
plot(tempMonM$Region, res.mmax3)
plot(tempMonM$fWY, res.mmax3)
```

### Conclusions

* Month: Summer>Fall>Spring>Winter
* Region: San Joaquin, South higher max temps
* Year: 





## Monthly Min Temps

**Scientific Questions: **    

1. Has minimum temperature increased over time? 
2. Do we see an annual trend in minimum temperature by month? 
3. Is minimum temperature increasing differentially by region?

```{r monthlyMinPlot}
# Monthly Trends
min1 <- ggplot(tempMonM) + 
  geom_jitter(aes(x = WY, y = minAvTemp, color = fMonth), size = .7)+
  stat_smooth(aes(x = WY, y = minAvTemp, color = fMonth),method = "lm", formula = y ~ x, size = 1, se = TRUE)+ 
  labs(title = "Average minimum temperature by month") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
ggplotly(min1)

# Regional Trends
min2 <- ggplot(tempMonM) + 
  geom_jitter(aes(x = WY, y = minAvTemp, color = Region), size = .7)+
  stat_smooth(aes(x = WY, y = minAvTemp, color = Region),method = "lm", formula = y ~ x, size = 1, se = FALSE)+ 
  labs(title = "Average minimum temperature by Region") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
ggplotly(min2)

```

### Look at interaction potential
* WYType: Region - no
* WYType: Month - yes
* Season: WYType - yes
* Month: Region - yes
* Season: Region - no
```{r InteractionsPlotsMin}
# WYType:Month
# WY type trend differs by Month

ggplot(tempMonM) + 
  geom_point(aes(x = Month, y = minAvTemp, color = WYType2_Sac)) + 
  stat_smooth(aes(x = Month, y = minAvTemp, color = WYType2_Sac),method = "lm", formula = y ~ x + I(x^2), size = 2, se = TRUE)+ 
  labs(title = "WYType:Month") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + theme_bw()

#see what it looks like with the sin-transformed month
ggplot(tempMonM) + 
  geom_point(aes(x = sMonth, y = minAvTemp, color = WYType2_Sac)) + 
  stat_smooth(aes(x = sMonth, y = minAvTemp, color = WYType2_Sac),method = "lm", size = 2, se = TRUE)+ 
  labs(title = "WYType:Month with sin-transformation") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:Month
# Regional trend seems to differ by Month
ggplot(tempMonM) + 
  geom_point(aes(x = Month, y = minAvTemp, color = Region)) + 
  stat_smooth(aes(x = Month, y = minAvTemp, color = Region),method = "lm", formula = y ~ x + I(x^2), size = 2, se = TRUE)+ 
    labs(title = "Region:Month") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:WYType
ggplot(tempMonM) + 
  geom_boxplot(aes(x = Region, y = minAvTemp, fill = WYType2_Sac)) + 
    labs(title = "Region:WYType") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# WYType:Season
# Not much difference... Spring lower minAvTemp in the wet season, maybe slightly lower min in mid and wet years, other seasons look pretty similar. 
ggplot(tempMonM) + 
  geom_boxplot(aes(x = WYType2_Sac, y = minAvTemp, fill= Season)) +
    labs(title = "WYType:Season") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:Season
# Not anything too significant
ggplot(tempMonM) + 
  geom_boxplot(aes(x = Region, y = minAvTemp, fill = Season)) + 
    labs(title = "Region:Season") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()
```

Models 

* Interested in individual years so removed WY Type and focusing on factor(WY)

```{r Models min Monthly Temp}

summary(M.min1 <- glm(minAvTemp~Region + Month + I(Month^2) + fWY, data = tempMonM))
summary(M.min2 <- glm(minAvTemp~Region + sMonth + fWY, data = tempMonM))
summary(M.min3 <- glm(minAvTemp~Region + Season + fWY , data = tempMonM))
AIC(M.min1, M.min2, M.min3)

```

Proceed with quadratic Month as AIC lowest

```{r}
# Interactions?

summary(M.min5 <- glm(minAvTemp~Region + Month + I(Month^2) + fWY + fWY:Region, data = tempMonM))

summary(M.min6 <- glm(minAvTemp~Region + Month + I(Month^2) + fWY + fWY:Region + fWY:(Month + I(Month^2)), data = tempMonM))

summary(M.min7 <- glm(minAvTemp~Region + Month + I(Month^2) + fWY + Region:(Month + I(Month^2)), data = tempMonM))

summary(M.min8 <- glm(minAvTemp~Region + Season + fWY + fWY:Region + fWY:Season, data = tempMonM))

summary(M.min4 <- glm(minAvTemp~Region + Month + I(Month^2) + fWY + fWY:(Month + I(Month^2)), data = tempMonM))

AIC(M.min1, M.min4, M.min5, M.min6, M.min7, M.min8)
```

Chosen Model: **(M.min4 <- glm(minAvTemp~Region + Month + I(Month^2) + fWY + fWY:(Month + I(Month^2)), data = tempMonM))**

```{r}
par(mfrow = c(2,2))
plot(M.min4)

res.mmin1 = resid(M.min4, type = "pearson")
plot(res.mmin1)
plot(tempMonM$Month^2, res.mmin1)
plot(tempMonM$Region, res.mmin1)
plot(tempMonM$fWY, res.mmin1)

visreg(M.min4, "fWY", by = "Region")
visreg(M.min4, "Month", by = "Region")
visreg(M.min4, "Region", by = "Month")
visreg(M.min4, "fWY", by = "Month")
```

### Mixed Model - Station as random factor

```{r glmmmin}
summary(M.min1a <- lmer(minAvTemp~Region + Month + I(Month^2) + fWY + fWY:(Month + I(Month^2)) + (1|Station), data = tempMonM, na.action = na.omit))

summary(M.min2a <- lmer(minAvTemp~Region + Season + fWY + fWY:Season+ (1|Station), data = tempMonM, na.action = na.omit))

AIC(M.min1a, M.min2a)
```

Best Model: **M.min1a <- lmer(minAvTemp~Region + Month + I(Month^2) + fWY + fWY:(Month + I(Month^2)) + (1|Station), data = tempMonM, na.action = na.omit))**

```{r}
# Using month
par(mfrow = c(2,3))

res.mmin2 = resid(M.min1a, type = "pearson")
lev1a = hatvalues(M.min1a)
plot(M.min1a)
qqnorm(resid(M.min1a))
qqline(resid(M.min1a))
plot(lev1a, y = res.mmin2)

plot(res.mmin2)
plot(tempMonM$Month, res.mmin2)
plot(tempMonM$Region, res.mmin2)
plot(tempMonM$fWY, res.mmin2)


# Using season
par(mfrow = c(2,3))

res.mmin3 = resid(M.min2a, type = "pearson")
lev2a = hatvalues(M.min2a)
plot(M.min2a)
qqnorm(resid(M.min2a))
qqline(resid(M.min2a))
plot(lev2a, y = res.mmin3)

plot(res.mmin3)
plot(tempMonM$Season, res.mmin3)
plot(tempMonM$Region, res.mmin3)
plot(tempMonM$fWY, res.mmin3)
```

### Conclusion
**Back to questions**

1. Has minimum temperature increased over time? 
2. Do we see an annual trend in minimum temperature by month? 
  + Seems to be a slightly higher trend for October, November. Some months don't seem to be increasing.
  + By season, we see higher increase of temp in the winter? (see interactions)
3. Is minimum temperature increasing differentially by region?
 + No interactions? 
 + Generally higher in Sac, San Joaquin, South, Suisun Bay. Lower in Suisun Marsh, North Delta










## Monthly Mean Temps

**Scientific Questions: **    

1. Has mean temperature increased over time? 
2. Do we see an annual trend in mean temperature by month? 
3. Is mean temperature increasing differentially by region?

```{r monthlyMeanPlot}
# Monthly Trends
mean1 <- ggplot(tempMonM) + 
  geom_jitter(aes(x = WY, y = meanTemp, color = fMonth), size = .7)+
  stat_smooth(aes(x = WY, y = meanTemp, color = fMonth),method = "lm", formula = y ~ x, size = 1, se = TRUE)+ 
  labs(title = "Mean temperature by month") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
ggplotly(mean1)

# Regional Trends
mean2 <- ggplot(tempMonM) + 
  geom_jitter(aes(x = WY, y = meanTemp, color = Region), size = .7)+
  stat_smooth(aes(x = WY, y = meanTemp, color = Region),method = "lm", formula = y ~ x, size = 1, se = FALSE)+ 
  labs(title = "Mean temperature by Region") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
ggplotly(mean2)

```

### Look at interaction potential
* WYType: Region - no
* WYType: Month - yes
* Season: WYType - yes
* Month: Region - yes
* Season: Region - no
```{r InteractionsPlotsMean}
# WYType:Month
# WY type trend differs by Month

ggplot(tempMonM) + 
  geom_point(aes(x = Month, y = meanTemp, color = WYType2_Sac)) + 
  stat_smooth(aes(x = Month, y = meanTemp, color = WYType2_Sac),method = "lm", formula = y ~ x + I(x^2), size = 2, se = TRUE)+ 
  labs(title = "WYType:Month") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + theme_bw()

#see what it looks like with the sin-transformed month
ggplot(tempMonM) + 
  geom_point(aes(x = sMonth, y = meanTemp, color = WYType2_Sac)) + 
  stat_smooth(aes(x = sMonth, y = meanTemp, color = WYType2_Sac),method = "lm", size = 2, se = TRUE)+ 
  labs(title = "WYType:Month with sin-transformation") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:Month
# Regional trend seems to differ by Month
ggplot(tempMonM) + 
  geom_point(aes(x = Month, y = meanTemp, color = Region)) + 
  stat_smooth(aes(x = Month, y = meanTemp, color = Region),method = "lm", formula = y ~ x + I(x^2), size = 2, se = TRUE)+ 
    labs(title = "Region:Month") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:WYType
ggplot(tempMonM) + 
  geom_boxplot(aes(x = Region, y = meanTemp, fill = WYType2_Sac)) + 
    labs(title = "Region:WYType") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# WYType:Season
# Not much difference... Spring lower meanTemp in the wet season, maybe slightly lower min in mid and wet years, other seasons look pretty similar. 
ggplot(tempMonM) + 
  geom_boxplot(aes(x = WYType2_Sac, y = meanTemp, fill= Season)) +
    labs(title = "WYType:Season") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:Season
# Not anything too significant
ggplot(tempMonM) + 
  geom_boxplot(aes(x = Region, y = meanTemp, fill = Season)) + 
    labs(title = "Region:Season") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()
```

Models 

* Interested in individual years so removed WY Type and focusing on factor(WY)

```{r Models mean Monthly Temp}

summary(M.mean1 <- glm(meanTemp~Region + Month + I(Month^2) + fWY, data = tempMonM))
summary(M.mean2 <- glm(meanTemp~Region + sMonth + fWY, data = tempMonM))
summary(M.mean3 <- glm(meanTemp~Region + Season + fWY , data = tempMonM))
AIC(M.mean1, M.mean2, M.mean3)

```

Proceed with quadratic Month as AIC lowest

```{r}
# Interactions?

summary(M.mean5 <- glm(meanTemp~Region + Month + I(Month^2) + fWY + fWY:Region, data = tempMonM))

summary(M.mean6 <- glm(meanTemp~Region + Month + I(Month^2) + fWY + fWY:Region + fWY:(Month + I(Month^2)), data = tempMonM))

summary(M.mean7 <- glm(meanTemp~Region + Month + I(Month^2) + fWY + Region:(Month + I(Month^2)), data = tempMonM))

summary(M.mean8 <- glm(meanTemp~Region + Season + fWY + fWY:Region + fWY:Season, data = tempMonM))

summary(M.mean4 <- glm(meanTemp~Region + Month + I(Month^2) + fWY + fWY:(Month + I(Month^2)), data = tempMonM))

AIC(M.mean1, M.mean4, M.mean5, M.mean6, M.mean7, M.mean8)
```

Chosen Model: **(M.mean4 <- glm(meanTemp~Region + Month + I(Month^2) + fWY + fWY:(Month + I(Month^2)), data = tempMonM))**

```{r}
par(mfrow = c(2,2))
plot(M.mean4)

res.mmean1 = resid(M.mean4, type = "pearson")
plot(res.mmean1)
plot(tempMonM$Month^2, res.mmean1)
plot(tempMonM$Region, res.mmean1)
plot(tempMonM$fWY, res.mmean1)

visreg(M.mean4, "fWY", by = "Region")
visreg(M.mean4, "Month", by = "Region")
visreg(M.mean4, "Region", by = "Month")
visreg(M.mean4, "fWY", by = "Month")
```

### Mixed Model - Station as random factor

```{r glmmmean}
summary(M.mean1a <- lmer(meanTemp~Region + Month + I(Month^2) + fWY + fWY:(Month + I(Month^2)) + (1|Station), data = tempMonM, na.action = na.omit))

summary(M.mean2a <- lmer(meanTemp~Region + Season + fWY + fWY:Season+ (1|Station), data = tempMonM, na.action = na.omit))

AIC(M.mean1a, M.mean2a)
```

Best Model: **M.mean1a <- lmer(meanTemp~Region + Month + I(Month^2) + fWY + fWY:(Month + I(Month^2)) + (1|Station), data = tempMonM, na.action = na.omit))**

```{r}
# Using month
par(mfrow = c(2,3))

res.mmean2 = resid(M.mean1a, type = "pearson")
lev1a = hatvalues(M.mean1a)
plot(M.mean1a)
qqnorm(resid(M.mean1a))
qqline(resid(M.mean1a))
plot(lev1a, y = res.mmean2)

plot(res.mmean2)
plot(tempMonM$Month, res.mmean2)
plot(tempMonM$Region, res.mmean2)
plot(tempMonM$fWY, res.mmean2)


# Using season
par(mfrow = c(2,3))

res.mmean3 = resid(M.mean2a, type = "pearson")
lev2a = hatvalues(M.mean2a)
plot(M.mean2a)
qqnorm(resid(M.mean2a))
qqline(resid(M.mean2a))
plot(lev2a, y = res.mmean3)

plot(res.mmean3)
plot(tempMonM$Season, res.mmean3)
plot(tempMonM$Region, res.mmean3)
plot(tempMonM$fWY, res.mmean3)
```

### Conclusion
**Back to questions**

1. Has minimum temperature increased over time? 
2. Do we see an annual trend in minimum temperature by month? 
  + Seems to be a slightly higher trend for October, November. Some months don't seem to be increasing.
  + By season, we see higher increase of temp in the winter? (see interactions)
3. Is minimum temperature increasing differentially by region?
 + No interactions? 
 + Generally higher in Sac, San Joaquin, South, Suisun Bay. Lower in Suisun Marsh, North Delta
 
 
 







WINTER STARTS HERE



## Winter Temperatures

**This includes November - February **

    Scientific Questions:

    1. Do winter temperatures (mean, max, min) increase over time?
    2. Are there notable differences in how winter temperatures change by region? 
    3. Are there certain months where temperature increases more over time? 

### Max Temperature
#### Plots
```{r}
Winter <- tempMonM %>%
  filter(Season == "Winter" | Month == 11| Month == 3,
         Region != "Far North")


Winter$fMonth <- factor(Winter$fMonth, levels = c(11, 12, 1, 2, 3))
```


```{r monWinterMaxPlot}
# Monthly Trends
winMax1 <- ggplot(Winter) + 
  geom_jitter(aes(x = WY, y = maxAvTemp, color = fMonth), size = .7)+
  stat_smooth(aes(x = WY, y = maxAvTemp, color = fMonth),method = "lm", formula = y ~ x, size = 1, se = TRUE)+ 
  labs(title = "Average winter maximum temperature by month") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
ggplotly(winMax1)

# Regional Trends
winMax2 <- ggplot(Winter) + 
  geom_jitter(aes(x = WY, y = maxAvTemp, color = Region), size = .7)+
  stat_smooth(aes(x = WY, y = maxAvTemp, color = Region),method = "lm", formula = y ~ x, size = 1, se = FALSE)+ 
  labs(title = "Average winter maximum temperature by Region") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
ggplotly(winMax2)

```

### Look at interaction potential
* Month * WYType: no
* Month * Region: slight
* Region * WYType: no

```{r InteractionsPlotsWinterMax}
# WYType:Month
ggplot(Winter) + 
  geom_boxplot(aes(x = Region, y = maxAvTemp, fill = WYType2_Sac)) + 
    labs(title = "WYType:Month") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:Month
# Regional trend seems to differ by Month
ggplot(Winter) + 
  geom_boxplot(aes(x = Region, y = maxAvTemp, fill = fMonth)) + 
    labs(title = "Region:Month") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:WYType
ggplot(Winter) + 
  geom_boxplot(aes(x = Region, y = maxAvTemp, fill = WYType2_Sac)) + 
    labs(title = "Region:WYType") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()
```

Models 

* Interested in individual years so removed WY Type and focusing on factor(WY)
* Trying factor(Month) since we now only have 4 months

```{r Models winter Max Monthly Temp}

summary(M.wMax1 <- glm(maxAvTemp~Region + Month + I(Month^2) + fWY, data = Winter))
summary(M.wMax2 <- glm(maxAvTemp~Region + sMonth + fWY, data = Winter))
summary(M.wMax3 <- glm(maxAvTemp~Region + fMonth + fWY , data = Winter))
AIC(M.wMax1, M.wMax2, M.wMax3)

```

Proceed with factor month - lowest AIC

```{r}
# Interactions?

summary(M.wMax5 <- glm(maxAvTemp~Region + fMonth + fWY + fWY:Region, data = Winter))

summary(M.wMax6 <- glm(maxAvTemp~Region + fMonth + fWY + fWY:Region + fWY:fMonth, data = Winter))

summary(M.wMax7 <- glm(maxAvTemp~Region + fMonth + fWY + Region:fMonth, data = Winter))

# Month
summary(M.wMax4 <- glm(maxAvTemp~Region + fMonth + fWY + fWY:fMonth, data = Winter))

AIC(M.wMax3, M.wMax4, M.wMax5, M.wMax6, M.wMax7)
```

Chosen Model: **(M.wMax4 <- glm(maxAvTemp~Region + fMonth + fWY + fWY:fMonth, data = Winter))**

```{r}
par(mfrow = c(2,2))
plot(M.wMax4)

res.wmax1 = resid(M.wMax4, type = "pearson")
plot(res.wmax1)
plot(Winter$Month, res.wmax1)
plot(Winter$Region, res.wmax1)
plot(Winter$fWY, res.wmax1)

visreg(M.wMax4, "fWY", by = "Region")
visreg(M.wMax4, "fMonth", by = "Region")
visreg(M.wMax4, "Region", by = "fMonth")
visreg(M.wMax4, "fWY", by = "fMonth")
```

### Mixed Model - Station as random factor

```{r glmwmax}
summary(M.wMax1a <- lmer(maxAvTemp~Region + fMonth + fWY + fWY:fMonth + (1|Station), data = Winter, na.action = na.omit))
```

Best Model: **M.wMax1a <- lmer(maxAvTemp~Region + Month + I(Month^2) + fWY + fWY:(Month + I(Month^2)) + (1|Station), data = Winter, na.action = na.omit))**

```{r}
# Using month
par(mfrow = c(2,3))

res.wmax2 = resid(M.wMax1a, type = "pearson")
lev1wa = hatvalues(M.wMax1a)
plot(M.wMax1a)
qqnorm(resid(M.wMax1a))
qqline(resid(M.wMax1a))
plot(lev1wa, y = res.wmax2)

plot(res.wmax2)
plot(Winter$fMonth, res.wmax2)
plot(Winter$Region, res.wmax2)
plot(Winter$fWY, res.wmax2)
```

Notes 
* QQ Plot does not look good

### Conclusions

* Month: Summer>Fall>Spring>Winter
* Region: San Joaquin, South higher max temps
* Year: 






### Min Winter Temperature
#### Plots
```{r monWinterMinPlot}
# Monthly Trends
winMin1 <- ggplot(Winter) + 
  geom_jitter(aes(x = WY, y = minAvTemp, color = fMonth), size = .7)+
  stat_smooth(aes(x = WY, y = minAvTemp, color = fMonth),method = "lm", formula = y ~ x, size = 1, se = TRUE)+ 
  labs(title = "Average winter minimum temperature by month") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
ggplotly(winMin1)

# Regional Trends
winMin2 <- ggplot(Winter) + 
  geom_jitter(aes(x = WY, y = minAvTemp, color = Region), size = .7)+
  stat_smooth(aes(x = WY, y = minAvTemp, color = Region),method = "lm", formula = y ~ x, size = 1, se = FALSE)+ 
  labs(title = "Average winter minimum temperature by Region") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
ggplotly(winMin2)

```

### Look at interaction potential
* Month * WYType: yes
* Month * Region: yes
* Region * WYType: no

```{r InteractionsPlotsWinterMin}
# WYType:Month
# WY type trend differs by Month
ggplot(Winter) + 
  geom_boxplot(aes(x = fMonth, y = minAvTemp, fill = WYType2_Sac)) + 
    labs(title = "Month:WYType") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:Month
# Regional trend seems to differ by Month
ggplot(Winter) + 
  geom_boxplot(aes(x = fMonth, y = minAvTemp, fill = Region)) + 
    labs(title = "Region:Month") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:WYType
ggplot(Winter) + 
  geom_boxplot(aes(x = Region, y = minAvTemp, fill = WYType2_Sac)) + 
    labs(title = "Region:WYType") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()
```

Models 

* Interested in individual years so removed WY Type and focusing on factor(WY)
* Trying factor(Month) since we now only have 4 months

```{r Models Winter Min Monthly Temp}

summary(M.wMin1 <- glm(minAvTemp~Region + Month + I(Month^2) + fWY, data = Winter))
summary(M.wMin2 <- glm(minAvTemp~Region + sMonth + fWY, data = Winter))
summary(M.wMin3 <- glm(minAvTemp~Region + fMonth + fWY , data = Winter))
AIC(M.wMin1, M.wMin2, M.wMin3)

```

Proceed with factor month - lowest AIC

```{r}
# Interactions?

summary(M.wMin5 <- glm(minAvTemp~Region + fMonth + fWY + fWY:Region, data = Winter))

summary(M.wMin6 <- glm(minAvTemp~Region + fMonth + fWY + fWY:Region + fWY:fMonth, data = Winter))

summary(M.wMin7 <- glm(minAvTemp~Region + fMonth + fWY + Region:fMonth, data = Winter))

# Month
summary(M.wMin4 <- glm(minAvTemp~Region + fMonth + fWY + fWY:fMonth, data = Winter))

AIC(M.wMin3, M.wMin4, M.wMin5, M.wMin6, M.wMin7)
```

Chosen Model: **(M.wMin4 <- glm(minAvTemp~Region + fMonth + fWY + fWY:fMonth, data = Winter))**

```{r}
par(mfrow = c(2,2))
plot(M.wMin4)

res.wmin1 = resid(M.wMin4, type = "pearson")
plot(res.wmin1)
plot(Winter$Month, res.wmin1)
plot(Winter$Region, res.wmin1)
plot(Winter$fWY, res.wmin1)

visreg(M.wMin4, "fWY", by = "Region")
visreg(M.wMin4, "fMonth", by = "Region")
visreg(M.wMin4, "Region", by = "fMonth")
visreg(M.wMin4, "fWY", by = "fMonth")
```

### Mixed Model - Station as random factor

```{r glmwmin}
summary(M.wMin1a <- lmer(minAvTemp~Region + fMonth + fWY + fWY:fMonth + (1|Station), data = Winter, na.action = na.omit))
```

Best Model: **M.wMin1a <- lmer(minAvTemp~Region + Month + I(Month^2) + fWY + fWY:(Month + I(Month^2)) + (1|Station), data = Winter, na.action = na.omit))**

```{r}
# Using month
par(mfrow = c(2,3))

res.wmin2 = resid(M.wMin1a, type = "pearson")
lev2wa = hatvalues(M.wMin1a)
plot(M.wMin1a)
qqnorm(resid(M.wMin1a))
qqline(resid(M.wMin1a))
plot(lev2wa, y = res.wmin2)

plot(res.wmin2)
plot(Winter$fMonth, res.wmin2)
plot(Winter$Region, res.wmin2)
plot(Winter$fWY, res.wmin2)
```


Visualizing model results: 
```{r include = FALSE, eval = FALSE}

call <- ggpredict(M.wMin4, terms = c("fWY", "fMonth", "Region"), type = "re") 
ggplot(call, aes(x, predicted, group = group)) +
  geom_line(aes(color = group)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, group = group), alpha = .1)+
  geom_point() +
  labs(x = "Water Year", y = "Predicted", title = "Winter Avg Min Temp") + 
   theme_minimal()
```

Notes 
* QQ Plot does not look good

### Conclusions

* Month: March and November > February > Dec and Jan
* Region: Pretty close
* Year: 



### Mean Winter Temperature
#### Plots
```{r monWinterMeanPlot}
# Monthly Trends
winMean1 <- ggplot(Winter) + 
  geom_jitter(aes(x = WY, y = meanTemp, color = fMonth), size = .7)+
  stat_smooth(aes(x = WY, y = meanTemp, color = fMonth),method = "lm", formula = y ~ x, size = 1, se = TRUE)+ 
  labs(title = "Winter mean temperature by month") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
ggplotly(winMean1)

# Regional Trends
winMean2 <- ggplot(Winter) + 
  geom_jitter(aes(x = WY, y = meanTemp, color = Region), size = .7)+
  stat_smooth(aes(x = WY, y = meanTemp, color = Region),method = "lm", formula = y ~ x, size = 1, se = FALSE)+ 
  labs(title = "Winter mean temperature by Region") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
ggplotly(winMean2)

```

### Look at interaction potential
* Month * WYType: yes
* Month * Region: yes
* Region * WYType: no

```{r InteractionsPlotsWinterMean}
# WYType:Month
# WY type trend differs by Month
ggplot(Winter) + 
  geom_boxplot(aes(x = fMonth, y = meanTemp, fill = WYType2_Sac)) + 
    labs(title = "Month:WYType") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:Month
# Regional trend seems to differ by Month
ggplot(Winter) + 
  geom_boxplot(aes(x = fMonth, y = meanTemp, fill = Region)) + 
    labs(title = "Region:Month") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:WYType
ggplot(Winter) + 
  geom_boxplot(aes(x = Region, y = meanTemp, fill = WYType2_Sac)) + 
    labs(title = "Region:WYType") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()
```

Models 

* Interested in individual years so removed WY Type and focusing on factor(WY)
* Trying factor(Month) since we now only have 4 months

```{r Models Winter Mean Monthly Temp}

summary(M.wMean1 <- glm(meanTemp~Region + Month + I(Month^2) + fWY, data = Winter))
summary(M.wMean2 <- glm(meanTemp~Region + sMonth + fWY, data = Winter))
summary(M.wMean3 <- glm(meanTemp~Region + fMonth + fWY , data = Winter))
AIC(M.wMean1, M.wMean2, M.wMean3)

```

Proceed with factor month - lowest AIC

```{r}
# Interactions?

summary(M.wMean5 <- glm(meanTemp~Region + fMonth + fWY + fWY:Region, data = Winter))

summary(M.wMean6 <- glm(meanTemp~Region + fMonth + fWY + fWY:Region + fWY:fMonth, data = Winter))

summary(M.wMean7 <- glm(meanTemp~Region + fMonth + fWY + Region:fMonth, data = Winter))

# Month
summary(M.wMean4 <- glm(meanTemp~Region + fMonth + fWY + fWY:fMonth, data = Winter))

AIC(M.wMean3, M.wMean4, M.wMean5, M.wMean6, M.wMean7)
```

Chosen Model: **(M.wMean4 <- glm(meanTemp~Region + fMonth + fWY + fWY:fMonth, data = Winter))**

```{r}
par(mfrow = c(2,2))
plot(M.wMean4)

res.wmean1 = resid(M.wMean4, type = "pearson")
plot(res.wmean1)
plot(Winter$Month, res.wmean1)
plot(Winter$Region, res.wmean1)
plot(Winter$fWY, res.wmean1)

visreg(M.wMean4, "fWY", by = "Region")
visreg(M.wMean4, "fMonth", by = "Region")
visreg(M.wMean4, "Region", by = "fMonth")
visreg(M.wMean4, "fWY", by = "fMonth")
```

### Mixed Model - Station as random factor

```{r glmwmean}
summary(M.wMean1a <- lmer(meanTemp~Region + fMonth + fWY + fWY:fMonth + (1|Station), data = Winter, na.action = na.omit))
```

Best Model: **M.wMean1a <- lmer(meanTemp~Region + Month + I(Month^2) + fWY + fWY:(Month + I(Month^2)) + (1|Station), data = Winter, na.action = na.omit))**

```{r}
# Using month
par(mfrow = c(2,3))

res.wmean2 = resid(M.wMean1a, type = "pearson")
lev3wa = hatvalues(M.wMean1a)
plot(M.wMean1a)
qqnorm(resid(M.wMean1a))
qqline(resid(M.wMean1a))
plot(lev3wa, y = res.wmean2)

plot(res.wmean2)
plot(Winter$fMonth, res.wmean2)
plot(Winter$Region, res.wmean2)
plot(Winter$fWY, res.wmean2)
```

Visualizing model results: 
```{r include = FALSE, eval = FALSE}


call <- ggpredict(M.wMean4, terms = c("fWY", "fMonth", "Region"), type = "re") 
ggplot(call, aes(x, predicted, group = group)) +
  geom_line(aes(color = group)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, group = group), alpha = .1)+
  geom_point() +
  labs(x = "Water Year", y = "Predicted", title = "Winter Avg Mean Temp") + 
   theme_minimal()
```

Notes 
* QQ Plot does not look good

### Conclusions

* Month: 
* Region: 
* Year: 



**Back to questions**

1. Do winter temperatures (mean, max, min) increase over time?
* Mean: warmer in the last 5 years
2. Are there notable differences in how winter temperatures change by region? 
* Trend higher for San Joaquin, South, Suisun Bay
3. Are there certain months where temperature increases more over time? 
* December and January increased to a lesser degree

### Conclusions:

    While there is a lot of variability around year (really warm in 2015!), it looks like mean winter temperatures have been warmer in the last 5 years, compared with the prior 6 years. Not sure we care about month trends, but generally December and January are cooler than November and February. For regions, San Joaquin, South and Suisun Bay have slightly warmer mean winter temps. 


















SUMMER STARTS HERE




## Summer Temperatures 
**Scientific Questions: **

1. Do summer temperatures (mean, min, max) increase over time?
2. Are there notable differences in how summer temperatures change by region? 
3. Are there certain months where temperature increases more over time? 


```{r}
Summer <- tempMonM %>%
  filter(Season == "Summer" | Month == 9)

Summer$fMonth <- factor(Summer$fMonth, levels = c(6,7,8,9))
```


### Max Summer Temperature
#### Plots

```{r monSummerMaxPlot}
# Monthly Trends
sumMax1 <- ggplot(Summer) + 
  geom_jitter(aes(x = WY, y = maxAvTemp, color = fMonth), size = .7)+
  stat_smooth(aes(x = WY, y = maxAvTemp, color = fMonth),method = "lm", formula = y ~ x, size = 1, se = TRUE)+ 
  labs(title = "Average summer maximum temperature by month") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
ggplotly(sumMax1)

# Regional Trends
sumMax2 <- ggplot(Summer) + 
  geom_jitter(aes(x = WY, y = maxAvTemp, color = Region), size = .7)+
  stat_smooth(aes(x = WY, y = maxAvTemp, color = Region),method = "lm", formula = y ~ x, size = 1, se = FALSE)+ 
  labs(title = "Average summer maximum temperature by Region") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
ggplotly(sumMax2)

```

### Look at interaction potential
* Month * WYType: slight
* Month * Region: no
* Region * WYType: South:Wet only

```{r InteractionsPlotsSummerMax}
# WYType:Month
ggplot(Summer) + 
  geom_boxplot(aes(x = Region, y = maxAvTemp, fill = WYType2_Sac)) + 
    labs(title = "WYType:Month") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:Month
ggplot(Summer) + 
  geom_boxplot(aes(x = Region, y = maxAvTemp, fill = fMonth)) + 
    labs(title = "Region:Month") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:WYType
ggplot(Summer) + 
  geom_boxplot(aes(x = Region, y = maxAvTemp, fill = WYType2_Sac)) + 
    labs(title = "Region:WYType") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()
```

Models 

* Interested in individual years so removed WY Type and focusing on factor(WY)
* Trying factor(Month) since we now only have 4 months

```{r Models Summer Max Monthly Temp}

summary(M.sMax1 <- glm(maxAvTemp~Region + Month + I(Month^2) + fWY, data = Summer))
summary(M.sMax2 <- glm(maxAvTemp~Region + sMonth + fWY, data = Summer))
summary(M.sMax3 <- glm(maxAvTemp~Region + fMonth + fWY , data = Summer))
AIC(M.sMax1, M.sMax2, M.sMax3)

```

Proceed with factor month - lowest AIC

```{r}
# Interactions?
summary(M.sMax4 <- glm(maxAvTemp~Region + fMonth + fWY + fWY:fMonth, data = Summer))

summary(M.sMax7 <- glm(maxAvTemp~Region + fMonth + fWY + Region:fMonth, data = Summer))

summary(M.sMax5 <- glm(maxAvTemp~Region + fMonth + fWY + fWY:Region, data = Summer))
summary(M.sMax6 <- glm(maxAvTemp~Region + fMonth + fWY + fWY:Region + fWY:fMonth, data = Summer))

AIC(M.sMax3, M.sMax4, M.sMax5, M.sMax6, M.sMax7)
```

Chosen Model: **(M.sMax6 <- glm(maxAvTemp~Region + fMonth + fWY + fWY:Region + fWY:fMonth, data = Summer))**

```{r}
par(mfrow = c(2,2))
plot(M.sMax6)

res.smax1 = resid(M.sMax6, type = "pearson")
plot(res.smax1)
plot(Summer$Month, res.smax1)
plot(Summer$Region, res.smax1)
plot(Summer$fWY, res.smax1)

visreg(M.sMax6, "fWY", by = "Region")
visreg(M.sMax6, "fMonth", by = "Region")
visreg(M.sMax6, "Region", by = "fMonth")
visreg(M.sMax6, "fWY", by = "fMonth")
```

### Mixed Model - Station as random factor

```{r glmsmax}
summary(M.sMax1a <- lmer(maxAvTemp~Region + fMonth + fWY + fWY:fMonth + (1|Station), data = Summer, na.action = na.omit))

summary(M.sMax2a <- lmer(maxAvTemp~Region + fMonth + fWY + fWY:Region + (1|Station), data = Summer, na.action = na.omit))

summary(M.sMax3a <- lmer(maxAvTemp~Region + fMonth + fWY + fWY:fMonth + fWY:Region + (1|Station), data = Summer, na.action = na.omit))

AIC(M.sMax1a, M.sMax2a, M.sMax3a)
```

Best Model: **M.sMax2a <- lmer(maxAvTemp~Region + fMonth + fWY + fWY:Region + (1|Station), data = Summer)**

```{r}
# Using month
par(mfrow = c(2,3))

res.smax2 = resid(M.sMax3a, type = "pearson")
lev1sa = hatvalues(M.sMax3a)
plot(M.sMax3a)
qqnorm(resid(M.sMax2a))
qqline(resid(M.sMax2a))
plot(lev1sa, y = res.smax2)

plot(res.smax2)
plot(Summer$fMonth, res.smax2)
plot(Summer$Region, res.smax2)
plot(Summer$fWY, res.smax2)
```

Visualizing model results: 
```{r include = FALSE, eval = FALSE}
call <- ggpredict(M.sMax6, terms = c("fWY", "fMonth", "Region"), type = "re") 
ggplot(call, aes(x, predicted, group = group)) +
  geom_line(aes(color = group)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, group = group), alpha = .1)+
  geom_point() +
  labs(x = "Water Year", y = "Predicted", title = "Summer Avg Max Temp") + 
   theme_minimal()
```

Notes 
* QQ Plot does not look good

### Conclusions

* Month: 
* Region: South looks crazy
* Year: 






### Min Summer Temperature
#### Plots
```{r monSummerMinPlot}
# Monthly Trends
sumMin1 <- ggplot(Summer) + 
  geom_jitter(aes(x = WY, y = minAvTemp, color = fMonth), size = .7)+
  stat_smooth(aes(x = WY, y = minAvTemp, color = fMonth),method = "lm", formula = y ~ x, size = 1, se = TRUE)+ 
  labs(title = "Average summer minimum temperature by month") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
ggplotly(sumMin1)

# Regional Trends
sumMin2 <- ggplot(Summer) + 
  geom_jitter(aes(x = WY, y = minAvTemp, color = Region), size = .7)+
  stat_smooth(aes(x = WY, y = minAvTemp, color = Region),method = "lm", formula = y ~ x, size = 1, se = FALSE)+ 
  labs(title = "Average summer minimum temperature by Region") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
ggplotly(sumMin2)

```

### Look at interaction potential
* Month * WYType: yes
* Month * Region: no
* Region * WYType: yes

```{r InteractionsPlotsSummerMin}
# WYType:Month
# WY type trend differs by Month
ggplot(Summer) + 
  geom_boxplot(aes(x = fMonth, y = minAvTemp, fill = WYType2_Sac)) + 
    labs(title = "Month:WYType") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:Month
# Regional trend seems to differ by Month
ggplot(Summer) + 
  geom_boxplot(aes(x = fMonth, y = minAvTemp, fill = Region)) + 
    labs(title = "Region:Month") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:WYType
ggplot(Summer) + 
  geom_boxplot(aes(x = Region, y = minAvTemp, fill = WYType2_Sac)) + 
    labs(title = "Region:WYType") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()
```

Models 

* Interested in individual years so removed WY Type and focusing on factor(WY)
* Trying factor(Month) since we now only have 4 months

```{r Models Summer Min Monthly Temp}

summary(M.sMin1 <- glm(minAvTemp~Region + Month + I(Month^2) + fWY, data = Summer))
summary(M.sMin2 <- glm(minAvTemp~Region + sMonth + fWY, data = Summer))
summary(M.sMin3 <- glm(minAvTemp~Region + fMonth + fWY , data = Summer))
AIC(M.sMin1, M.sMin2, M.sMin3)

```

Proceed with factor month - lowest AIC

```{r}
# Interactions?

summary(M.sMin5 <- glm(minAvTemp~Region + fMonth + fWY + fWY:Region, data = Summer))

summary(M.sMin6 <- glm(minAvTemp~Region + fMonth + fWY + fWY:Region + fWY:fMonth, data = Summer))

summary(M.sMin7 <- glm(minAvTemp~Region + fMonth + fWY + Region:fMonth, data = Summer))

# Month
summary(M.sMin4 <- glm(minAvTemp~Region + fMonth + fWY + fWY:fMonth, data = Summer))

AIC(M.sMin3, M.sMin4, M.sMin5, M.sMin6, M.sMin7)
```

Chosen Model: **(M.sMin6 <- glm(minAvTemp~Region + fMonth + fWY + fWY:Region + fWY:fMonth, data = Summer))**

```{r}
par(mfrow = c(2,2))
plot(M.sMin6)

res.smin1 = resid(M.sMin6, type = "pearson")
plot(res.smin1)
plot(Summer$Month, res.smin1)
plot(Summer$Region, res.smin1)
plot(Summer$fWY, res.smin1)

visreg(M.sMin6, "fWY", by = "Region")
visreg(M.sMin6, "fMonth", by = "Region")
visreg(M.sMin6, "Region", by = "fMonth")
visreg(M.sMin6, "fWY", by = "fMonth")
```

### Mixed Model - Station as random factor

```{r glmsmin}
summary(M.sMin1a <- lmer(minAvTemp~Region + fMonth + fWY + fWY:fMonth + (1|Station), data = Summer, na.action = na.omit))

summary(M.sMin2a <- lmer(minAvTemp~Region + fMonth + fWY + fWY:Region + (1|Station), data = Summer, na.action = na.omit))

summary(M.sMin3a <- lmer(minAvTemp~Region + fMonth + fWY + fWY:fMonth + fWY:Region +(1|Station), data = Summer, na.action = na.omit))

AIC(M.sMin1a, M.sMin2a, M.sMin3a)
```

Best Model: **M.sMin3a <- lmer(minAvTemp~Region + fMonth + fWY + fWY:fMonth + fWY:Region +(1|Station), data = Summer)**

```{r}
# Using month
par(mfrow = c(2,3))

res.smin2 = resid(M.sMin3a, type = "pearson")
lev2sa = hatvalues(M.sMin3a)
plot(M.sMin3a)
qqnorm(resid(M.sMin3a))
qqline(resid(M.sMin3a))
plot(lev2sa, y = res.smin2)

plot(res.smin2)
plot(Summer$fMonth, res.smin2)
plot(Summer$Region, res.smin2)
plot(Summer$fWY, res.smin2)
```


Visualizing model results: 
```{r include = FALSE, eval = FALSE}
call <- ggpredict(M.sMin6, terms = c("fWY", "fMonth", "Region"), type = "re") 
ggplot(call, aes(x, predicted, group = group)) +
  geom_line(aes(color = group)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, group = group), alpha = .1)+
  geom_point() +
  labs(x = "Water Year", y = "Predicted", title = "Summer Avg Min Temp") + 
   theme_minimal()
```

Notes 
* QQ Plot does not look good

### Conclusions

* Month: 
* Region: 
* Year: 



### Mean Summer Temperature
#### Plots
```{r monSummerMeanPlot}
# Monthly Trends
sumMean1 <- ggplot(Summer) + 
  geom_jitter(aes(x = WY, y = meanTemp, color = fMonth), size = .7)+
  stat_smooth(aes(x = WY, y = meanTemp, color = fMonth),method = "lm", formula = y ~ x, size = 1, se = TRUE)+ 
  labs(title = "Summer mean temperature by month") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
ggplotly(sumMean1)

# Regional Trends
sumMean2 <- ggplot(Summer) + 
  geom_jitter(aes(x = WY, y = meanTemp, color = Region), size = .7)+
  stat_smooth(aes(x = WY, y = meanTemp, color = Region),method = "lm", formula = y ~ x, size = 1, se = FALSE)+ 
  labs(title = "Summer mean temperature by Region") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
ggplotly(sumMean2)

```

### Look at interaction potential
* Month * WYType: yes
* Month * Region: yes
* Region * WYType: no

```{r InteractionsPlotsSummerMean}
# WYType:Month
# WY type trend differs by Month
ggplot(Summer) + 
  geom_boxplot(aes(x = fMonth, y = meanTemp, fill = WYType2_Sac)) + 
    labs(title = "Month:WYType") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:Month
# Regional trend seems to differ by Month
ggplot(Summer) + 
  geom_boxplot(aes(x = fMonth, y = meanTemp, fill = Region)) + 
    labs(title = "Region:Month") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:WYType
ggplot(Summer) + 
  geom_boxplot(aes(x = Region, y = meanTemp, fill = WYType2_Sac)) + 
    labs(title = "Region:WYType") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()
```

Models 

* Interested in individual years so removed WY Type and focusing on factor(WY)
* Trying factor(Month) since we now only have 4 months

```{r Models Summer Mean Monthly Temp}

summary(M.sMean1 <- glm(meanTemp~Region + Month + I(Month^2) + fWY, data = Summer))
summary(M.sMean2 <- glm(meanTemp~Region + sMonth + fWY, data = Summer))
summary(M.sMean3 <- glm(meanTemp~Region + fMonth + fWY , data = Summer))
AIC(M.sMean1, M.sMean2, M.sMean3)

```

Proceed with factor month - lowest AIC

```{r}
# Interactions?
# Month
summary(M.sMean4 <- glm(meanTemp~Region + fMonth + fWY + fWY:fMonth, data = Summer))
summary(M.sMean5 <- glm(meanTemp~Region + fMonth + fWY + fWY:Region, data = Summer))
summary(M.sMean7 <- glm(meanTemp~Region + fMonth + fWY + Region:fMonth, data = Summer))
summary(M.sMean6 <- glm(meanTemp~Region + fMonth + fWY + fWY:Region + fWY:fMonth, data = Summer))

AIC(M.sMean3, M.sMean4, M.sMean5, M.sMean6, M.sMean7)
```

Chosen Model: **(M.sMean6 <- glm(meanTemp~Region + fMonth + fWY + fWY:Region + fWY:fMonth, data = Summer))**

```{r}
par(mfrow = c(2,2))
plot(M.sMean6)

res.smean1 = resid(M.sMean6, type = "pearson")
plot(res.smean1)
plot(Summer$Month, res.smean1)
plot(Summer$Region, res.smean1)
plot(Summer$fWY, res.smean1)

visreg(M.sMean6, "fWY", by = "Region")
visreg(M.sMean6, "fMonth", by = "Region")
visreg(M.sMean6, "Region", by = "fMonth")
visreg(M.sMean6, "fWY", by = "fMonth")
```

### Mixed Model - Station as random factor

```{r glmsmean}
summary(M.sMean1a <- lmer(meanTemp~Region + fMonth + fWY + fWY:fMonth + (1|Station), data = Summer, na.action = na.omit))

summary(M.sMean2a <- lmer(meanTemp~Region + fMonth + fWY + fWY:Region + (1|Station), data = Summer, na.action = na.omit))

summary(M.sMean3a <- lmer(meanTemp~Region + fMonth + fWY + fWY:fMonth + fWY:Region + (1|Station), data = Summer, na.action = na.omit))

AIC(M.sMean1a, M.sMean2a, M.sMean3a)
```

Best Model: **M.sMean3a <- lmer(meanTemp~Region + fMonth + fWY + fWY:fMonth + fWY:Region + (1|Station), data = Summer)**

```{r}
# Using month
par(mfrow = c(2,3))

res.smean3 = resid(M.sMean3a, type = "pearson")
lev3sa = hatvalues(M.sMean3a)
plot(M.sMean1a)
qqnorm(resid(M.sMean3a))
qqline(resid(M.sMean3a))
plot(lev3sa, y = res.smean3)

plot(res.smean3)
plot(Summer$fMonth, res.smean3)
plot(Summer$Region, res.smean3)
plot(Summer$fWY, res.smean3)
```

Visualizing model results: 
```{r include = FALSE, eval = FALSE}

call <- ggpredict(M.sMean6, terms = c("fWY", "fMonth", "Region"), type = "re") 
ggplot(call, aes(x, predicted, group = group)) +
  geom_line(aes(color = group)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, group = group), alpha = .1)+
  geom_point() +
  labs(x = "Water Year", y = "Predicted", title = "Summer Avg Mean Temp") + 
   theme_minimal()
```

Notes 
* QQ Plot does not look good

### Conclusions

* Month: 
* Region: 
* Year: 


**Back to questions**

1. Do summer temperatures (mean, max, min) increase over time?
* Mean: not clear difference - high in 2015
2. Are there notable differences in how summer temperatures change by region? 
* Higher temps in Sac River
3. Are there certain months where temperature increases more over time? 
* June lowest

### Conclusions:

    


