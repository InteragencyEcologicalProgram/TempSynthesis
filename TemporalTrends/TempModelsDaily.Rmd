---
title: "Daily Models"
author: "Catarina Pien"
date: "2/2/2021"
output: html_document
---

# Daily Temperature Trend Models {.tabset}
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
library(viridis) # color palette
library(plotly) # interactive plots
library(pscl) # glm
library(visreg) # visualize model results
library(lattice)
library(lme4) # glmm
library(lmerTest) #glmm p values
library(plotly)
library(ggeffects)
```

Read in data
```{r read}
setwd("C:/Users/cpien/OneDrive - California Department of Water Resources/Work/ClimateChange/R_code/TempSynthesis/")

# tempFilt <- readRDS("Data/tempFilt.rds") 
# tempToUse <- readRDS("Data/temp10years_20200922.rds")
# tempAn <- readRDS("Data/tempAnnual.rds")
# tempMon <- readRDS("Data/tempMonthly.rds")
tempDaily <- readRDS("Data/tempDaily.rds")
# tempHeat <- readRDS("Data/heatstressDaily.rds")
```

Add Season; Filter and alter variables
```{r filterVars}
tempDaily$Month <- month(tempDaily$Date)
tempDaily$Year <- year(tempDaily$Date)
tempDaily <- tempDaily %>%
  mutate(Season = ifelse(Month %in% c(12, 1, 2), "Winter", 
                         ifelse(Month %in% c(3,4,5), "Spring", 
                                ifelse(Month %in% c(6,7,8), "Summer",
                                       "Fall"))))
tempDaily$Season <- factor(tempDaily$Season, levels = c("Spring", "Summer", "Fall", "Winter"))
tempDaily$WY <- as.numeric(tempDaily$WY)
tempDaily$fWY <- factor(tempDaily$WY)
tempDaily$fMonth <- factor(tempDaily$Month, levels = c("11", "12", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10"))
tempDaily$fYear <- factor(tempDaily$Year)
tempDaily <- filter(tempDaily, WY > 2008 & WY < 2020)
tempDaily <- left_join(tempDaily, nMon) %>%
  filter(nMon == 12)
tempDaily$yday <- yday(tempDaily$Date)


#try a sine-transformation on "month" so we can include it in linear models
tempDaily$sMonth = sin(pi*tempDaily$Month/12)
tempDaily$syday = sin(pi*tempDaily$yday/365)

```

## Monthly Max Temps  
**Scientific Questions:**

1. Has maximum temperature increased over time?
2. Are there regional trends in maximum temperature increase? 
3. Do we see differences in max temp by water year type? (e.g. cooler summer temps in wet years)

**Questions for Rosie:**    

- It feels like what I am primarily interested in is: 
  (max,min,mean,range)Temp ~ WY(or year) + Region (+ WYType), with a recognition of the importance of yday, month or season
  - However, I cannot have WY and WYType in the same model, right?
  - Instead, include WYType + Year (instead of WY)?
  - When I leave WY as numeric, it comes out significant, but is this accurate? Or is it better to have it as a factor, and say "the last 5 years are higher based on slope?"

- Random variables
  - We talked about putting year as random variable. Does our question then become is there a difference in mean temp by region, wytype, time of year? Or what does the question really become? Confused what we are asking when we are using only categorical variables, and if this is useful. 
  - Can I include region in my model but also have Station as a random variable (aka nested random variable within fixed variable)? 
  - We don't really care about month, season specifically, unless there is an interaction of some sort (e.g. we can detect trends for certain months), so should this be a random variable?
  - How to incorporate random variables correctly (e.g. nested? crossed? syntax?)
  - Random variable interactions. Random effects, random intercept, random intercept plus slope models
  - Correlation structure
  - method = REML or ML

- Does it make sense to order the factors somehow for intercept and model interpretation? (aka lowest or highest variable first)

- How to interpret output
  - Reminder of interpreting parameters vs interactions
  - Are we looking at how rate of change of temp differs by season (or is this only if we have an interaction between year:season), or just how temp differs by season? E.g. a low winter coefficient just indicates that there are lower temps in the winter, not that the change in temp is lower for winter?
  - How do I plot this in a way to see the model differences by category?
  - How do I plot categorical variables in a useful way?
  - How to compare mixed models (Still AIC?) Look at Zuur
    - Start with as many variables as relevant. 1. Figure out random structure, 2. Figure out fixed structure, 3. Compare models with the same random but different fixed structures
    - AIC(), anova()
    - Try random intercept, random intercept slope
  - What do I say about the random effects? 

- Checking models for assumptions
  - Normalized residuals based on REML fit
    - Residuals vs fitted values (homogeneity)
    - Plot residuals against each explanatory variable
- Seasonal/daily decomposition to look at trends?

**Other thoughts**    

- Change regions based on dendrogram? 
- Change regions based on how they group together in results?

```{r monthlyMaxPlot}
# Monthly Trends
max1 <- ggplot(tempDaily) + 
  geom_jitter(aes(x = WY, y = maxAvTemp, color = fMonth), size = .7)+
  stat_smooth(aes(x = WY, y = maxAvTemp, color = fMonth),method = "lm", formula = y ~ x, size = 1, se = TRUE)+ 
  labs(title = "Average maximum temperature by month") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
ggplotly(max1)

# Regional Trends
max2 <- ggplot(tempDaily) + 
  geom_jitter(aes(x = WY, y = maxAvTemp, color = Region), size = .7)+
  stat_smooth(aes(x = WY, y = maxAvTemp, color = Region),method = "lm", formula = y ~ x, size = 1, se = FALSE)+ 
  labs(title = "Average maximum temperature by Region") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14))
ggplotly(max2)

```

### Look at interaction potential
* Month * WYType: yes
* Month * Region: yes
* Region * WYType: no
* Season * WYType: no
* Season * Region: no
```{r InteractionsPlotsMax}
# WYType:Month
# WY type trend differs by Month

ggplot(tempDaily) + 
  geom_point(aes(x = Month, y = maxAvTemp, color = WYType2_Sac)) + 
  stat_smooth(aes(x = Month, y = maxAvTemp, color = WYType2_Sac),method = "lm", formula = y ~ x + I(x^2), size = 2, se = TRUE)+ 
  labs(title = "WYType:Month") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + theme_bw()

#see what it looks like with the sin-transformed month
ggplot(tempDaily) + 
  geom_point(aes(x = sMonth, y = maxAvTemp, color = WYType2_Sac)) + 
  stat_smooth(aes(x = sMonth, y = maxAvTemp, color = WYType2_Sac),method = "lm", size = 2, se = TRUE)+ 
  labs(title = "WYType:Month with sin-transformation") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:Month
# Regional trend seems to differ by Month
ggplot(tempDaily) + 
  geom_point(aes(x = Month, y = maxAvTemp, color = Region)) + 
  stat_smooth(aes(x = Month, y = maxAvTemp, color = Region),method = "lm", formula = y ~ x + I(x^2), size = 2, se = TRUE)+ 
    labs(title = "Region:Month") +
  scale_color_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:WYType
ggplot(tempDaily) + 
  geom_boxplot(aes(x = Region, y = maxAvTemp, fill = WYType2_Sac)) + 
    labs(title = "Region:WYType") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# WYType:Season
# Not much difference... Spring lower maxAvTemp in the wet season, maybe slightly lower min in mid and wet years, other seasons look pretty similar. 
ggplot(tempDaily) + 
  geom_boxplot(aes(x = WYType2_Sac, y = maxAvTemp, fill= Season)) +
    labs(title = "WYType:Season") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()

# Region:Season
# Not anything too significant
ggplot(tempDaily) + 
  geom_boxplot(aes(x = Region, y = maxAvTemp, fill = Season)) + 
    labs(title = "Region:Season") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) + theme_bw()
```

Models 

* Interested in individual years so removed WY Type and focusing on factor(WY)

```{r Models Max Monthly Temp}

summary(M.max1 <- glm(maxAvTemp~Region + Month + I(Month^2) + fWY, data = tempDaily))
summary(M.max2 <- glm(maxAvTemp~Region + sMonth + fWY, data = tempDaily))
summary(M.max3 <- glm(maxAvTemp~Region + Season + fWY , data = tempDaily))
AIC(M.max1, M.max2, M.max3)

```

Proceed with quadratic Month as AIC lowest

```{r}
# Interactions?

summary(M.max5 <- glm(maxAvTemp~Region + Month + I(Month^2) + fWY + fWY:Region, data = tempDaily))

summary(M.max6 <- glm(maxAvTemp~Region + Month + I(Month^2) + fWY + fWY:Region + fWY:(Month + I(Month^2)), data = tempDaily))

summary(M.max7 <- glm(maxAvTemp~Region + Month + I(Month^2) + fWY + Region:(Month + I(Month^2)), data = tempDaily))

# Season
summary(M.max8 <- glm(maxAvTemp~Region + Season + fWY + fWY:Region + fWY:Season, data = tempDaily))

# Month
summary(M.max4 <- glm(maxAvTemp~Region + Month + I(Month^2) + fWY + fWY:(Month + I(Month^2)), data = tempDaily))

AIC(M.max1, M.max4, M.max5, M.max6, M.max7, M.max8)
```

Chosen Model: **(M.max4 <- glm(maxAvTemp~Region + Month + I(Month^2) + fWY + fWY:(Month + I(Month^2)), data = tempDaily))**

```{r}
par(mfrow = c(2,2))
plot(M.max4)

res.mmax1 = resid(M.max4, type = "pearson")
plot(res.mmax1)
plot(tempDaily$Month, res.mmax1)
plot(tempDaily$Region, res.mmax1)
plot(tempDaily$fWY, res.mmax1)

visreg(M.max4, "fWY", by = "Region")
visreg(M.max4, "Month", by = "Region")
visreg(M.max4, "Region", by = "Month")
visreg(M.max4, "fWY", by = "Month")
```

### Mixed Model - Station as random factor

```{r glmmmax}
summary(M.max1a <- lmer(maxAvTemp~Region + Month + I(Month^2) + fWY + fWY:(Month + I(Month^2)) + (1|Station), data = tempDaily, na.action = na.omit))

summary(M.max2a <- lmer(maxAvTemp~Region + Season + fWY + fWY:Season+ (1|Station), data = tempDaily, na.action = na.omit))

AIC(M.max1a, M.max2a)
```

Best Model: **M.max1a <- lmer(maxAvTemp~Region + Month + I(Month^2) + fWY + fWY:(Month + I(Month^2)) + (1|Station), data = tempDaily, na.action = na.omit))**

```{r}
# Using month
par(mfrow = c(2,3))

res.mmax2 = resid(M.max1a, type = "pearson")
lev1a = hatvalues(M.max1a)
plot(M.max1a)
qqnorm(resid(M.max1a))
qqline(resid(M.max1a))
plot(lev1a, y = res.mmax2)

plot(res.mmax2)
plot(tempDaily$Month, res.mmax2)
plot(tempDaily$Region, res.mmax2)
plot(tempDaily$fWY, res.mmax2)


# Using season
par(mfrow = c(2,3))

res.mmax3 = resid(M.max2a, type = "pearson")
lev2a = hatvalues(M.max2a)
plot(M.max2a)
qqnorm(resid(M.max2a))
qqline(resid(M.max2a))
plot(lev2a, y = res.mmax3)

plot(res.mmax3)
plot(tempDaily$Season, res.mmax3)
plot(tempDaily$Region, res.mmax3)
plot(tempDaily$fWY, res.mmax3)
```

### Conclusions

* Month: Summer>Fall>Spring>Winter
* Region: San Joaquin, South higher max temps
* Year: 