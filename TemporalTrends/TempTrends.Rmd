---
title: "TempTrends"
author: "Catarina Pien"
date: "8/3/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---
# Temperature Trends {.tabset}
This code explores temporal trends existing in the integrated temperature dataset.


## Preparation 
```{r import, include = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(lubridate)
library(viridis) # color palette
library(plotly)

tempFilt0 <- readRDS("Data/Temp_filtered.rds")
RegionsEDSM <- read.csv("Data/Station_groupings_5AUG2020.csv")
Regions <- read.csv("Data/Stations_wRosiesReg.csv")
staInfo <- read.csv("Data/StationsMetadata.csv")

str(tempFilt0)
```

#### Variable editing
```{r vars}
tempFilt0 <- tempFilt0 %>%
  mutate(Year = year(tempFilt0$Date),
         Month = month(tempFilt0$Date),
         yDay = yday(tempFilt0$Date))
```

#### Merge station info
#### Merge regions
```{r regions, message = FALSE, warning = FALSE}
# subregions <- st_read("Data/EDSM_Subregions/EDSM_Subregions_03302020.shp")

tempFilt <- left_join(tempFilt0, Regions, by = "Station") %>%
  filter(!Station %in% c("CNT", "CPP", "DAR", "DMC", "DYR","ECD", "HBP", "ROR", "DV7"),
         !is.na(Region)) 

```

## Mean, max, min, variance temperatures {.tabset}

### Heatmaps
* Create dataset for mean, max, and min, var for Monthly
* Filter for data that is represented for a whole year
* Create dataset for mean, max, min, var for Annual
```{r meanmaxmin, message = FALSE, warning = FALSE}
tempMon <- tempFilt %>% 
  group_by(Region, Station, Year, Month) %>%
  summarize(maxTemp = max(Temp),
            minTemp = min(Temp),
            meanTemp = round(mean(Temp),1),
            sdTemp = round(sd(Temp),1))

# Filter to only data that has temps from every month so as not to skew the data that only has part of the year represented.
nMon <- tempMon %>% group_by(Station, Year) %>%
  summarize (nMon = n())

tempAn <- left_join(tempFilt, nMon, by = c("Station", "Year")) %>%
  filter(nMon == 12) %>%
  group_by(Station, Year) %>%
  summarize(maxTempAn = max(Temp),
            minTempAn = min(Temp),
            meanTempAn = round(mean(Temp),1),
            varTempAn = round(sd(Temp),1))

```

##### Function for plotting heatmaps
```{r plotfunctions}
heatmapplot <-  function(data,fill, temp, l1, l2) {
    fill <- enquo(fill)
    temp <- enquo(temp)
  p <- data %>%
    ggplot(mapping = aes(Year, Station, fill = !! fill,
                         text = paste("Station:", Station, "\nTemp:", !! temp, "\nYear:", Year)
                         )) +
    geom_tile() +
      scale_fill_viridis(option = "cividis", limits = c(l1,l2)) + theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title = element_text(size = 12))
  ggplotly(p, tooltip = "text") 
}  

heatmapplotVar <-  function(data, fill, var, l1, l2) {
    fill <- enquo(fill)
    var <- enquo(var)
  p <- data %>%
    ggplot(mapping = aes(Year, Station, fill = !! fill,
                         text = paste("Station:", Station, "\nVariation:", !! var, "\nYear:", Year)
                         )) +
    geom_tile() +
      scale_fill_viridis(option = "cividis", limits = c(l1,l2)) + theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title = element_text(size = 12))
  ggplotly(p, tooltip = "text") 
}  

heatmapplotDays <-  function(data, fill, days, l1, l2) {
    fill <- enquo(fill)
    days <- enquo(days)
  p <- data %>%
    ggplot(mapping = aes(Year, Station, fill = !! fill,
                         text = paste("Station:", Station, "\nHeatStressDays:", !! days, "\nYear:", Year)
                         )) +
    geom_tile() +
      scale_fill_viridis(option = "magma", limits = c(l1,l2)) + theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title = element_text(size = 12))
  ggplotly(p, tooltip = "text") 
}  


```

##### Link Regions, Filter into smaller datasets
##### Will probably change this later to reflect regions we choose. 
```{r filter regions}
# Split into regions? 
# Test
unique(tempFilt$Region)
stations <- unique(Regions$Station)

staFNorth0 <- filter(Regions, Region == "Far North") 
staFNorth <- unique(staFNorth0$Station)

staND0 <- filter(Regions, Region == "North Delta") 
staND <- unique(staND0$Station)

staSacR0 <- filter(Regions, Region == "Sac River")
staSacR <- unique(staSacR0$Station)

staSJ0 <- filter(Regions, Region == "San Joaquin") 
staSJ <- unique(staSJ0$Station)

staSouth0 = filter(Regions, Region == "South")
staSouth <- unique(staSouth0$Station)

staSM0 = filter(Regions, Region == "Suisun Marsh")
staSM <- unique(staSM0$Station)

staSB0 = filter(Regions, Region == "Suisun Bay")
staSB <- unique(staSB0$Station)
```

#### Heat map for maximum temps
* We have the absolute temperatures, and then standardized by Year and Station.

```{r heatmapMax, message = FALSE, warning = FALSE}
maxTemps <- tempAn %>%
  filter(!is.na(maxTempAn)) %>%
  ungroup() %>%
  dplyr::select(c(Year, Station, maxTempAn)) %>%
  group_by(Station) %>%
  mutate(maxTempAn_yr = scale(maxTempAn)) %>%
  ungroup %>%
  group_by(Year) %>%
  mutate(maxTempAn_sta = scale(maxTempAn)) %>%
  ungroup()

# Smaller datasets
maxAn1 <- filter(maxTemps, Station %in% staFNorth) 
maxAn2 <- filter(maxTemps, Station %in% staND)
maxAn3 <- filter(maxTemps, Station %in% staSacR)
maxAn4 <- filter(maxTemps, Station %in% staSJ)
maxAn5 <- filter(maxTemps, Station %in% staSouth) 
maxAn6 <- filter(maxTemps, Station %in% staSB)
maxAn7 <- filter(maxTemps, Station %in% staSM)

##### Heat maps (absolute values)
maxAn1$Year <- ordered(maxAn1$Year)
maxAn2$Year <- ordered(maxAn2$Year)
maxAn3$Year <- ordered(maxAn3$Year)
maxAn4$Year <- ordered(maxAn4$Year)
maxAn5$Year <- ordered(maxAn5$Year)
maxAn6$Year <- ordered(maxAn6$Year)
maxAn7$Year <- ordered(maxAn7$Year)

# List of mean datasets
max.df.list <- list(maxAn1, maxAn2, maxAn3, maxAn4, maxAn5, maxAn6, maxAn7, maxTemps)

# Limits determined by looking at the data, but probably a way to code in min() and max()
# Absolute temperature
lapply(max.df.list, heatmapplot, fill = maxTempAn, temp = maxTempAn, l1 = 19, l2 = 35)

##### Scaled heatmaps
# By station
lapply(max.df.list, heatmapplot, fill = maxTempAn_sta, temp = maxTempAn, l1 = -4.1, l2 = 4.1)
# By year
lapply(max.df.list, heatmapplot, fill = maxTempAn_yr, temp = maxTempAn, l1 = -4.1, l2 = 4.1)

```
##### Hot stations: LIS, CCS, FLT, BLL, GLC
##### Hotter max temp years: 2006, 2013, 2017, 2019


#### Heat map for mean temps
* We have the absolute temperatures, and then standardized by Year and Station.

```{r heatmapMean}
meanTemps <- tempAn %>%
  filter(!is.na(meanTempAn)) %>%
  ungroup() %>%
  dplyr::select(c(Year, Station, meanTempAn)) %>%
  group_by(Station) %>%
  mutate(meanTempAn_yr = scale(meanTempAn)) %>%
  ungroup %>%
  group_by(Year) %>%
  mutate(meanTempAn_sta = scale(meanTempAn)) %>%
  ungroup()

# Smaller datasets
meanAn1 <- filter(meanTemps, Station %in% staFNorth) 
meanAn2 <- filter(meanTemps, Station %in% staND) 
meanAn3 <- filter(meanTemps, Station %in% staSacR) 
meanAn4 <- filter(meanTemps, Station %in% staSJ) 
meanAn5 <- filter(meanTemps, Station %in% staSouth) 
meanAn6 <- filter(meanTemps, Station %in% staSB) 
meanAn7 <- filter(meanTemps, Station %in% staSM) 

##### Heat maps (absolute values)
meanAn1$Year <- ordered(meanAn1$Year)
meanAn2$Year <- ordered(meanAn2$Year)
meanAn3$Year <- ordered(meanAn3$Year)
meanAn4$Year <- ordered(meanAn4$Year)
meanAn5$Year <- ordered(meanAn5$Year)
meanAn6$Year <- ordered(meanAn6$Year)
meanAn7$Year <- ordered(meanAn7$Year)

# List of mean datasets
mean.df.list <- list(meanAn1, meanAn2, meanAn3, meanAn4, meanAn5, meanAn6, meanAn7, meanTemps)

# Absolute temperature
lapply(mean.df.list, heatmapplot, fill = meanTempAn, temp = meanTempAn, l1 = 12, l2 = 20)

##### Scaled heatmaps
# By station
lapply(mean.df.list, heatmapplot, fill = meanTempAn_sta, temp = meanTempAn, l1 = -4.6, l2 = 4.5)
# By year
lapply(mean.df.list, heatmapplot, fill = meanTempAn_yr, temp = meanTempAn, l1 = -3, l2 = 3)

```
* Hot stations: LIS, most of the South Delta
* Hot years: 2014-2016
* Cool years: 2011

### Heat map for min temps
```{r heatmapMin}
minTemps <- tempAn %>%
  filter(!is.na(minTempAn)) %>%
  ungroup() %>%
  dplyr::select(c(Year, Station, minTempAn)) %>%
  group_by(Station) %>%
  mutate(minTempAn_yr = scale(minTempAn)) %>%
  ungroup %>%
  group_by(Year) %>%
  mutate(minTempAn_sta = scale(minTempAn)) %>%
  ungroup()

# Smaller datasets
minAn1 <- filter(minTemps, Station %in% staFNorth) 
minAn2 <- filter(minTemps, Station %in% staND) 
minAn3 <- filter(minTemps, Station %in% staSacR) 
minAn4 <- filter(minTemps, Station %in% staSJ) 
minAn5 <- filter(minTemps, Station %in% staSouth) 
minAn6 <- filter(minTemps, Station %in% staSB) 
minAn7 <- filter(minTemps, Station %in% staSM) 

# Smaller datasets
minAn1$Year <- ordered(minAn1$Year)
minAn2$Year <- ordered(minAn2$Year)
minAn3$Year <- ordered(minAn3$Year)
minAn4$Year <- ordered(minAn4$Year)
minAn5$Year <- ordered(minAn5$Year)
minAn6$Year <- ordered(minAn6$Year)
minAn7$Year <- ordered(minAn7$Year)

# List of min datasets
min.df.list <- list(minAn1, minAn2, minAn3, minAn4, minAn5, minAn6, minAn7, minTemps)

# Absolute temperature
lapply(min.df.list, heatmapplot, fill = minTempAn, temp = minTempAn, l1 = 1.5, l2 = 10)

##### Scaled heatmaps
# By station
lapply(min.df.list, heatmapplot, fill = minTempAn_sta, temp = minTempAn, l1 = -5.7, l2 = 5.7)
# By year
lapply(min.df.list, heatmapplot, fill = minTempAn_yr, temp = minTempAn, l1 = -3.5, l2 = 3.5)

```
##### Warmer min temp stations: FLT and CCS are especially cool - check to make sure these values are acurate? 
##### Warmer min temp years: 2010, 2018

### Heat maps for sd
```{r heatmapSD}
varTemps <- tempAn %>%
  filter(!is.na(varTempAn)) %>%
  ungroup() %>%
  dplyr::select(c(Year, Station, varTempAn)) %>%
  group_by(Station) %>%
  mutate(varTempAn_yr = scale(varTempAn)) %>%
  ungroup %>%
  group_by(Year) %>%
  mutate(varTempAn_sta = scale(varTempAn)) %>%
  ungroup()

# Smaller datasets
varAn1 <- filter(varTemps, Station %in% staFNorth) 
varAn2 <- filter(varTemps, Station %in% staND) 
varAn3 <- filter(varTemps, Station %in% staSacR) 
varAn4 <- filter(varTemps, Station %in% staSJ) 
varAn5 <- filter(varTemps, Station %in% staSouth) 
varAn6 <- filter(varTemps, Station %in% staSB) 
varAn7 <- filter(varTemps, Station %in% staSM) 

# Ordered
varAn1$Year <- ordered(varAn1$Year)
varAn2$Year <- ordered(varAn2$Year)
varAn3$Year <- ordered(varAn3$Year)
varAn4$Year <- ordered(varAn4$Year)
varAn5$Year <- ordered(varAn5$Year)
varAn6$Year <- ordered(varAn6$Year)
varAn7$Year <- ordered(varAn7$Year)

# List of var datasets
var.df.list <- list(varAn1, varAn2, varAn3, varAn4, varAn5, varAn6, varAn7, varTemps)

# Absolute temperature
lapply(var.df.list, heatmapplotVar, fill = varTempAn, var = varTempAn, l1 = 2, l2 = 7)

##### Scaled heatmaps
# By station
lapply(var.df.list, heatmapplotVar, fill = varTempAn_sta, var = varTempAn, l1 = -4.5, l2 = 4.5)
# By year
lapply(var.df.list, heatmapplotVar, fill = varTempAn_yr, var = varTempAn, l1 = -3, l2 = 3)
```
##### Greater sd: Stations: RSL, FLT, LIS, most of south delta
##### Years: 2013, 2011, 2019

### Heat maps for mean annual summer temperature (June - Sept)
```{r summerMean}
tempSum <- tempFilt %>% 
  group_by(Region, Station, Year, Month) %>%
  filter(Month > 5 & Month < 10)%>%
  summarize(meanTemp = round(mean(Temp),1),
            sdTemp = round(sd(Temp),1))

# Filter to only data that has temps from every month so as not to skew the data that only has part of the year represented.

nMonSum <- tempSum %>% group_by(Station, Year) %>%
  summarize (nMon = n())

tempSumAll <- left_join(tempFilt, nMonSum, by = c("Station", "Year")) %>%
  filter(nMon == 4) %>%
  group_by(Station, Year) %>%
  summarize(meanTempSum = round(mean(Temp),1),
            varTempSum = round(sd(Temp),1))

# Calculate scaled values for year and station
meanSum <- tempSumAll %>%
  filter(!is.na(meanTempSum)) %>%
  ungroup() %>%
  dplyr::select(c(Year, Station, meanTempSum)) %>%
  group_by(Station) %>%
  mutate(meanTempSum_yr = scale(meanTempSum)) %>%
  ungroup %>%
  group_by(Year) %>%
  mutate(meanTempSum_sta = scale(meanTempSum)) %>%
  ungroup()

# Smaller datasets
meanSum1 <- filter(meanSum, Station %in% staFNorth) 
meanSum2 <- filter(meanSum, Station %in% staND) 
meanSum3 <- filter(meanSum, Station %in% staSacR) 
meanSum4 <- filter(meanSum, Station %in% staSJ) 
meanSum5 <- filter(meanSum, Station %in% staSouth) 
meanSum6 <- filter(meanSum, Station %in% staSB) 
meanSum7 <- filter(meanSum, Station %in% staSM) 

##### Heat maps (absolute values)
meanSum1$Year <- ordered(meanSum1$Year)
meanSum2$Year <- ordered(meanSum2$Year)
meanSum3$Year <- ordered(meanSum3$Year)
meanSum4$Year <- ordered(meanSum4$Year)
meanSum5$Year <- ordered(meanSum5$Year)
meanSum6$Year <- ordered(meanSum6$Year)
meanSum7$Year <- ordered(meanSum7$Year)

# List of mean datasets
meanSum.df.list <- list(meanSum1, meanSum2, meanSum3, meanSum4, meanSum5, meanSum6, meanSum7, meanSum)

# Absolute temperature
lapply(meanSum.df.list, heatmapplot, fill = meanSum, temp = meanSum, l1 = 14, l2 = 22)

##### Scaled heatmaps
# By station
lapply(mean.df.list, heatmapplot, fill = meanSum_sta, temp = meanSum, l1 = -4.7, l2 = 4.7)
# By year
lapply(mean.df.list, heatmapplot, fill = meanSum_yr, temp = meanSum, l1 = -4, l2 = 4)
```


### Heat maps for min annual summer temperature (June - Sept)
```{r summerMin}
tempSumMin <- tempFilt %>% 
  group_by(Region, Station, Year, Month) %>%
  filter(Month > 5 & Month < 10)%>%
  summarize(minTemp = round(min(Temp),1),
            sdTemp = round(sd(Temp),1))

# Filter to only data that has temps from every month so as not to skew the data that only has part of the year represented.

nMonMinSum <- tempSumMin %>% group_by(Station, Year) %>%
  summarize(nMon = n()) %>%
  ungroup()

tempSumAll <- left_join(tempFilt, nMonMinSum, by = c("Station", "Year")) %>%
  filter(nMon == 4) %>%
  group_by(Station, Year) %>%
  summarize(minTempSum = round(min(Temp),1),
            varTempSum = round(sd(Temp),1))

# Calculate scaled values for year and station
minSum <- tempSumAll %>%
  filter(!is.na(minTempSum)) %>%
  ungroup() %>%
  dplyr::select(c(Year, Station, minTempSum)) %>%
  group_by(Station) %>%
  mutate(minTempSum_yr = scale(minTempSum)) %>%
  ungroup %>%
  group_by(Year) %>%
  mutate(minTempSum_sta = scale(minTempSum)) %>%
  ungroup()


# Smaller datasets
minSum1 <- filter(minSum, Station %in% staFNorth) 
minSum2 <- filter(minSum, Station %in% staND) 
minSum3 <- filter(minSum, Station %in% staSacR) 
minSum4 <- filter(minSum, Station %in% staSJ) 
minSum5 <- filter(minSum, Station %in% staSouth) 
minSum6 <- filter(minSum, Station %in% staSB) 
minSum7 <- filter(minSum, Station %in% staSM) 

##### Heat maps (absolute values)
minSum1$Year <- ordered(minSum1$Year)
minSum2$Year <- ordered(minSum2$Year)
minSum3$Year <- ordered(minSum3$Year)
minSum4$Year <- ordered(minSum4$Year)
minSum5$Year <- ordered(minSum5$Year)
minSum6$Year <- ordered(minSum6$Year)
minSum7$Year <- ordered(minSum7$Year)

# List of min summer datasets
minSum.df.list <- list(minSum1, minSum2, minSum3, minSum4, minSum5, minSum6, minSum7, minSum)

# Absolute temperature
lapply(minSum.df.list, heatmapplot, fill = minTempSum, temp = minTempSum, l1 = 1, l2 = 15)

##### Scaled heatmaps
# By station
lapply(minSum.df.list, heatmapplot, fill = minTempSum_sta, temp = minTempSum, l1 = -5.2, l2 = 5.2)
# By year
lapply(minSum.df.list, heatmapplot, fill = minTempSum_yr, temp = minTempSum, l1 = -3.3, l2 = 3.3)

```

### GLM
#### Effect of Region, Month, Year on Maximum Temperature 
```{r glm max temps}
library(pscl)
library(visreg)
library(lattice)

tempSimp <- tempFilt %>%
  select(c(Station, Year, Month, Temp, Region)) %>% 
  filter(Year > 2000)
tempSimp2 <- distinct(tempSimp)

maxJoin <- maxTemps %>%
  rename(Temp = maxTempAn)

maxT <- left_join(maxJoin, tempSimp2)
m1 <- glm(Temp~Year*Region + Month, data = maxT)
summary(m1)

par(mfrow = c(2,2))
plot(m1)
visreg(m1)
visreg(m1, "Year", by = "Region")
par(mfrow = c(1,1))
visreg(m1, "Year", by = "Region", overlay = "TRUE")

m2 <- glm(Temp~Year*Region + Region*Month, data = maxT)
summary(m2)

par(mfrow = c(2,2))
plot(m2)
visreg(m2)
visreg(m2, "Year", by = "Region")
par(mfrow = c(1,1))
visreg(m2, "Year", by = "Region", overlay = "TRUE")

m3 <- glm(Temp~Year*Region, data = maxT)
summary(m3)

AIC(m1, m2, m3)
```

#### Effect of Region, Year on Annual Variation (standard deviation)
```{r glm sd}
tempSimp3 <- tempSimp2 %>% select(-Temp)
tempSimp4 <- unique(tempSimp3)
sdJoin <- left_join(varTemps, tempSimp4) %>%
  select(c(Station, Year, Region, varTempAn)) %>%
  rename(Var = varTempAn)

# Data used for model
varT <- unique(sdJoin)

var1 <- glm(Var ~ Year*Region, data = varT)
summary(var1)
par(mfrow = c(2,2))
plot(var1)
visreg(var1, "Year", by = "Region")

```

##### Not sure why "Region" is just plotting three years?
##### Significant effect of year, with greatest increase in variation by year in North, then South, then West.

#### Effect of Region, Year on Mean Summer Temperature
```{r glm mean summer temps}

meanJoin <- left_join(meanSum, tempSimp4) %>%
  select(c(Station, Year, Region, meanTempSum)) %>%
  rename(Temp = meanTempSum) %>%
  mutate(Year2 = ordered(Year))

# Data used for model
meanT <- unique(meanJoin)

mean1 <- glm(Temp ~ Year*Region, data = meanT)
summary(mean1)
plot(mean1)
visreg(mean1, "Year", by = "Region")

```
##### Significant effect of year, with greatest increase in mean temp in the South, followed by North, followed by West.

#### Effect of Region, Year on Min Summer Temperature 
```{r glm min summer temps}
minJoin <- left_join(minSum, tempSimp4) %>%
  select(c(Station, Year, Region, minTempSum)) %>%
  rename(Temp = minTempSum)

# Data used for model
minT <- unique(minJoin)

min1 <- glm(Temp ~ Year*Region, data = minT)
summary(min1)
plot(min1)
visreg(min1, "Year", by = "Region")
visreg(min1, "Region", by = "Year")
```
##### Significant effect of year, with greatest increase in min temperature in the North, similar trend in South, significantly lower increase in the West.

## Stress Levels
##### Calculate number of days per year at each stress level
```{r heatevents}
maxDaily <- tempFilt %>%
  group_by(Region, Station, Year, Month, Date) %>%
  summarize(maxT = max(Temp))

# Flagging starting on Day 3 of high/med temps   
heat <- maxDaily %>%
  group_by(Region, Station) %>%
  mutate(Thr25 = ifelse(maxT > 25, 1L, 0L),
         Thr21 = ifelse(maxT > 21, 1L, 0L)) %>%
  mutate(Stress = ifelse(Thr25 == lag(Thr25, 1) & Thr25 == lag(Thr25, 2) & Thr25 == 1L, "High", 
                            ifelse(Thr21 == lag(Thr21, 1) & Thr21 == lag(Thr21, 2) & Thr21 == 1, "Med", 
                                   "Low"))) %>%
  select(-starts_with("Thr"))


# Calculate number of days at heat levels 
heatDaysSamp <- heat %>%
  group_by(Region, Station, Year) %>%
  summarize(total = n()) 
  
heatDays <- heat %>%
  group_by(Region, Station, Year, Stress) %>%
  summarize(ndays = n()) %>%
  left_join(heatDaysSamp) %>%
  mutate(propDays = round(ndays/total,3))
```

#### Heat map 
```{r heatmap highstress}
hdaysComp <- heatDays %>%
  filter(!is.na(Stress)) %>%
  ungroup%>%
  complete(Stress, nesting(Station, Region, Year), fill = list(ndays = 0)) %>%
  arrange(Station, Year, Stress) %>%
  filter(Stress == "High") %>%
  group_by(Station) %>%
  mutate(ndays_yr = scale(ndays)) %>%
  ungroup() %>%
  group_by(Year) %>%
  mutate(ndays_sta = scale(ndays)) %>%
  ungroup()

# Smaller datasets
hdaysComp1 <- filter(hdaysComp, Station %in% staFNorth) 
hdaysComp2 <- filter(hdaysComp, Station %in% staND) 
hdaysComp3 <- filter(hdaysComp, Station %in% staSacR)
hdaysComp4 <- filter(hdaysComp, Station %in% staSJ)
hdaysComp5 <- filter(hdaysComp, Station %in% staSouth) 
hdaysComp6 <- filter(hdaysComp, Station %in% staSB)
hdaysComp7 <- filter(hdaysComp, Station %in% staSM)

##### Heat maps (absolute values)
hdaysComp1$Year <- ordered(hdaysComp1$Year)
hdaysComp2$Year <- ordered(hdaysComp2$Year)
hdaysComp3$Year <- ordered(hdaysComp3$Year)
hdaysComp4$Year <- ordered(hdaysComp4$Year)
hdaysComp5$Year <- ordered(hdaysComp5$Year)
hdaysComp6$Year <- ordered(hdaysComp6$Year)
hdaysComp7$Year <- ordered(hdaysComp7$Year)


# List of min summer datasets
hdaysComp.df.list <- list(hdaysComp1, hdaysComp2, hdaysComp3, hdaysComp4, hdaysComp5, hdaysComp6, hdaysComp7, hdaysComp)

# Absolute temperature
lapply(hdaysComp.df.list, heatmapplotDays, fill = ndays, days = ndays, l1 = 0, l2 = 110)

##### Scaled heatmaps
# By station
lapply(hdaysComp.df.list, heatmapplotDays, fill = ndays_sta, days = ndays, l1 = -1.2, l2 = 5.2)
# By year
lapply(hdaysComp.df.list, heatmapplotDays, fill = ndays_yr, days = ndays, l1 = -2.3, l2 = 5.7)

```
##### More in 2006, 2013, 2017, 2019
##### LIS, CCS, WCI, VCU, RSL, OH4, ORI, MDM, FRP, BAC, FLT

#### How has the proportion of high stress days changed over time? 
```{r glm highstress}
#Proportion at High
heatDaysHigh <- heatDays %>%
  filter(Stress == "High") 

heat1 <- glm(propDays ~ Year*Region, family = binomial, data = heatDaysHigh)

summary(heat1)
par(mfrow = c(2,2))
plot(heat1)
visreg(heat1, "Year", by = "Region")
```
##### Looks like in the South, North, and Far West, proportion of high stress days has potentially increased, but not significantly.

#### Reran model after adding 0 for every year-station combo where there were NO high heat days - not sure if this is the right approach, didn't really change results.
```{r completeHeatHigh}
completeHeat <- heatDays %>%
  filter(!is.na(Stress)) %>%
  ungroup%>%
  complete(Stress, nesting(Station, Region, Year), fill = list(propDays = 0)) %>%
  arrange(Station, Year, Stress)

# Filter for high heat proportions
heatDaysHigh2 <- completeHeat %>%
  filter(Stress == "High") 

# Plot 
ggplot(heatDaysHigh2, aes(x = Year, y = propDays)) + geom_point() + facet_wrap(~Region, scales = "free") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# Model
heat2 <- glm(propDays ~ Year*Region, family = binomial, data = heatDaysHigh2)

summary(heat2)
par(mfrow = c(2,2))
plot(heat2)
visreg(heat2, "Year", by = "Region")

```
##### qqplot needs some work.
##### Increase in proportion of high heat days in the South and Far West, but not significantly.

#### How has the proportion of low stress days changed over time? 
```{r glm lowstress}
heatDaysLow <- heatDays %>%
  filter(Stress == "Low") %>%
  filter(Year > 2000)
lowheat1 <- glm(propDays ~ Year*Region, family = binomial, data = heatDaysLow)
summary(lowheat1)
par(mfrow = c(2,2))
plot(lowheat1)
visreg(lowheat1, "Year", by = "Region")
```
##### Some qqplot issues. 
##### Looks like the proportion of low stress days has decreased in every region, though no significant results. 

#### Reran model after addings 0s in.
```{r completeHeatLow}
# Filter for high heat proportions
heatDaysLow2 <- completeHeat %>%
  filter(Stress == "Low") 

# Plot 
ggplot(heatDaysLow2, aes(x = Year, y = propDays)) + geom_point() + facet_wrap(~Region, scales = "free") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# Model
lowheat2 <- glm(propDays ~ Year*Region, family = binomial, data = heatDaysLow2)

summary(lowheat2)
par(mfrow = c(2,2))
plot(lowheat2)
visreg(lowheat2, "Year", by = "Region")
```
##### Some qqplot issues.
##### Slight decrease in proportion of days in low stress category for all, but not significant in model. Pretty much same as previous.

#### Calculate number of hours per day fish are at each stress temperature, see how proportions change over time? 

