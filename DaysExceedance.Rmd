---
title: "DaysExceedance"
author: "Catarina Pien"
date: "9/8/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

Last updated 10/4/2021 by C. Pien
Calculate days exceedance for temperature suitability based on tolerance and optimum temperatures in species table

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(ggpubr)
library(grid)
library(gridExtra)
```

## Import data
- These datasets were created in TempHeatStress.Rmd based off tempDaily.rds
```{r}
tempToUse <- readRDS("Data/tempToUse_20210811.rds")
tempDaily <- readRDS("Data/tempDaily_20210811.rds")
```


```{r}
# Combine Far North and North Delta
tempRegions <- tempDaily %>%
  mutate(Region = replace(Region, Region == "Far North", "North Delta"))
```

Initial function (don't use)

* Calculate total number of days per year/region in the dataset
* Add up number of days exceeding threshold (maxDaily temperature)
* Divide number of days exceeding threshold by number of days per year and multiply by 365 to get expected ndays
* Summarize min, mean, and max number of days for each region (based on region-year combos)
* Label species and type of threshold


```{r}
# funDaysExceed <- function(species, regions, tolerance, optimum) {
#   daysExceedance <- tempRegions %>%
#     left_join(nStations) %>%
#     group_by(WY, Region) %>%
#     mutate(nDays = n()) %>%
#     ungroup() %>%
#     filter(Region %in% regions) %>%
#     mutate(ExceedTol = ifelse(maxDaily > tolerance, 1L, 0L),
#            ExceedOpt = ifelse(maxDaily > optimum, 1L, 0L)) %>%
#     group_by(WY, Region, nDays, nStation) %>%
#     summarize(daysExceedanceTol = sum(ExceedTol),
#               daysExceedanceOpt = sum(ExceedOpt)) %>%
#     #complete(Region, WY, fill = list(daysExceedanceTol=0, daysExceedanceOpt = 0)) %>%
#     mutate(propPerYearOpt = round(daysExceedanceOpt/nDays,1),
#       daysPerYearTol = round(daysExceedanceTol/nDays/nStation*365,1),
#            daysPerYearOpt = round(daysExceedanceOpt/nDays/nStation*365,1)) %>%
#     ungroup() %>%
#     summarize(propOpt = propPerYearOpt,
#       meanTol = round(mean(daysPerYearTol),1),
#               minTol = min(daysPerYearTol),
#               maxTol = max(daysPerYearTol),
#               meanOpt = round(mean(daysPerYearOpt),1),
#               minOpt = min(daysPerYearOpt),
#               maxOpt = max(daysPerYearOpt)) %>%
#     mutate(Species = species)
# }
```

Calculate the number of stations within each region
```{r}
nStations <- tempRegions %>%
  select(Region,Station) %>%
  unique() %>%
  group_by(Region) %>%
  summarize(nStation = n())

tempRegions2 <- left_join(tempRegions, nStations) %>%
  mutate(Month = month(Date),
         Season = case_when(Month %in% c(1,2,3) ~ "Winter",
                            Month %in% c(4,5,6) ~ "Spring",
                            Month %in% c(7,8,9) ~ "Summer",
                            Month %in% c(10,11,12) ~ "Fall",
                            TRUE~as.character(NA)))
```

## Function for calculating days exceedance

* Filter to regions selected
* For each station-day, compare max daily temp to inputted tolerance and optimum. If in exceedance, assign 1. If not, assign 0.
* For each date, calculate the average number of stations that exceeded tolerance. 
* If more than 30% of stations on a particular day exceeded tolerance or optimum, assign 1. 
* For each WY, sum up the number of days exceeding tolerance
* Calculate over all years the min, mean, and max number of days exceeding thresholds.
* Add species name

```{r}
funDaysExceed <- function(species, lifestage, regions, tolerance, optimum) {
daysExceedance <- tempRegions2 %>%
    # group_by(WY, Region) %>%
    # mutate(nDays = n()) %>%
    # ungroup() 
    filter(Region %in% regions) %>%
    mutate(ExceedTol = ifelse(maxDaily > tolerance, 1L, 0L),
           ExceedOpt = ifelse(maxDaily > optimum, 1L, 0L)) %>%
  group_by(WY, Date) %>%
  summarize(propTol = mean(ExceedTol, na.rm = TRUE),
            propOpt = mean(ExceedOpt, na.rm = TRUE),
            ExceedTol2 = ifelse(propTol > 0.3, 1L, 0L),
            ExceedOpt2 = ifelse(propOpt > 0.3, 1L, 0L)) %>%
  ungroup() %>%
  group_by(WY) %>%
    summarize(daysExceedanceTol = sum(ExceedTol2, na.rm = TRUE),
              daysExceedanceOpt = sum(ExceedOpt2, na.rm = TRUE)) %>%
  ungroup() %>%
  summarize(meanTol = round(mean(daysExceedanceTol, na.rm = TRUE),1),
              minTol = min(daysExceedanceTol, na.rm = TRUE),
              maxTol = max(daysExceedanceTol, na.rm = TRUE),
              meanOpt = round(mean(daysExceedanceOpt, na.rm = TRUE),1),
              minOpt = min(daysExceedanceOpt, na.rm = TRUE),
              maxOpt = max(daysExceedanceOpt, na.rm = TRUE)) %>%
    mutate(Species = species,
           LifeStage = lifestage,
           Tolerance = tolerance,
           Optimum = optimum) %>%
  select(Species, Tolerance, meanTol, minTol, maxTol,
         meanOpt, minOpt, maxOpt, Optimum) 
}
```

Test function
```{r}
tolerance = 23
optimum = 15
species = "Splittail"
regions = r9

test <- funDaysExceed("All", r9, 23, 21)
```

## Calculate days exceedance
```{r}
allreg <- c("North Delta", "South", "San Joaquin", "Suisun Bay", "Suisun Marsh", "Sac River")
salmonReg <- c("North Delta", "South", "San Joaquin", "Suisun Bay", "Sac River")
smelt <- c("North Delta", "San Joaquin", "Suisun Bay", "Suisun Marsh", "Sac River")
r1 <- c("San Joaquin", "Suisun Bay", "Suisun Marsh", "Sac River")
r2 <- c("South", "San Joaquin",  "Sac River")
r3 <- c( "South", "San Joaquin", "Suisun Bay", "Suisun Marsh", "Sac River")
r4 <- c("North Delta", "Suisun Bay", "Suisun Marsh", "Sac River")
r5 <- c("Suisun Marsh", "Sac River")
r6 <- c("North Delta",  "Sac River")
r7 <- c("North Delta",  "San Joaquin", "Sac River")
r8 <- c("North Delta", "South",  "Suisun Bay", "Suisun Marsh", "Sac River")
r9 <- c( "Suisun Bay", "Suisun Marsh", "Sac River")

spltAd<- funDaysExceed("Splittail", NA,  29, 24)
spltL<- funDaysExceed("Splittail", "YOY Large", allreg, 25, 21)
spltS<- funDaysExceed("Splittail","YOY Small", allreg, 26, 22)
issA <- funDaysExceed("Silverside", "Adult", allreg, 31, NA)
issYOY <- funDaysExceed("Silverside", "adult", allreg, 35, NA)
LMB <- funDaysExceed("Largemouth Bass", "Juvenile", allreg, 34, NA)
chAd <- funDaysExceed("Chinook", NA,  salmonReg, 25, 21)
chCo <- funDaysExceed("Chinook", "FR",  salmonReg, 22, 20)
rbt <- funDaysExceed("Rainbow Trout", NA, salmonReg, 22, 20)
dsmA <- funDaysExceed("Delta Smelt", NA, smelt, 27, 20)
wag <- funDaysExceed("Wakasagi", NA, smelt, 29.1, NA)
lfs <- funDaysExceed("Longfin Smelt", NA, smelt, 26.4, 15)
dsmJ <- funDaysExceed("Delta Smelt", "Juvenile", r1, 28, 20)
dsmL <- funDaysExceed("Delta Smelt", "Larvae", r2, 27.6, 20)
lfsY <- funDaysExceed("Longfin Smelt", "YOY", r3, 24.8, 15)
gstA <- funDaysExceed("Green Sturgeon", "Adult", r4, NA, 21)
gstEA <- funDaysExceed("Green Sturgeon", "Early Adult", r5, 23, 15)
gstL <- funDaysExceed("Green Sturgeon", "Larvae", r6, 33.7,19)
stbJ <- funDaysExceed("Striped Bass", "Juvenile", r6, 32, 25)
wstL <- funDaysExceed("White Sturgeon", "Larvae", r7, 25,19)
wstA <- funDaysExceed("White Sturgeon", "Adult", allreg, NA, 21)
wstJ <- funDaysExceed("White Sturgeon", "Juvenile", allreg, NA, 25)
stbA <- funDaysExceed("Striped Bass", "Adult", r8, NA,24)
LivWR <- funDaysExceed("Chinook", "WR", "Sac River", 22, 18.5)
```

Veg
```{r}
egDe <- funDaysExceed("Egeria densa", allreg, 32, 21)
mic <- funDaysExceed("Microcystis", allreg, NA, 19) #not tolerance
corb <- funDaysExceed("Corbicula", allreg, NA, 18) #not tolerance
arund <- funDaysExceed("Arundo", allreg, NA, 24) #not tolerance
hya <- funDaysExceed("Water Hyacinth", salmonReg, 34, 28)
pot <- funDaysExceed("Potamocorbula", r9, 30, 15)
```




## Bind into table
```{r}
# Fish
SpeciesTable <- rbind(chAd, chCo, rbt,
                      spltAd, spltL, spltS, 
                      dsmA, wag, lfs, dsmJ, dsmL, lfsY,
                      gstA, gstEA, gstL,
                      wstL, wstJ, wstA, stbJ, stbA, issA, issYOY, LMB)
SpeciesTable2 <- SpeciesTable %>%
  mutate(meanOpt = replace(meanOpt, is.na(Optimum), NA),
         minOpt = replace(minOpt, is.na(Optimum), NA),
         maxOpt = replace(maxOpt, is.na(Optimum), NA),
         meanTol = replace(meanTol, is.na(Tolerance), NA),
         minTol = replace(minTol, is.na(Tolerance), NA),
         maxTol = replace(maxTol, is.na(Tolerance), NA))

SpeciesLong <- pivot_longer(SpeciesTable2, cols = meanTol:maxOpt, names_to = "Type", values_to = "DaysUnsuitable")


# Veg
InvTable <- rbind(egDe, mic, corb, arund, hya, pot)
InvTable2 <- InvTable %>%
  mutate(meanOpt = replace(meanOpt, is.na(Optimum), NA),
         minOpt = replace(minOpt, is.na(Optimum), NA),
         maxOpt = replace(maxOpt, is.na(Optimum), NA),
         meanTol = replace(meanTol, is.na(Tolerance), NA),
         minTol = replace(minTol, is.na(Tolerance), NA),
         maxTol = replace(maxTol, is.na(Tolerance), NA))

InvLong <- pivot_longer(InvTable2, cols = meanTol:maxOpt, names_to = "Type", values_to = "DaysUnsuitable")

InvLong2 <- InvLong %>%
  filter(Type %in% c("meanTol", "meanOpt")) %>%
  mutate(Suitable = 365-DaysUnsuitable)
```


## Function for calculating days exceedance, no means or sums for boxplot

* Filter to regions selected
* For each station-day, compare max daily temp to inputted tolerance and optimum. If in exceedance, assign 1. If not, assign 0.
* For each date, calculate the average number of stations that exceeded tolerance. 
* If more than 30% of stations on a particular day exceeded tolerance or optimum, assign 1. 
* For each WY, sum up the number of days exceeding tolerance
# Add species name

```{r}
funDaysExceed2 <- function(species,lifestage, regions, tolerance, optimum) {
daysExceedance <- tempRegions2 %>%
    # group_by(WY, Region) %>%
    # mutate(nDays = n()) %>%
    # ungroup() 
    filter(Region %in% regions) %>%
    mutate(ExceedTol = ifelse(maxDaily > tolerance, 1, 0),
           ExceedOpt = ifelse(maxDaily > optimum, 1, 0)) %>%
  group_by(WY, Date) %>%
  summarize(propTol = mean(ExceedTol, na.rm = TRUE),
            propOpt = mean(ExceedOpt, na.rm = TRUE),
            ExceedTol2 = ifelse(propTol > 0.3, 1, 0),
            ExceedOpt2 = ifelse(propOpt > 0.3, 1, 0)) %>%
  ungroup() %>%
  group_by(WY) %>%
    summarize(daysExceedanceTol = sum(ExceedTol2, na.rm = TRUE),
              daysExceedanceOpt = sum(ExceedOpt2, na.rm = TRUE)) %>%
  ungroup() %>%
    mutate(Species = species,
           LifeStage= lifestage,
           Tolerance = tolerance,
           Optimum = optimum) %>%
  select(WY, Species, LifeStage, Tolerance, daysExceedanceTol, daysExceedanceOpt, Optimum) 
}
```

```{r}
spltAd2<- funDaysExceed2("Splittail", "Adult", allreg, 29, 24)
spltL2<- funDaysExceed2("Splittail", "YOY Large", allreg, 25, 21)
spltS2<- funDaysExceed2("Splittail","YOY Small", allreg, 26, 22)
issA2 <- funDaysExceed2("Silverside", "Adult", allreg, 31, NA)
issYOY2 <- funDaysExceed2("Silverside", "Adult", allreg, 35, NA)
LMB2 <- funDaysExceed2("Largemouth Bass", "Juvenile", allreg, 34, NA)
chAd2 <- funDaysExceed2("Chinook", "Adult",  salmonReg, 25, 21)
chCo2 <- funDaysExceed2("Chinook", "Juvenile FR",  salmonReg, 22, 20)
LivWR2 <- funDaysExceed2("Chinook", "Juvenile WR", "Sac River", 22, 18.5)
rbt2 <- funDaysExceed2("Rainbow Trout", "Juvenile", salmonReg, 22, 20)
dsmA2 <- funDaysExceed2("Delta Smelt", "Adult", smelt, 27, 20)
dsmJ2 <- funDaysExceed2("Delta Smelt", "Juvenile", r1, 28, 20)
dsmL2 <- funDaysExceed2("Delta Smelt", "Larvae", r2, 27.6, 20)
wag2 <- funDaysExceed2("Wakasagi", "Adult", smelt, 29.1, NA)
lfs2 <- funDaysExceed2("Longfin Smelt", "Adult",  smelt, 26.4, 15)
lfsY2 <- funDaysExceed2("Longfin Smelt", "YOY", r3, 24.8, 15)
gstA2 <- funDaysExceed2("Green Sturgeon", "Adult", r4, NA, 21)
gstEA2 <- funDaysExceed2("Green Sturgeon", "Early Adult", r5, 23, 15)
gstL2 <- funDaysExceed2("Green Sturgeon", "Larvae", r6, 33.7,19)
stbJ2 <- funDaysExceed2("Striped Bass", "Juvenile", r6, 32, 25)
wstL2 <- funDaysExceed2("White Sturgeon", "Larvae", r7, 25,19)
wstA2 <- funDaysExceed2("White Sturgeon", "Adult", allreg, NA, 21)
wstJ2 <- funDaysExceed2("White Sturgeon", "Juvenile", allreg, NA, 25)
stbA2 <- funDaysExceed2("Striped Bass", "Adult", r8, NA,24)
```

These are interpreted as **Days Suitable** instead of **Days Unsuitable**
```{r}
egDe2 <- funDaysExceed2("Egeria densa", allreg, 32, 21)
mic2 <- funDaysExceed2("Microcystis", allreg, NA, 19) #not tolerance
corb2 <- funDaysExceed2("Corbicula", allreg, NA, 18) #not tolerance
arund2 <- funDaysExceed2("Arundo", allreg, NA, 24) #not tolerance
hya2 <- funDaysExceed2("Water Hyacinth", salmonReg, 34, 28)
pot2 <- funDaysExceed2("Potamocorbula", r9, 30, 15)
```

```{r}
# Fish
SpeciesYears <- rbind(chAd2, chCo2, LivWR2, rbt2,
                      spltAd2, spltL2, spltS2, 
                      dsmA2, wag2, lfs2, dsmJ2, dsmL2, lfsY2,
                      gstA2, gstEA2, gstL2,
                      wstL2, wstJ2, wstA2, stbJ2, stbA2, issA2, issYOY2, LMB2)

SpeciesYears2 <- SpeciesYears %>%
  dplyr::mutate(daysExceedanceOpt = replace(daysExceedanceOpt, is.na(Optimum), NA),
         daysExceedanceTol = replace(daysExceedanceTol, is.na(Tolerance), NA),
         Species2 = ifelse(is.na(LifeStage), Species, paste(Species, LifeStage))) %>%
  dplyr::mutate(color = case_when(Species2 == "Chinook Adult" ~ "skyblue3",
                           Species2 == "Chinook Juvenile FR" ~ "lightblue2",
                           Species2 == "Chinook Juvenile WR" ~ "slateblue4",
                           Species2 == "Rainbow Trout Juvenile" ~ "olivedrab4",
                           Species2 == "Delta Smelt Adult" ~ "hotpink3",
                           Species2 == "Delta Smelt Juvenile" ~ "plum1",
                           Species2 == "Delta Smelt Larvae" ~ "pink3",
                           Species2 == "Wakasagi Adult" ~ "red",
                           Species2 == "Green Sturgeon Adult" ~ "darkgreen",
                           Species2 == "Green Sturgeon Early Adult" ~ "green3",
                           Species2 == "Green Sturgeon Larvae" ~ "darkseagreen3",
                           Species2 == "White Sturgeon Adult" ~ "azure4",
                           Species2 == "White Sturgeon Juvenile" ~ "azure3",
                           Species2 == "White Sturgeon Larvae" ~ "azure2",
                           Species2 == "Longfin Smelt Adult" ~ "purple4",
                           Species2 == "Longfin Smelt YOY" ~ "mediumpurple2",
                           Species2 == "Silverside Adult" ~ "grey90",
                           Species2 == "Splittail Adult" ~ "darkgoldenrod3",
                           Species2 == "Splittail YOY Large" ~ "goldenrod2",
                           Species2 == "Splittail YOY Small" ~ "lightgoldenrod1",
                           Species2 == "Striped Bass Adult" ~ "aquamarine4",
                           Species2 == "Striped Bass Juvenile" ~ "aquamarine",
                           Species2 == "Largemouth Bass Juvenile" ~ "burlywood1")) %>%
           dplyr::arrange(Species2)

SpeciesYearsLong <- pivot_longer(SpeciesYears2, cols = daysExceedanceOpt:daysExceedanceTol, names_to = "Type", values_to = "DaysUnsuitable")


# Veg
InvYears <- rbind(egDe, mic, corb, arund, hya, pot)
InvYears2 <- InvYears %>%
  mutate(meanOpt = replace(meanOpt, is.na(Optimum), NA),
         minOpt = replace(minOpt, is.na(Optimum), NA),
         maxOpt = replace(maxOpt, is.na(Optimum), NA),
         meanTol = replace(meanTol, is.na(Tolerance), NA),
         minTol = replace(minTol, is.na(Tolerance), NA),
         maxTol = replace(maxTol, is.na(Tolerance), NA))

InvYearsLong <- pivot_longer(InvYears2, cols = meanTol:maxOpt, names_to = "Type", values_to = "DaysUnsuitable")

InvYearsLong2 <- InvYearsLong %>%
  filter(Type %in% c("meanTol", "meanOpt")) %>%
  mutate(Suitable = 365-DaysUnsuitable)
```













## Plots for invasives
```{r}
ggplot(filter(InvLong, Type %in% c("meanTol", "maxTol", "minTol"))) + geom_point(aes(x = Tolerance, y = DaysUnsuitable, color = Species)) + viridis::scale_colour_viridis(discrete = TRUE, option = "viridis") + theme_bw() +  labs(title = "Tolerance")

ggplot(filter(InvLong, Type %in% c("meanOpt", "maxOpt", "minOpt"))) + geom_point(aes(x = Optimum, y = DaysUnsuitable, color = Species, shape = Type), size = 2) + theme_bw() + viridis::scale_colour_viridis(discrete = TRUE, option = "viridis") + labs(title = "Optimum")

```

```{r}
library(Polychrome)
pal36 <- palette36.colors(30)
pal36 <- as.vector(t(pal36))

ggplot(filter(SpeciesLong, Type %in% c("meanTol", "maxTol", "minTol"))) + geom_point(aes(x = Tolerance, y = DaysUnsuitable, color = Species, shape = Type), size = 2) + theme_bw() + scale_colour_manual(values = pal36) + labs(title = "Tolerance")

ggplot(filter(SpeciesLong, Type %in% c("meanOpt", "maxOpt", "minOpt"))) + geom_point(aes(x = Optimum, y = DaysUnsuitable, color = Species, shape = Type), size = 2) + theme_bw() + scale_colour_manual(values = pal36) + labs(title = "Optimum")
```

### Boxplots: Tolerance
```{r}
SpeciesYears2Tol <- SpeciesYears2 %>%
  filter((!(is.na(daysExceedanceTol)))) %>%
  mutate(Species2 = factor(Species2)) %>%
  mutate(Species2 = reorder(Species2, Tolerance, FUN = max)) %>%
  arrange(Species)

colors1 = SpeciesYears2Tol %>%
  filter((!(is.na(daysExceedanceTol)))) %>%
  select(color) %>%
  unique() 

colors1 = colors1$color

# Life Stage colors
# This one ------------------------------------
(FishTol1 <- 
    ggplot(SpeciesYears2Tol) + 
    geom_rect(xmin = 0, xmax = 1.5, ymin = -Inf, ymax = Inf, fill = "gray85") +
    geom_rect(xmin = 2.5, xmax = 3.5, ymin = -Inf, ymax = Inf, fill = "gray85") +
    geom_rect(xmin = 4.5, xmax = 5.5, ymin = -Inf, ymax = Inf, fill = "gray85") +
    geom_rect(xmin = 6.5, xmax = 7.5, ymin = -Inf, ymax = Inf, fill = "gray85") +
    geom_rect(xmin = 8.5, xmax = 9.5, ymin = -Inf, ymax = Inf, fill = "gray85") +
    geom_rect(xmin = 10.5, xmax = 11.5, ymin = -Inf, ymax = Inf, fill = "gray85") +
      geom_boxplot(aes(x = Species, y = daysExceedanceTol, fill = LifeStage), position = position_dodge(preserve = "single")) +
   viridis::scale_fill_viridis(discrete = TRUE, option = "plasma") + 
    scale_y_continuous(breaks = seq(from = 0, to = 150, by = 25)) +
    labs( y = "Annual Days \nExceeding Tolerance") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, vjust = 0.6),
        axis.title.x = element_blank(),
        legend.title = element_blank(),
        legend.position = "bottom"))

# -----------------------------------------------------------------


# Optimum colors
FishTol2 <- ggplot(SpeciesYears2Tol) + geom_boxplot(aes(x = Species, y = daysExceedanceTol, fill = Tolerance)) + theme_bw() + viridis::scale_fill_viridis() + labs(title = "Tolerance") + 
  scale_y_continuous(breaks = seq(from = 0, to = 250, by = 25)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.1),
        axis.title.x = element_blank())
```

### Boxplots: Optima

```{r}
SpeciesYears2Opt <- SpeciesYears2 %>%
  filter((!(is.na(daysExceedanceOpt)))) %>%
  mutate(Species2 = factor(Species2)) %>%
  mutate(Species2 = reorder(Species2, Optimum, FUN = max)) %>%
  arrange(Species)

colors2 = SpeciesYears2Opt %>%
  filter((!(is.na(daysExceedanceOpt)))) %>%
  select(color) %>%
  unique() 

colors2 = colors2$color

FishOpt1 <- ggplot(SpeciesYears2Opt) + geom_boxplot(aes(x = Species, y = daysExceedanceOpt, fill = Optimum)) + theme_bw() + #scale_fill_manual(values = colors2) + 
  viridis::scale_fill_viridis() + 
  scale_y_continuous(breaks = seq(from = 0, to = 250, by = 25)) +
  labs(title = "Optimum", y = "Annual Days Exceedance")+ theme(axis.text.x = element_text(angle = 90, vjust = 0.1))

# This one ---------------------------------
(FishOpt2 <- ggplot(SpeciesYears2Opt) + 
    geom_rect(xmin = 0, xmax = 1.5, ymin = -Inf, ymax = Inf, fill = "gray85") +
    geom_rect(xmin = 2.5, xmax = 3.5, ymin = -Inf, ymax = Inf, fill = "gray85") +
    geom_rect(xmin = 4.5, xmax = 5.5, ymin = -Inf, ymax = Inf, fill = "gray85") +
    geom_rect(xmin = 6.5, xmax = 7.5, ymin = -Inf, ymax = Inf, fill = "gray85") +
    geom_boxplot(aes(x = Species, y = daysExceedanceOpt, fill = LifeStage), position = position_dodge(preserve = "single")) + # keeps boxplot widths standard
    theme_bw() + 
    scale_fill_viridis(discrete = TRUE, option = "plasma") +
    #scale_fill_manual(values = colors2) + 
   scale_y_continuous(breaks = seq(from = 0, to = 300, by = 25)) +

  labs(y = "Annual Days \nExceeding Optimum")+ 
  theme(axis.text.x = element_text(angle = 60, vjust = 0.5),
        axis.title.x = element_blank(),
        legend.title = element_blank()))
# ---------------------------------

# Facet
(FishOpt3 <- ggplot(SpeciesYears2Opt) +
    geom_boxplot(aes(x = LifeStage, y = daysExceedanceOpt, fill = LifeStage)) + 
    facet_wrap(~Species)) +
  theme_bw() + 
  scale_fill_viridis(discrete = TRUE, option = "plasma") +
    #scale_fill_manual(values = colors2) + 
  scale_y_continuous(breaks = seq(from = 0, to = 250, by = 25)) +

  labs(title = "Optimum", y = "Annual Days Exceedance")+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.1),
        axis.title.x = element_blank())
```

Save images
```{r}

tiff(filename=file.path("Figures/FishOptima.tiff"), units="in",type="cairo", bg="white", height=5, 
     width=7, res=300, pointsize=12,compression="lzw")
FishOpt2
dev.off()


tiff(filename=file.path("Figures/FishTolerance.tiff"), units="in",type="cairo", bg="white", height=5, 
     width=7, res=300, pointsize=12,compression="lzw")
FishTol1
dev.off()

tiff(filename=file.path("Figures/FishOptColors.tiff"), units="in",type="cairo", bg="white", height=7, 
     width=7, res=300, pointsize=10,compression="lzw")
FishOpt1
dev.off()


```

Combined
```{r}
# save legend separately for final figure
get_legend<-function(myggplot){
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}
legend <- get_legend(FishTol1)
(FishOpt2_noleg <- FishOpt2 + theme(legend.position = "none") )
(FishTol1_noleg<- FishTol1 + theme(legend.position = "none") )

tiff(filename=file.path("Figures/Figure_Opt_Tol.tiff"), units="in",type="cairo", bg="white", height=7, 
     width=8, res=300, pointsize=12,compression="lzw")
ggarrange(legend, FishOpt2_noleg, FishTol1_noleg, ncol=1, nrow=3,
             heights = c(0.75,3,3), labels = c("", "A","B"))
dev.off()
```

