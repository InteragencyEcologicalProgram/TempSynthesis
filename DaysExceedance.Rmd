---
title: "DaysExceedance"
author: "Catarina Pien"
date: "9/8/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

Last updated 10/4/2021 by C. Pien
Calculate days exceedance for temperature suitability based on tolerance and optimum temperatures in species table

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
```

## Import data
- These datasets were created in TempHeatStress.Rmd based off tempDaily.rds
```{r}
tempToUse <- readRDS("Data/tempToUse_20210811.rds")
tempDaily <- readRDS("Data/tempDaily_20210811.rds")
```


```{r}
# Combine Far North and North Delta
tempRegions <- tempDaily %>%
  mutate(Region = replace(Region, Region == "Far North", "North Delta"))
```

## Make a function to calculate days exceedance

* Calculate total number of days per year/region in the dataset
* Add up number of days exceeding threshold (maxDaily temperature)
* Divide number of days exceeding threshold by number of days per year and multiply by 365 to get expected ndays
* Summarize min, mean, and max number of days for each region (based on region-year combos)
* Label species and type of threshold


```{r}


# funDaysExceed <- function(species, regions, tolerance, optimum) {
#   daysExceedance <- tempRegions %>%
#     left_join(nStations) %>%
#     group_by(WY, Region) %>%
#     mutate(nDays = n()) %>%
#     ungroup() %>%
#     filter(Region %in% regions) %>%
#     mutate(ExceedTol = ifelse(maxDaily > tolerance, 1L, 0L),
#            ExceedOpt = ifelse(maxDaily > optimum, 1L, 0L)) %>%
#     group_by(WY, Region, nDays, nStation) %>%
#     summarize(daysExceedanceTol = sum(ExceedTol),
#               daysExceedanceOpt = sum(ExceedOpt)) %>%
#     #complete(Region, WY, fill = list(daysExceedanceTol=0, daysExceedanceOpt = 0)) %>%
#     mutate(propPerYearOpt = round(daysExceedanceOpt/nDays,1),
#       daysPerYearTol = round(daysExceedanceTol/nDays/nStation*365,1),
#            daysPerYearOpt = round(daysExceedanceOpt/nDays/nStation*365,1)) %>%
#     ungroup() %>%
#     summarize(propOpt = propPerYearOpt,
#       meanTol = round(mean(daysPerYearTol),1),
#               minTol = min(daysPerYearTol),
#               maxTol = max(daysPerYearTol),
#               meanOpt = round(mean(daysPerYearOpt),1),
#               minOpt = min(daysPerYearOpt),
#               maxOpt = max(daysPerYearOpt)) %>%
#     mutate(Species = species)
# }
```

```{r}
nStations <- tempRegions %>%
  select(Region,Station) %>%
  unique() %>%
  group_by(Region) %>%
  summarize(nStation = n())

funDaysExceed <- function(species, regions, tolerance, optimum) {
daysExceedance <- tempRegions %>%
    left_join(nStations) %>%
    group_by(WY, Region) %>%
    mutate(nDays = n()) %>%
    ungroup() %>%
    filter(Region %in% regions) %>%
    mutate(ExceedTol = ifelse(maxDaily > tolerance, 1L, 0L),
           ExceedOpt = ifelse(maxDaily > optimum, 1L, 0L)) %>%
  group_by(WY, Date) %>%
  summarize(propTol = mean(ExceedTol),
            propOpt = mean(ExceedOpt),
            ExceedTol2 = ifelse(propTol > 0.3, 1L, 0L),
            ExceedOpt2 = ifelse(propTol > 0.3, 1L, 0L)) %>%
  ungroup() %>%
  group_by(WY) %>%
    summarize(daysExceedanceTol = sum(ExceedTol2),
              daysExceedanceOpt = sum(ExceedOpt2)) %>%
  ungroup() %>%
  summarize(meanTol = round(mean(daysExceedanceTol),1),
              minTol = min(daysExceedanceTol),
              maxTol = max(daysExceedanceTol),
              meanOpt = round(mean(daysExceedanceOpt),1),
              minOpt = min(daysExceedanceOpt),
              maxOpt = max(daysExceedanceOpt)) %>%
    mutate(Species = species)
}
```

```{r}
funDaysExceed2 <- function(species, regions, tolerance, optimum) {
  daysExceedance <- tempRegions %>%
    left_join(nStations) %>%
    group_by(WY, Region) %>%
    mutate(nDays = n()) %>%
    ungroup() %>%
    filter(Region %in% regions) %>%
    mutate(ExceedTol = ifelse(maxDaily > tolerance, 1L, 0L),
           ExceedOpt = ifelse(maxDaily > optimum, 1L, 0L)) 
    # group_by(WY, Region, nDays, nStation) %>%
    # summarize(daysExceedanceTol = sum(ExceedTol),
    #           daysExceedanceOpt = sum(ExceedOpt)) %>%
    # #complete(Region, WY, fill = list(daysExceedanceTol=0, daysExceedanceOpt = 0)) %>%
    # mutate(daysPerYearTol = round(daysExceedanceTol/nDays/nStation*365,1),
    #        daysPerYearOpt = round(daysExceedanceOpt/nDays/nStation*365,1))
  }
test <- funDaysExceed2("All", allreg, 24, 20)

tolerance = 23
optimum = 20
species = "Splittail"
regions = allreg


### This is the one




  mutate(propPerYearOpt = round(daysExceedanceOpt/nDays,1),
      daysPerYearTol = round(daysExceedanceTol/nDays/nStation*365,1),
           daysPerYearOpt = round(daysExceedanceOpt/nDays/nStation*365,1)) %>%
  summarize(meanTol = round(mean(daysPerYearTol),1),
              minTol = min(daysPerYearTol),
              maxTol = max(daysPerYearTol),
              meanOpt = round(mean(daysPerYearOpt),1),
              minOpt = min(daysPerYearOpt),
              maxOpt = max(daysPerYearOpt)) %>%
    mutate(Species = species)


stationProp <- daysExceedance %>%
  group_by(Region, Date)%>%
  summarize(propTol = mean(ExceedTol),
            propOpt = mean(ExceedOpt))

```

## Calculate days exceedance
```{r}
allreg <- c("North Delta", "South", "San Joaquin", "Suisun Bay", "Suisun Marsh", "Sac River")
salmonReg <- c("North Delta", "South", "San Joaquin", "Suisun Bay", "Sac River")
smelt <- c("North Delta", "San Joaquin", "Suisun Bay", "Suisun Marsh", "Sac River")
r1 <- c("San Joaquin", "Suisun Bay", "Suisun Marsh", "Sac River")
r2 <- c("South", "San Joaquin",  "Sac River")
r3 <- c( "South", "San Joaquin", "Suisun Bay", "Suisun Marsh", "Sac River")
r4 <- c("North Delta", "Suisun Bay", "Suisun Marsh", "Sac River")
r5 <- c("Suisun Marsh", "Sac River")
r6 <- c("North Delta",  "Sac River")
r7 <- c("North Delta",  "San Joaquin", "Sac River")
r8 <- c("North Delta", "South",  "Suisun Bay", "Suisun Marsh", "Sac River")
r9 <- c( "Suisun Bay", "Suisun Marsh", "Sac River")

spltAd<- funDaysExceed("Splittail", allreg, 29, 24)
spltL<- funDaysExceed("Splittail YOY Large", allreg, 25, 21)
spltS<- funDaysExceed("Splittail YOY Small", allreg, 26, 22)
#wstA <- funDaysExceed("White Sturgeon Adult", allreg, 29, 24) need thresholds
#wstJ <- funDaysExceed("White Sturgeon Juvenile", allreg, 29, 24)
issA <- funDaysExceed("Silverside Adult", allreg, 31, NA)
chAd <- funDaysExceed("Chinook",  salmonReg, 25, 21)
chCo <- funDaysExceed("Chinook FR",  salmonReg, 22, 20)
rbt <- funDaysExceed("Rainbow Trout", salmonReg, 22, 20)
dsmA <- funDaysExceed("Delta Smelt", smelt, 27, 20)
wag <- funDaysExceed("Wakasagi", smelt, 29.1, NA)
lfs <- funDaysExceed("Longfin Smelt", smelt, 26.4, 15)
dsmJ <- funDaysExceed("Delta Smelt Juvenile", r1, 28, 20)
dsmL <- funDaysExceed("Delta Smelt Larvae", r2, 27.6, 20)
lfsY <- funDaysExceed("Longfin Smelt YOY", r3, 24.8, 15)
gstA <- funDaysExceed("Green Sturgeon Adult", r4, NA, 21)
gstEA <- funDaysExceed("Green Sturgeon Early Adult", r5, 23, 15)
gstL <- funDaysExceed("Green Sturgeon Larvae", r6, 33.7,19)
stbJ <- funDaysExceed("Striped Bass Juvenile", r6, 32, 25)
wstL <- funDaysExceed("White Sturgeon Larvae", r7, 25,19)
stbA <- funDaysExceed("Striped Bass Adult", r8, NA,24)
LivWR <- funDaysExceed("Chinook WR", "Sac River", 22, 18.5)
```

These are interpreted as **Days Suitable** instead of **Days Unsuitable**
```{r}
egDe <- funDaysExceed("Egeria densa", allreg, 32, 21)
mic <- funDaysExceed("Microcystis", allreg, 25, 19) #not tolerance
corb <- funDaysExceed("Corbicula", allreg, 25, 18) #not tolerance
arund <- funDaysExceed("Arundo", allreg, 36, 24) #not tolerance
hya <- funDaysExceed("Water Hyacinth", salmonReg, 34, 28)
pot <- funDaysExceed("Potamucorbula", r9, 30, 15)
```

## Bind into table
```{r}
SpeciesTable <- rbind(chAd, chCo, rbt,
                      spltAd, spltL, spltS, 
                      dsmA, wag, lfs, dsmJ, dsmL, lfsY,
                      gstA, gstEA, gstL,
                      wstL, stbJ, stbA, issA)
SpeciesLong <- pivot_longer(SpeciesTable, cols = meanTol:maxOpt, names_to = "Type", values_to = "DaysUnsuitable")

InvTable <- rbind(egDe, mic, corb, arund, hya, pot)
InvLong <- pivot_longer(InvTable, cols = meanTol:maxOpt, names_to = "Type", values_to = "DaysUnsuitable") %>%
  filter(Type %in% c("meanTol", "meanOpt")) %>%
  mutate(Suitable = 365-DaysUnsuitable)
```

```{r}
ggplot(InvLong) + geom_point(aes(x = Species, y = DaysUnsuitable, color = Type)) + viridis::scale_colour_viridis(discrete = TRUE, option = "viridis") + theme_bw() + theme(axis.text.x = element_text(angle = 90))
```

