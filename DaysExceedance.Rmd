---
title: "DaysExceedance"
author: "Catarina Pien"
date: "9/8/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

Last updated 10/4/2021 by C. Pien
Calculate days exceedance for temperature suitability based on tolerance and optimum temperatures in species table

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
```

## Import data
- These datasets were created in TempHeatStress.Rmd based off tempDaily.rds
```{r}
tempToUse <- readRDS("Data/tempToUse_20210811.rds")
tempDaily <- readRDS("Data/tempDaily_20210811.rds")
```


```{r}
# Combine Far North and North Delta
tempRegions <- tempDaily %>%
  mutate(Region = replace(Region, Region == "Far North", "North Delta"))
```

Initial function (don't use)

* Calculate total number of days per year/region in the dataset
* Add up number of days exceeding threshold (maxDaily temperature)
* Divide number of days exceeding threshold by number of days per year and multiply by 365 to get expected ndays
* Summarize min, mean, and max number of days for each region (based on region-year combos)
* Label species and type of threshold


```{r}
# funDaysExceed <- function(species, regions, tolerance, optimum) {
#   daysExceedance <- tempRegions %>%
#     left_join(nStations) %>%
#     group_by(WY, Region) %>%
#     mutate(nDays = n()) %>%
#     ungroup() %>%
#     filter(Region %in% regions) %>%
#     mutate(ExceedTol = ifelse(maxDaily > tolerance, 1L, 0L),
#            ExceedOpt = ifelse(maxDaily > optimum, 1L, 0L)) %>%
#     group_by(WY, Region, nDays, nStation) %>%
#     summarize(daysExceedanceTol = sum(ExceedTol),
#               daysExceedanceOpt = sum(ExceedOpt)) %>%
#     #complete(Region, WY, fill = list(daysExceedanceTol=0, daysExceedanceOpt = 0)) %>%
#     mutate(propPerYearOpt = round(daysExceedanceOpt/nDays,1),
#       daysPerYearTol = round(daysExceedanceTol/nDays/nStation*365,1),
#            daysPerYearOpt = round(daysExceedanceOpt/nDays/nStation*365,1)) %>%
#     ungroup() %>%
#     summarize(propOpt = propPerYearOpt,
#       meanTol = round(mean(daysPerYearTol),1),
#               minTol = min(daysPerYearTol),
#               maxTol = max(daysPerYearTol),
#               meanOpt = round(mean(daysPerYearOpt),1),
#               minOpt = min(daysPerYearOpt),
#               maxOpt = max(daysPerYearOpt)) %>%
#     mutate(Species = species)
# }
```

Calculate the number of stations within each region
```{r}
nStations <- tempRegions %>%
  select(Region,Station) %>%
  unique() %>%
  group_by(Region) %>%
  summarize(nStation = n())

tempRegions2 <- left_join(tempRegions, nStations)
```

## Function for calculating days exceedance

* Filter to regions selected
* For each station-day, compare max daily temp to inputted tolerance and optimum. If in exceedance, assign 1. If not, assign 0.
* For each date, calculate the average number of stations that exceeded tolerance. 
* If more than 30% of stations on a particular day exceeded tolerance or optimum, assign 1. 
* For each WY, sum up the number of days exceeding tolerance
* Calculate over all years the min, mean, and max number of days exceeding thresholds.
* Add species name

```{r}
funDaysExceed <- function(species, regions, tolerance, optimum) {
daysExceedance <- tempRegions2 %>%
    # group_by(WY, Region) %>%
    # mutate(nDays = n()) %>%
    # ungroup() 
    filter(Region %in% regions) %>%
    mutate(ExceedTol = ifelse(maxDaily > tolerance, 1L, 0L),
           ExceedOpt = ifelse(maxDaily > optimum, 1L, 0L)) %>%
  group_by(WY, Date) %>%
  summarize(propTol = mean(ExceedTol, na.rm = TRUE),
            propOpt = mean(ExceedOpt, na.rm = TRUE),
            ExceedTol2 = ifelse(propTol > 0.3, 1L, 0L),
            ExceedOpt2 = ifelse(propOpt > 0.3, 1L, 0L)) %>%
  ungroup() %>%
  group_by(WY) %>%
    summarize(daysExceedanceTol = sum(ExceedTol2, na.rm = TRUE),
              daysExceedanceOpt = sum(ExceedOpt2, na.rm = TRUE)) %>%
  ungroup() %>%
  summarize(meanTol = round(mean(daysExceedanceTol, na.rm = TRUE),1),
              minTol = min(daysExceedanceTol, na.rm = TRUE),
              maxTol = max(daysExceedanceTol, na.rm = TRUE),
              meanOpt = round(mean(daysExceedanceOpt, na.rm = TRUE),1),
              minOpt = min(daysExceedanceOpt, na.rm = TRUE),
              maxOpt = max(daysExceedanceOpt, na.rm = TRUE)) %>%
    mutate(Species = species,
           Tolerance = tolerance,
           Optimum = optimum) %>%
  select(Species, Tolerance, meanTol, minTol, maxTol,
         meanOpt, minOpt, maxOpt, Optimum) 
}
```

Test function
```{r}
tolerance = 23
optimum = 15
species = "Splittail"
regions = r9

test <- funDaysExceed("All", r9, 23, 21)
```

## Calculate days exceedance
```{r}
allreg <- c("North Delta", "South", "San Joaquin", "Suisun Bay", "Suisun Marsh", "Sac River")
salmonReg <- c("North Delta", "South", "San Joaquin", "Suisun Bay", "Sac River")
smelt <- c("North Delta", "San Joaquin", "Suisun Bay", "Suisun Marsh", "Sac River")
r1 <- c("San Joaquin", "Suisun Bay", "Suisun Marsh", "Sac River")
r2 <- c("South", "San Joaquin",  "Sac River")
r3 <- c( "South", "San Joaquin", "Suisun Bay", "Suisun Marsh", "Sac River")
r4 <- c("North Delta", "Suisun Bay", "Suisun Marsh", "Sac River")
r5 <- c("Suisun Marsh", "Sac River")
r6 <- c("North Delta",  "Sac River")
r7 <- c("North Delta",  "San Joaquin", "Sac River")
r8 <- c("North Delta", "South",  "Suisun Bay", "Suisun Marsh", "Sac River")
r9 <- c( "Suisun Bay", "Suisun Marsh", "Sac River")

spltAd<- funDaysExceed("Splittail", allreg, 29, 24)
spltL<- funDaysExceed("Splittail YOY Large", allreg, 25, 21)
spltS<- funDaysExceed("Splittail YOY Small", allreg, 26, 22)
#wstA <- funDaysExceed("White Sturgeon Adult", allreg, 29, 24) need thresholds
#wstJ <- funDaysExceed("White Sturgeon Juvenile", allreg, 29, 24)
issA <- funDaysExceed("Silverside Adult", allreg, 31, NA)
issYOY <- funDaysExceed("Silverside Adult", allreg, 35, NA)
LMB <- funDaysExceed("Largemouth Juvenile", allreg, 34, NA)
chAd <- funDaysExceed("Chinook",  salmonReg, 25, 21)
chCo <- funDaysExceed("Chinook FR",  salmonReg, 22, 20)
rbt <- funDaysExceed("Rainbow Trout", salmonReg, 22, 20)
dsmA <- funDaysExceed("Delta Smelt", smelt, 27, 20)
wag <- funDaysExceed("Wakasagi", smelt, 29.1, NA)
lfs <- funDaysExceed("Longfin Smelt", smelt, 26.4, 15)
dsmJ <- funDaysExceed("Delta Smelt Juvenile", r1, 28, 20)
dsmL <- funDaysExceed("Delta Smelt Larvae", r2, 27.6, 20)
lfsY <- funDaysExceed("Longfin Smelt YOY", r3, 24.8, 15)
gstA <- funDaysExceed("Green Sturgeon Adult", r4, NA, 21)
gstEA <- funDaysExceed("Green Sturgeon Early Adult", r5, 23, 15)
gstL <- funDaysExceed("Green Sturgeon Larvae", r6, 33.7,19)
stbJ <- funDaysExceed("Striped Bass Juvenile", r6, 32, 25)
wstL <- funDaysExceed("White Sturgeon Larvae", r7, 25,19)
wstA <- funDaysExceed("White Sturgeon Adult", allreg, NA, 21)
wstJ <- funDaysExceed("White Sturgeon Juvenile", allreg, NA, 25)
stbA <- funDaysExceed("Striped Bass Adult", r8, NA,24)
LivWR <- funDaysExceed("Chinook WR", "Sac River", 22, 18.5)
```

Veg
```{r}
egDe <- funDaysExceed("Egeria densa", allreg, 32, 21)
mic <- funDaysExceed("Microcystis", allreg, NA, 19) #not tolerance
corb <- funDaysExceed("Corbicula", allreg, NA, 18) #not tolerance
arund <- funDaysExceed("Arundo", allreg, NA, 24) #not tolerance
hya <- funDaysExceed("Water Hyacinth", salmonReg, 34, 28)
pot <- funDaysExceed("Potamocorbula", r9, 30, 15)
```




## Bind into table
```{r}
# Fish
SpeciesTable <- rbind(chAd, chCo, rbt,
                      spltAd, spltL, spltS, 
                      dsmA, wag, lfs, dsmJ, dsmL, lfsY,
                      gstA, gstEA, gstL,
                      wstL, wstJ, wstA, stbJ, stbA, issA, issYOY, LMB)
SpeciesTable2 <- SpeciesTable %>%
  mutate(meanOpt = replace(meanOpt, is.na(Optimum), NA),
         minOpt = replace(minOpt, is.na(Optimum), NA),
         maxOpt = replace(maxOpt, is.na(Optimum), NA),
         meanTol = replace(meanTol, is.na(Tolerance), NA),
         minTol = replace(minTol, is.na(Tolerance), NA),
         maxTol = replace(maxTol, is.na(Tolerance), NA))

SpeciesLong <- pivot_longer(SpeciesTable2, cols = meanTol:maxOpt, names_to = "Type", values_to = "DaysUnsuitable")


# Veg
InvTable <- rbind(egDe, mic, corb, arund, hya, pot)
InvTable2 <- InvTable %>%
  mutate(meanOpt = replace(meanOpt, is.na(Optimum), NA),
         minOpt = replace(minOpt, is.na(Optimum), NA),
         maxOpt = replace(maxOpt, is.na(Optimum), NA),
         meanTol = replace(meanTol, is.na(Tolerance), NA),
         minTol = replace(minTol, is.na(Tolerance), NA),
         maxTol = replace(maxTol, is.na(Tolerance), NA))

InvLong <- pivot_longer(InvTable2, cols = meanTol:maxOpt, names_to = "Type", values_to = "DaysUnsuitable")

InvLong2 <- InvLong %>%
  filter(Type %in% c("meanTol", "meanOpt")) %>%
  mutate(Suitable = 365-DaysUnsuitable)
```


## Function for calculating days exceedance, no means or sums for boxplot

* Filter to regions selected
* For each station-day, compare max daily temp to inputted tolerance and optimum. If in exceedance, assign 1. If not, assign 0.
* For each date, calculate the average number of stations that exceeded tolerance. 
* If more than 30% of stations on a particular day exceeded tolerance or optimum, assign 1. 
* For each WY, sum up the number of days exceeding tolerance
# Add species name

```{r}
funDaysExceed2 <- function(species, regions, tolerance, optimum) {
daysExceedance <- tempRegions2 %>%
    # group_by(WY, Region) %>%
    # mutate(nDays = n()) %>%
    # ungroup() 
    filter(Region %in% regions) %>%
    mutate(ExceedTol = ifelse(maxDaily > tolerance, 1, 0),
           ExceedOpt = ifelse(maxDaily > optimum, 1, 0)) %>%
  group_by(WY, Date) %>%
  summarize(propTol = mean(ExceedTol, na.rm = TRUE),
            propOpt = mean(ExceedOpt, na.rm = TRUE),
            ExceedTol2 = ifelse(propTol > 0.3, 1, 0),
            ExceedOpt2 = ifelse(propOpt > 0.3, 1, 0)) %>%
  ungroup() %>%
  group_by(WY) %>%
    summarize(daysExceedanceTol = sum(ExceedTol2, na.rm = TRUE),
              daysExceedanceOpt = sum(ExceedOpt2, na.rm = TRUE)) %>%
  ungroup() %>%
    mutate(Species = species,
           Tolerance = tolerance,
           Optimum = optimum) %>%
  select(WY, Species, Tolerance, daysExceedanceTol, daysExceedanceOpt, Optimum) 
}
```

```{r}
spltAd2<- funDaysExceed2("Splittail", allreg, 29, 24)
spltL2<- funDaysExceed2("Splittail YOY Large", allreg, 25, 21)
spltS2<- funDaysExceed2("Splittail YOY Small", allreg, 26, 22)
issA2 <- funDaysExceed2("Silverside Adult", allreg, 31, NA)
issYOY2 <- funDaysExceed2("Silverside Adult", allreg, 35, NA)
LMB2 <- funDaysExceed2("Largemouth Juvenile", allreg, 34, NA)
chAd2 <- funDaysExceed2("Chinook",  salmonReg, 25, 21)
chCo2 <- funDaysExceed2("Chinook FR",  salmonReg, 22, 20)
rbt2 <- funDaysExceed2("Rainbow Trout", salmonReg, 22, 20)
dsmA2 <- funDaysExceed2("Delta Smelt", smelt, 27, 20)
wag2 <- funDaysExceed2("Wakasagi", smelt, 29.1, NA)
lfs2 <- funDaysExceed2("Longfin Smelt", smelt, 26.4, 15)
dsmJ2 <- funDaysExceed2("Delta Smelt Juvenile", r1, 28, 20)
dsmL2 <- funDaysExceed2("Delta Smelt Larvae", r2, 27.6, 20)
lfsY2 <- funDaysExceed2("Longfin Smelt YOY", r3, 24.8, 15)
gstA2 <- funDaysExceed2("Green Sturgeon Adult", r4, NA, 21)
gstEA2 <- funDaysExceed2("Green Sturgeon Early Adult", r5, 23, 15)
gstL2 <- funDaysExceed2("Green Sturgeon Larvae", r6, 33.7,19)
stbJ2 <- funDaysExceed2("Striped Bass Juvenile", r6, 32, 25)
wstL2 <- funDaysExceed2("White Sturgeon Larvae", r7, 25,19)
wstA2 <- funDaysExceed2("White Sturgeon Adult", allreg, NA, 21)
wstJ2 <- funDaysExceed2("White Sturgeon Juvenile", allreg, NA, 25)
stbA2 <- funDaysExceed2("Striped Bass Adult", r8, NA,24)
LivWR2 <- funDaysExceed2("Chinook WR", "Sac River", 22, 18.5)
```

These are interpreted as **Days Suitable** instead of **Days Unsuitable**
```{r}
egDe2 <- funDaysExceed2("Egeria densa", allreg, 32, 21)
mic2 <- funDaysExceed2("Microcystis", allreg, NA, 19) #not tolerance
corb2 <- funDaysExceed2("Corbicula", allreg, NA, 18) #not tolerance
arund2 <- funDaysExceed2("Arundo", allreg, NA, 24) #not tolerance
hya2 <- funDaysExceed2("Water Hyacinth", salmonReg, 34, 28)
pot2 <- funDaysExceed2("Potamocorbula", r9, 30, 15)
```

```{r}
# Fish
SpeciesYears <- rbind(chAd2, chCo2, LivWR2, rbt2,
                      spltAd2, spltL2, spltS2, 
                      dsmA2, wag2, lfs2, dsmJ2, dsmL2, lfsY2,
                      gstA2, gstEA2, gstL2,
                      wstL2, wstJ2, wstA2, stbJ2, stbA2, issA2, issYOY2, LMB2)

SpeciesYears2 <- SpeciesYears %>%
  dplyr::mutate(daysExceedanceOpt = replace(daysExceedanceOpt, is.na(Optimum), NA),
         daysExceedanceTol = replace(daysExceedanceTol, is.na(Tolerance), NA)) %>%
  dplyr::mutate(color = case_when(Species == "Chinook" ~ "skyblue3",
                           Species == "Chinook FR" ~ "lightblue2",
                           Species == "Chinook WR" ~ "slateblue4",
                           Species == "Rainbow Trout" ~ "cyan3",
                           Species == "Delta Smelt" ~ "hotpink3",
                           Species == "Delta Smelt Juvenile" ~ "plum1",
                           Species == "Delta Smelt Larvae" ~ "pink3",
                           Species == "Wakasagi" ~ "red",
                           Species == "Green Sturgeon Adult" ~ "darkgreen",
                           Species == "Green Sturgeon Early Adult" ~ "green3",
                           Species == "Green Sturgeon Larvae" ~ "darkseagreen3",
                           Species == "White Sturgeon Adult" ~ "azure4",
                           Species == "White Sturgeon Juvenile" ~ "azure3",
                           Species == "White Sturgeon Larvae" ~ "azure2",
                           Species == "Longfin Smelt" ~ "purple4",
                           Species == "Longfin Smelt YOY" ~ "mediumpurple2",
                           Species == "Silverside Adult" ~ "grey90",
                           Species == "Splittail" ~ "darkgoldenrod3",
                           Species == "Splittail YOY Large" ~ "goldenrod2",
                           Species == "Splittail YOY Small" ~ "lightgoldenrod1",
                           Species == "Striped Bass Adult" ~ "aquamarine4",
                           Species == "Striped Bass Juvenile" ~ "aquamarine",
                           Species == "Largemouth Juvenile" ~ "burlywood1")) %>%
           dplyr::arrange(Species)

SpeciesYearsLong <- pivot_longer(SpeciesYears2, cols = daysExceedanceOpt:daysExceedanceTol, names_to = "Type", values_to = "DaysUnsuitable")


# Veg
InvYears <- rbind(egDe, mic, corb, arund, hya, pot)
InvYears2 <- InvYears %>%
  mutate(meanOpt = replace(meanOpt, is.na(Optimum), NA),
         minOpt = replace(minOpt, is.na(Optimum), NA),
         maxOpt = replace(maxOpt, is.na(Optimum), NA),
         meanTol = replace(meanTol, is.na(Tolerance), NA),
         minTol = replace(minTol, is.na(Tolerance), NA),
         maxTol = replace(maxTol, is.na(Tolerance), NA))

InvYearsLong <- pivot_longer(InvYears2, cols = meanTol:maxOpt, names_to = "Type", values_to = "DaysUnsuitable")

InvYearsLong2 <- InvYearsLong %>%
  filter(Type %in% c("meanTol", "meanOpt")) %>%
  mutate(Suitable = 365-DaysUnsuitable)
```













## Plots for invasives
```{r}
ggplot(filter(InvLong, Type %in% c("meanTol", "maxTol", "minTol"))) + geom_point(aes(x = Tolerance, y = DaysUnsuitable, color = Species)) + viridis::scale_colour_viridis(discrete = TRUE, option = "viridis") + theme_bw() +  labs(title = "Tolerance")

ggplot(filter(InvLong, Type %in% c("meanOpt", "maxOpt", "minOpt"))) + geom_point(aes(x = Optimum, y = DaysUnsuitable, color = Species, shape = Type), size = 2) + theme_bw() + viridis::scale_colour_viridis(discrete = TRUE, option = "viridis") + labs(title = "Optimum")

```

```{r}
library(Polychrome)
pal36 <- palette36.colors(30)
pal36 <- as.vector(t(pal36))

ggplot(filter(SpeciesLong, Type %in% c("meanTol", "maxTol", "minTol"))) + geom_point(aes(x = Tolerance, y = DaysUnsuitable, color = Species, shape = Type), size = 2) + theme_bw() + scale_colour_manual(values = pal36) + labs(title = "Tolerance")

ggplot(filter(SpeciesLong, Type %in% c("meanOpt", "maxOpt", "minOpt"))) + geom_point(aes(x = Optimum, y = DaysUnsuitable, color = Species, shape = Type), size = 2) + theme_bw() + scale_colour_manual(values = pal36) + labs(title = "Optimum")
```

### Boxplots: Tolerance
```{r}
SpeciesYears2Tol <- SpeciesYears2 %>%
  filter((!(is.na(daysExceedanceTol)))) %>%
  mutate(Species = factor(Species)) %>%
  mutate(Species = reorder(Species, Tolerance, FUN = max)) %>%
  arrange(Tolerance)

colors1 = SpeciesYears2Tol %>%
  filter((!(is.na(daysExceedanceTol)))) %>%
  select(color) %>%
  unique() 

colors1 = colors1$color

# Species colors
ggplot(SpeciesYears2Tol) + geom_boxplot(aes(x = Species, y = daysExceedanceTol, fill = Species)) + theme_bw() + scale_fill_manual(values = colors1) + labs(title = "Tolerance") + 
  scale_y_continuous(breaks = seq(from = 0, to = 250, by = 25)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.1),
        axis.title.x = element_blank())


# Optimum colors
ggplot(SpeciesYears2Tol) + geom_boxplot(aes(x = Species, y = daysExceedanceTol, fill = Tolerance)) + theme_bw() + viridis::scale_fill_viridis() + labs(title = "Tolerance") + 
  scale_y_continuous(breaks = seq(from = 0, to = 250, by = 25)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.1),
        axis.title.x = element_blank())
```

### Boxplots: Optima

```{r}

SpeciesYears2Opt <- SpeciesYears2 %>%
  filter((!(is.na(daysExceedanceOpt)))) %>%
  mutate(Species = factor(Species)) %>%
  mutate(Species = reorder(Species, Optimum, FUN = max)) %>%
  arrange(Optimum)

unique(SpeciesYears2Opt$Species)

colors2 = SpeciesYears2Opt %>%
  filter((!(is.na(daysExceedanceOpt)))) %>%
  select(color) %>%
  unique() 

colors2 = colors2$color

ggplot(SpeciesYears2Opt) + geom_boxplot(aes(x = Species, y = daysExceedanceOpt, fill = Optimum)) + theme_bw() + #scale_fill_manual(values = colors2) + 
  viridis::scale_fill_viridis() + 
  scale_y_continuous(breaks = seq(from = 0, to = 250, by = 25)) +
  labs(title = "Optimum", y = "Annual Days Exceedance")+ theme(axis.text.x = element_text(angle = 90, vjust = 0.1))

ggplot(SpeciesYears2Opt) + geom_boxplot(aes(x = Species, y = daysExceedanceOpt, fill = Species)) + theme_bw() + scale_fill_manual(values = colors2) + 
  scale_y_continuous(breaks = seq(from = 0, to = 250, by = 25)) +

  labs(title = "Optimum", y = "Annual Days Exceedance")+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.1),
        axis.title.x = element_blank())
```

