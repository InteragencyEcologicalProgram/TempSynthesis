---
title: "Fish_absence_presence"
author: "Catarina Pien"
date: "3/1/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(dplyr)
library(readr)
library(ggplot2)
library(deltafish)
library(contentid)
library(sf)
```

```{r}
# Integrated
create_fish_db()
surv <- open_survey()
fish <- open_fish()

# Fish
species <- c("Menidia beryllina", "Menidia audens", "Morone saxatilis", "Pogonichthys macrolepidotus", "Micropterus salmoides", "Oncorhynchus tshawytscha", "Oncorhynchus mykiss", "Hypomesus transpacificus", "Spirinchus thaleichthys", "Hypomesus nipponensis", "Acipenser medirostris", "Acipenser transmontanus", "Gasterosteus aculeatus", "Cottus asper", "Ptychocheilus grandis", "Catostomus occidentalis", "Lavinia exilicauda", "Orthodon microlepidotus", "Hysterocarpus traskii")

yolosubset <- c("Inland Silverside", "Striped Bass", "Splittail", "Largemouth Bass", "Longfin Smelt", "Delta Smelt", "Wakasagi", "Chinook Salmon", "Rainbow / Steelhead Trout", "White Sturgeon", "Green Sturgeon", "Hitch", "Prickly Sculpin", "Sacramento Blackfish", "Sacramento Sucker", "Sacramento Pikeminnow", "Tule Perch", "Threespine Stickleback")
  
# Yolo
#yolo_id <- contentid::store("https://portal.edirepository.org/nis/dataviewer?packageid=edi.233.2&entityid=015e494911cf35c90089ced5a3127334")
yolo_file <- contentid::resolve("hash://sha256/e0dc10d7f36cfc5ac147956abb91f24f2b2df9f914a004bbf1e85e7d9cf52f41")
#yolo_stations_id <- contentid::store("https://portal.edirepository.org/nis/dataviewer?packageid=edi.233.2&entityid=6a82451e84be1fe82c9821f30ffc2d7d")
yolo_stations_file <- contentid::resolve("hash://sha256/e25498ffc0208c3ae0e31a23204b856a9309f32ced2c87c8abcdd6f5cef55a9b")
#yolo_taxonomy_id <- contentid::store("https://portal.edirepository.org/nis/dataviewer?packageid=edi.233.2&entityid=0532048e856d4bd07deea11583b893dd")
yolo_taxonomy_file <- contentid::resolve("hash://sha256/1473de800f3c5577da077507fb006be816a9194ddd417b1b98836be92eaea49d")

yolo_taxonomy <- readr::read_csv(yolo_taxonomy_file) %>%
  mutate(Taxa = paste(Genus, Species)) %>%
  select(CommonName, Taxa) %>%
  mutate(Taxa = replace(Taxa, Taxa == "Menidia beryllina", "Menidia audens"),
         Taxa = replace(Taxa, Taxa == "Hysterocarpus traski", "Hysterocarpus traskii"))
yolo_fish <- readr::read_csv(yolo_file) %>%
  filter(CommonName %in% yolosubset) %>%
  left_join(yolo_taxonomy)
yolo_sites <- readr::read_csv(yolo_stations_file)
unique(yolo_fish$CommonName)

## DJFMP
# djfmp_id <- contentid::store("https://portal.edirepository.org/nis/dataviewer?packageid=edi.244.8&entityid=147fd5e2c7db15913b2ffa44410dc7f9")
# djfmp_file <- contentid::resolve("hash://sha256/e66175172176fe4580eef8461661cc25f0dca51baf36e9e62385a3f3de8c86c4")
# djfmp <- readr::read_csv(djfmp_file)
#djfmp_fish <- filter(djfmp, OrganismCode %in% c("CHN", "LMB", "RBT", "SASU", "STB", "SPLT", "DSM", "MSS", "PRS", "GSN", "WSN", "WAG", "LFS", "TSS", "TP", "SAPM", "HCH", "SCB"))

# Salvage - from FTP
# salvage_id <- contentid::store("SpeciesTables/data_raw/salvage.rds")
salvage_file <- contentid::resolve("hash://sha256/7e6d32127c22411ca5089d33a6444223302f05983035b5f3966c629a63f1d636")
salvage <- readRDS(salvage_file) %>%
  dplyr::mutate(Taxa = paste(Genus, Species),
                Source = "Salvage",
                SampleID = paste(Source, SampleRowID),
                Region = "South & Central") %>%
  dplyr::filter(Taxa %in% species,
                !is.na(ForkLength)) %>%
  dplyr::select(Source, SampleID,
                Date = SampleDate,
                Region,
                Count, 
                Length=ForkLength,
                LengthFrequency, Taxa, CommonName) 
salvageRep <- rbind(salvage, salvage[rep(1:nrow(salvage), 1),])
salvageF <- salvageRep %>% 
  mutate(index = 1:nrow(.),
         Region = ifelse(index <=423256, "South", "Central")) %>%
  select(-index)
summary(salvageF)
  

# Sturgeon data - from CDFW trammel net, Dylan Stompe
#sturgeon_id <- contentid::store("SpeciesTables/data_raw/Sturgeon_Individuals.csv")
sturgeon_file <- contentid::resolve("hash://sha256/3e227e10004c0fb2840a860d1d0c6fed8e5ae5520759d76b02898295b5e20c40")
sturgeon <- readr::read_csv(sturgeon_file) %>%
  dplyr::mutate(Region = case_when(TaggingLoc == "Suisun Bay" ~ "Suisun Bay",
                                   TaggingLoc == "Fremont Weir" ~ "Far North",
                                   TaggingLoc == "West Island" ~ "Confluence",
                                   TaggingLoc == "Lower San Joaquin Delta" ~ "Central",
                                   TaggingLoc == "Sacramento River" ~ "North Delta", 
                                   TaggingLoc == "Lower San Joaquin River" ~ "South",
                                   TRUE ~ as.character(TaggingLoc))) %>%
  dplyr::filter(!Region %in% c("San Pablo Bay", "Tisdale Bypass", "Unk"))  %>%
  dplyr::rename(Year = RelYear,
                Date = RelDate,
                Length = TL) %>%
  dplyr::mutate(Taxa = ifelse(Species == "White", "Acipenser transmontanus", ifelse(Species == "Green", "Acipenser medirostris", Species)),
                Source = "CDFW Sturgeon",
                SampleID = paste(Source, NetSetId),
                Count = 1)%>%
  dplyr::select(-Vessel, -NetSet, -TaggingLoc, -MeshSize, -RelCond, -NetSetId, -Species)

# Regions shapefile for synthesis
regions <- st_read(here("RosieRegions", "RosiesRegions2022.shp"))
regions$Region <- c("Suisun Marsh", "Suisun Bay","Confluence", "North Delta", "Far North", "Central" , "South") 
st_crs(regions)
```

## Filter integrated dataset - all surveys, species list.

```{r}
# filter for sources and taxa of interest
surveys <- surv %>% 
    filter(Source %in% c("DJFMP", "Suisun", "BayStudy", "EDSM", "FMWT", "SKT", "TMM", "SLS", "STN")) %>% 
    select(SampleID, Source, Date, Latitude, Longitude)
    
fish_sp <- fish %>%
  filter(Taxa %in% species)

df <- left_join(surveys, fish_sp) %>% 
    collect() 
```

Turn into spatial and join (slow)

```{r}
df_complete <- filter(df, !is.na(Longitude))%>%
  mutate(Date = lubridate::ymd(Date)) 
df_sf <- st_as_sf(df_complete, coords = c("Longitude", "Latitude"), crs = 4326)

new_df <- st_join(df_sf, regions, join = st_within) 

```

```{r}
saveRDS(new_df, "SpeciesTables/deltafish_regionjoin.rds", compress = "xz")
new_df <- readRDS("SpeciesTables/deltafish_regionjoin.rds")
rm(df_complete, df_sf)
```

## Modify Yolo data

```{r}
yolo <- left_join(yolo_fish, yolo_sites, by = "StationCode") %>%
  mutate(SampleID = paste("YBFMP", 1:nrow(.)),
         Notes_catch = NA,
         SampleDate = lubridate::mdy(SampleDate), 
         Source = "YBFMP")%>%
  select(SampleID, Source, Date = SampleDate, StationCode, Length =  ForkLength,
         Count, Notes_catch, Taxa, Latitude = LatitudeLocation, Longitude = LongitudeLocation) 
```

Turn into spatial and join

```{r}
yolo_sf <- st_as_sf(yolo, coords = c("Longitude", "Latitude"), crs = 4326)
yolo_regions <- st_join(yolo_sf, regions, join = st_within) %>%
  select(-Regions)
```

## Join yolo and data from deltafish

```{r}
alldata0 <- bind_rows(yolo_regions, sturgeon, salvageF, new_df) 
alldata <- alldata0 %>%
  filter(Count > 0,
         !is.na(Region),
         !is.na(Length)) %>%
  mutate(Month = lubridate::month(Date),
         Season = case_when(Month<=3~ "Winter",
                            Month %in% c(4, 5, 6)~ "Spring",
                            Month %in% c(7, 8, 9)~ "Summer", 
                            Month >=10~ "Fall",
                            TRUE~as.character(NA)))
```

```{r}
saveRDS(alldata, "SpeciesTables/fishdata_joined.rds", compress = "xz")
alldata <- readRDS("SpeciesTables/fishdata_joined.rds")
```

Add lifestage info

```{r}
species <- c("Menidia beryllina", "Menidia audens", "Morone saxatilis", "Pogonichthys macrolepidotus", "Micropterus salmoides", "Oncorhynchus tshawytscha", "Oncorhynchus mykiss", "Hypomesus transpacificus", "Spirinchus thaleichthys", "Hypomesus nipponensis", "Acipenser medirostris", "Acipenser transmontanus")

lifestage <- alldata %>%
  mutate(Taxa = replace(Taxa, Taxa == "Hysterocarpus traski", "Hysterocarpus traskii")) %>%
  mutate(Taxa = replace(Taxa, Taxa == "Menidia beryllina", "Menidia audens")) %>%
  mutate(LifeStage = case_when(Taxa == "Morone saxatilis" & Length < 20~"Larvae",
                               Taxa == "Morone saxatilis" & Length >= 20 & Length < 350~"Juvenile",
                               Taxa == "Morone saxatilis" & Length >= 350 ~ "Adult",
                               Taxa == "Micropterus salmoides" & Length < 25 ~ "Larvae",
                               Taxa == "Micropterus salmoides" & Length >= 25 & Length < 180 ~ "Juvenile",
                               Taxa == "Micropterus salmoides" & Length >= 180 ~ "Adult",
                               Taxa == "Pogonichthys macrolepidotus" & Length < 20.2 ~ "Larvae",
                               Taxa == "Pogonichthys macrolepidotus" & Length >= 20.2 & Length < 170 ~ "Juvenile",
                               Taxa == "Pogonichthys macrolepidotus" & Length >= 170 ~ "Adult",
                               Taxa == "Menidia audens" & Length < 9 ~ "Larvae",
                               Taxa == "Menidia audens" & Length >=9 & Length < 50~"Juvenile",
                               Taxa == "Menidia audens" & Length >= 50 ~ "Adult",
                               Taxa %in% c("Hypomesus transpacificus", "Hypomesus nipponensis") & Length <20 ~ "Larvae",
                               Taxa %in% c("Hypomesus transpacificus", "Hypomesus nipponensis") & Length >=20 & Length <59 ~ "Juvenile",
                               Taxa %in% c("Hypomesus transpacificus", "Hypomesus nipponensis") & Length >=59 ~ "Adult",
                               Taxa == "Spirinchus thaleichthys" & Length <20 ~ "Larvae",
                               Taxa == "Spirinchus thaleichthys" & Length >=20 & Length <80 ~ "Juvenile",
                               Taxa == "Spirinchus thaleichthys" & Length>=80 ~ "Adult",
                               Taxa == "Acipenser medirostris" & Length <20 ~ "Larvae",
                               Taxa == "Acipenser medirostris" & Length >=20 & Length <=1500 ~ "Juvenile",
                               Taxa == "Acipenser medirostris" & Length >1500 ~ "Adult",
                               Taxa == "Acipenser transmontanus" & Length <100 ~ "Larvae",
                               Taxa == "Acipenser transmontanus" & Length >=100 & Length <=1050 ~ "Juvenile",
                               Taxa == "Acipenser transmontanus" & Length >1050 ~ "Adult",
                               Taxa == "Oncorhynchus tshawytscha"  & Length <35 ~ "Larvae",
                               Taxa == "Oncorhynchus tshawytscha" & Length >=35 & Length <=700 ~ "Juvenile",
                               Taxa == "Oncorhynchus tshawytscha" & Length >700 ~ "Adult",
                                 Taxa == "Oncorhynchus mykiss"  & Length <25 ~ "Larvae",
                               Taxa == "Oncorhynchus mykiss" & Length >=25 & Length <=390 ~ "Juvenile",
                               Taxa == "Oncorhynchus mykiss" & Length >390 ~ "Adult",
                               
                               
                               Taxa == "Orthodon microlepidotus" & Length < 250 ~ "Juvenile-Larvae",
                               Taxa == "Orthodon microlepidotus" & Length >=250  ~ "Adult",
                               Taxa == "Lavinia exilicauda" & Length <150 ~ "Juvenile-Larvae",
                               Taxa == "Lavinia exilicauda" & Length >=150 ~ "Adult",
                               Taxa == "Hysterocarpus traskii" & Length <100 ~ "Juvenile-Larvae",
                               Taxa == "Hysterocarpus traskii" & Length >=100 ~ "Adult",
                               Taxa == "Ptychocheilus grandis" & Length <=220 ~ "Juvenile-Larvae",
                               Taxa == "Ptychocheilus grandis" & Length >220 ~ "Adult",
                               Taxa == "Catostomus occidentalis" & Length < 14 ~ "Larvae",
                               Taxa == "Catostomus occidentalis" & Length >=14 & Length <200 ~ "Juvenile",
                               Taxa == "Catostomus occidentalis" & Length >=200 ~ "Adult",
                               Taxa == "Gasterosteus aculeatus" & Length < 41 ~ "Juvenile-Larvae",
                               Taxa == "Gasterosteus aculeatus" & Length >=41 ~ "Adult",
                               Taxa == "Cottus asper" & Length <40 ~ "Juvenile-Larvae",
                               Taxa == "Cottus asper" & Length >=40 ~ "Adult",
                               
                               TRUE ~ as.character("Undifferentiated")),
         Season = factor(Season, levels = c("Winter", "Spring", "Summer", "Fall"))) 





Juvenile = lifestage %>%
  filter(LifeStage == "Juvenile") %>%
  group_by(Source, Season, Region, Taxa) %>%
  summarize(n = n())
Juvenile_low <- Juvenile %>%
  filter(n<3)
Adult = lifestage %>%
  filter(LifeStage == "Adult") %>%
  group_by(Source, Season, Region, Taxa) %>%
  summarize(n = n())
Larvae = lifestage %>%
  filter(LifeStage == "Larvae") %>%
  group_by(Source, Season, Region, Taxa) %>%
  summarize(n = n())

All_lifestages <- lifestage %>%
  group_by(Source, Season, Region, Taxa, LifeStage) %>%
  summarize(n = n())

All_notbysource <- lifestage %>%
  group_by(Season, Region, Taxa, LifeStage) %>%
  summarize(n = n())

All_removesingles <- All_notbysource %>%
  filter(n>1) %>%
  mutate(Taxa_Lifestage = paste0(Taxa, "_", LifeStage)) %>%
  mutate(Presence = "Yes")

Check <- All_removesingles %>%
  filter(Region %in% c("Central", "South"))

calculate <- lifestage
  group_by(Source, Season, Region, Taxa) %>%
  summarize(n = n(),
            min = min(Length, na.rm = TRUE),
            mean = mean(Length, na.rm = TRUE),
            max = max(Length, na.rm = TRUE))
```

```{r}
saveRDS(lifestage, "absencepresence_lifestage.rds", compress = "xz")
write_csv(All_lifestages, "summed_absence_presence_all_bysource.csv")
write_csv(All_notbysource, "summed_absence_presence_all_region.csv")
write_csv(All_removesingles, "species_absence_presence.csv")
```

## Plots

Plot Region-Season

```{r}
juv_plot <- ggplot(Juvenile) + geom_tile(aes(Region, Season, fill = n)) + viridis::scale_fill_viridis() + facet_wrap(~Taxa) + theme(axis.text.x = element_text(angle = 90))

adult_plot <- ggplot(Adult) + geom_tile(aes(Region, Season, fill = n)) + viridis::scale_fill_viridis() + facet_wrap(~Taxa)+ theme(axis.text.x = element_text(angle = 90))

larvae_plot <- ggplot(Larvae) + geom_tile(aes(Region, Season, fill = n)) + viridis::scale_fill_viridis() + facet_wrap(~Taxa)+ theme(axis.text.x = element_text(angle = 90))

all_plot <- ggplot(All_removesingles) + geom_tile(aes(Region, Taxa_Lifestage, fill = n)) + viridis::scale_fill_viridis() + facet_wrap(~Season)+ theme(axis.text.x = element_text(angle = 90))
  
all_plot
juv_plot
```

This is the data for use in DaysExceedance.Rmd
```{r}
thresholds <- readxl::read_excel(here::here("SpeciesTables", "SpeciesThresholds.xlsx")) %>%
  na_if(.,"NA") 

data_export <- All_removesingles %>%
  as.data.frame()%>%
  select(Region, Taxon = Taxa, LifeStage, Season) %>%
  left_join(thresholds %>% select(Species, Taxon)) %>%
  select(Region, Species, LifeStage, Season)
write_csv(data_export, "SpeciesTables/exportfishabsence_presence.csv")
```

Adult salmon yolo

```{r}
yolo_salmon <- yolo_fish %>% 
  filter(CommonName == "Chinook Salmon") %>%
  mutate(SampleDate = mdy(SampleDate),
         Month = month(SampleDate))

salmon_adult <- yolo_salmon %>%filter(MethodCode == "FKTR")
salmon_juv <- yolo_salmon %>% filter(MethodCode %in% c("BSEIN", "RSTR") & ForkLength < 600)

unique(salmon_juv$Month)

ggplot(salmon_adult) + geom_histogram(aes(ForkLength))
ggplot(salmon_juv) + geom_histogram(aes(ForkLength))
  
```

Plot min, mean, max FL data

```{r}
calculate_clean_long <- tidyr::pivot_longer(calculate_clean, cols = c("min", "max", "mean"), values_to = "FL", names_to = "length_label")

ggplot(calculate_clean_long) + geom_jitter(aes(Season, FL, shape = Source, color = length_label)) + facet_grid(Region~Taxa) + theme_bw() + theme(axis.text.x = element_text(angle = 90))
```

What are the length/weight cutoffs? Look at djfmp data.

```{r}
djfmp_subset <- djfmp %>%
  filter(OrganismCode %in% c("STB", "SPLT", "LMB", "MSS"))

ggplot(djfmp_subset) + geom_histogram(aes(ForkLength)) + facet_wrap(~OrganismCode, scale = "free")
```

Length Frequency yolo

```{r}
yolo_length_plot <- ggplot(yolo) + geom_histogram(aes(Length)) + facet_wrap(~Taxa, scales = "free")  +  scale_x_continuous(breaks = seq(0, 1000, 50)) + theme_bw() + theme(axis.text.x = element_text(angle = 90))
```

```{r}
png("Figures/yolofish_lengthfreq.png", width = 5, height = 4, pointsize = 12, res = 200, units = "in")
yolo_length_plot
dev.off()
```
