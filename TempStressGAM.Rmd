---
title: "TempStressGAM"
author: "Catarina Pien"
date: "5/12/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

Load packages
```{r}
library(tidyverse)
library(lubridate)
library(mgcv)

if (!require("rspatial")) devtools::install_github('rspatial/rspatial')
library(rspatial)
library( spgwr )
library(nlme)
library(boot)
library(itsadug)
library(raster)
library(stars)
library(countreg) # rootogram
library(DHARMa) # residuals

```

## Load data

- These datasets were created in TempHeatStress.Rmd based off tempDaily.rds
```{r}
latlon <- read_csv("Data/StationsMetadata.csv")%>%
  dplyr::select(c(Station, Latitude, Longitude))
heatDays250 <- read_csv("Data/heatDaysHighMedLow25.csv")
heatDays210 <- read_csv("Data/heatDaysHighLow21.csv")
noRecov250 <- read_csv("Data/noRecovery25.csv")
noRecov210 <- read_csv("Data/noRecovery21.csv")
tempDaily0 <- readRDS("Data/tempDaily.rds") %>%
  filter(WY>2009 & WY<2020)
# tempMon <- readRDS("Data/tempMonthly.rds") # if we want to look at seasonal differences
```

## Data Manipulation

Calculate temperature anomaly: Calculate average temp over dataset. Subtract annual mean temperature - 11-yr mean temperature
```{r}
mean11Years <- tempDaily0 %>%
  #filter(month(Date) > 4 & month(Date) < 10) %>%
  mutate(mean11 = round(mean(meanDaily),1)) %>%
  group_by(WY, mean11) %>%
  summarize(meanAnnual = round(mean(meanDaily),1),
            sdAnnual = round(sd(meanDaily),1),
            Anomaly = meanAnnual-mean11,
            AnomalyStd = Anomaly/sdAnnual) %>%
  ungroup() %>%
  unique()

# tempAnnual0 <- tempDaily0 %>%
#   filter(month(Date) > 4 & month(Date) < 10) %>%
#   group_by(WY) %>%
#   summarize(meanAnnual = round(mean(meanDaily),1),
#             sdAnnual = round(sd(meanDaily),1)) 
  
# tempAnnual <- tempAnnual0 %>%
#   left_join(mean11Years) %>%
#   mutate(Anomaly = meanAnnual-mean11,
#          AnomalyStd = Anomaly/sdAnnual)

tempAnnual <- mean11Years
# Divide anomaly by standard deviation?
Anomaly <- tempAnnual %>%
  dplyr::select(c(WY, Anomaly, AnomalyStd))
```

Bring anomaly into datasets
```{r}
heatDays25 <- heatDays250 %>%
  left_join(Anomaly) %>%
  dplyr::select(-X1)

heatDays21 <- heatDays210 %>%
  left_join(Anomaly)%>%
  dplyr::select(-X1)
```

Filter to high stress/no recovery only
```{r}
highStress25 <- heatDays25 %>%
  filter(Stress == "High") %>%
  mutate(nDaysAdj = round((propDays*365),0)) %>%
  left_join(latlon)%>%
  filter(WY>2009 & WY<2020,
         Station != "OH1")

highStress21 <- heatDays21 %>%
  filter(Stress == "High")%>%
 mutate(nDaysAdj = round((propDays*365),0)) %>%
  left_join(latlon)%>%
  filter(WY>2009 & WY<2020,
         Station != "OH1")

noRecov25 <- noRecov250 %>%
  left_join(Anomaly) %>%
  dplyr::select(-X1) %>%
  filter(StressAllDay == "Y")%>%
  mutate(nDaysAdj = round((propDays*365),0)) %>%
  left_join(latlon)%>%
  filter(WY>2009 & WY<2020,
         Station != "OH1")

noRecov21 <- noRecov210 %>%
  left_join(Anomaly) %>%
  dplyr::select(-X1)%>%
  filter(StressAllDay == "Y")%>%
  mutate(nDaysAdj = round((propDays*365),0)) %>%
  left_join(latlon)%>%
  filter(WY>2009 & WY<2020,
         Station != "OH1")
```

```{r}
tile <- ggplot(highStress21) + geom_tile(aes(x = fWY, y = Station, fill = propDays))
tile <- ggplot(highStress21) + geom_tile(aes(x = fWY, y = Station, fill = Anomaly))
ggplot(tempDaily) + geom_tile(aes(x = WY, y = Station))
plotly::ggplotly(tile)
```


## Models

### Models for heat stress days at 21C
- no family 
- binomial family
- quasibinomial family
- beta family

```{r}
# g21a <- gam(nDaysAdj~ te(Latitude, Longitude, Anomaly, d = c(2,1), bs = c("tp", "tp"), k = c(12,5)) , data = highStress21, method= "REML")
# 
# par(mfrow = c(2,2))
# gam.check(g21a)
# par(mfrow = c(1,1))
# plot(g21a)
# par(mfrow = c(1,1))
# vis.gam(g21a,
#         view = c("Longitude", "Latitude"),
#         color = "heat", 
#         plot.type = "contour",
#         too.far = 0.1,
#         se = -1)

# Transformations?
# asinTransform <- function(p) { asin(sqrt(p)) }
# logitTransform <- function(p) { log(p/(1-p)) }
# ggplot(highStress21) + geom_histogram(aes(propDays))
# ggplot(highStress21) + geom_histogram(aes(asinTransform(propDays)))
# ggplot(highStress21) + geom_histogram(aes(logitTransform(propDays)))

# Binomial model
g21abin <- gam(cbind(nDays, totalDays)~ te(Latitude, Longitude, Anomaly, d = c(2,1), bs = c("tp", "tp"), k = c(12,6)) ,  data = highStress21, method= "REML", family = binomial)
summary(g21abin)

hist(highStress21$propDays)
par(mfrow = c(2,2))
gam.check(g21abin)
par(mfrow = c(1,1))
vis.gam(g21abin,
        view = c("Longitude", "Latitude"),
        color = "heat", 
        plot.type = "contour",
        too.far = 0.1,
        se = -1, type = "response")

# Plot  residuals vs predicted
plot(predict(g21abin), residuals(g21abin))
abline(h=0, lty = 2, col = "grey")
lines(lowess(predict(g21abin),residuals(g21abin)),col="black",lwd=2)
#segments(predict(g21abin),y$fit+2*y$se.fit,predict(g21abin),y$fit-2*y$se.fit,col="green")

# Check for overdispersion
# rootogram doesn't work
# root_g21abin <- rootogram(g21abin, style = "hanging", plot = FALSE)

#Dharma doesn't work
#simulationOutput <- simulateResiduals(fittedModel = g21abin)
#testDispersion(simulationOutput)

# Overdispersion for glm
# https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#testing-for-overdispersioncomputing-overdispersion-factor
overdisp_fun <- function(model) {
    rdf <- df.residual(model)
    rp <- residuals(model,type="pearson")
    Pearson.chisq <- sum(rp^2)
    prat <- Pearson.chisq/rdf
    pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
    c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)
}
overdisp_fun(g21abin)

# quasibinomial 
g21abinQ <- gam(cbind(nDays, totalDays)~ te(Latitude, Longitude, Anomaly, d = c(2,1), bs = c("tp", "tp"), k = c(12,6)) ,  data = highStress21, method= "REML", family = quasibinomial)
summary(g21abinQ)
overdisp_fun(g21abinQ)

par(mfrow = c(2,2))
gam.check(g21abinQ)
par(mfrow = c(1,1))
vis.gam(g21abinQ,
        view = c("Longitude", "Latitude"),
        color = "heat", 
        plot.type = "contour",
        too.far = 0.1,
        se = -1, type = "response")

g21abin1 <- gam(propDays~ te(Latitude, Longitude, Anomaly, d = c(2,1), bs = c("tp", "tp"), k = c(12,6)) ,  data = highStress21, method= "REML", weights = totalDays, family = binomial)
summary(g21abin1)
gam.check(g21abin1)
plot(g21abin1)

# Alternative models
g21abin2 <- gam(cbind(nDays, totalDays)~ te(Latitude, Longitude, bs = "tp", k = 12) + s(Anomaly, bs = "tp", k = 6),data = highStress21, method= "REML", family = binomial)
summary(g21abin2)
gam.check(g21abin2)
plot(g21abin2)

g21abin3 <- gam(cbind(nDays, totalDays)~ te(Latitude, Longitude, by = Anomaly, bs = "tp", k = c(6,6)) + Anomaly, data = highStress21, method= "REML", family = binomial)

summary(g21abin3)
gam.check(g21abin3)
plot(g21abin3)


# g21abetar <- gam(cbind(nDays, totalDays)~ te(Latitude, Longitude, Anomaly, d = c(2,1), bs = c("tp", "tp"), k = c(12,6)) ,  data = highStress21, method= "REML", family = betar)
# 
# par(mfrow = c(2,2))
# gam.check(g21abetar)
# par(mfrow = c(1,1))
# plot(g21abetar)
# 
# AIC(g21abin, g21abin1, g21abin2, g21abin3, g21abetar)

```

### Models for no recovery at 21 ----
```{r}
library(tidymv)
g21NRabin <- gam(cbind(nDays, totalDays)~ te(Latitude, Longitude, Anomaly, d = c(2,1), bs = c("tp", "tp"), k = c(12,6)) ,  data = noRecov21, method= "REML", family = binomial)
summary(g21NRabin)

par(mfrow = c(2,2))
gam.check(g21NRabin)
par(mfrow = c(1,1))
#plot_smooths(model = g21NRabin, Latitude, Anomaly, transform = exp)
vis.gam(g21NRabin,
        view = c("Longitude", "Latitude"),
        color = "heat", 
        plot.type = "contour",
        too.far = 0.1,
        se = -1, type = "response")


g21NRabinQ <- gam(cbind(nDays, totalDays)~ te(Latitude, Longitude, Anomaly, d = c(2,1), bs = c("tp", "tp"), k = c(12,6)) ,  data = noRecov21, method= "REML", family = quasibinomial)
summary(g21NRabinQ)
par(mfrow = c(2,2))
gam.check(g21NRabinQ)

```


### High stress 25
```{r}
library(viridis)
library(gridExtra)
g25abin <- gam(cbind(nDays, totalDays)~ te(Latitude, Longitude, Anomaly, d = c(2,1), bs = c("tp", "tp"), k = c(12,6)) ,  data = highStress25, method= "REML", family = binomial)
summary(g25abin)

par(mfrow = c(2,2))
gam.check(g25abin)
par(mfrow = c(1,1))
plot.gam(g25abin)
par(mfrow = c(1,1))
vis.gam(g25abin,
        view = c("Longitude", "Latitude"),
        color = "heat", 
        plot.type = "contour",
        too.far = 0.1,
        se = -1, type = "response")

# modPred <- predict.gam(g25abin, se.fit=TRUE,type="response")
# summary(modPred$fit)


g25abinQ <- gam(cbind(nDays, totalDays)~ te(Latitude, Longitude, Anomaly, d = c(2,1), bs = c("tp", "tp"), k = c(12,6)) ,  data = highStress25, method= "REML", family = quasibinomial)
summary(g25abinQ)
par(mfrow = c(2,2))
gam.check(g25abinQ)
par(mfrow = c(1,1))
vis.gam(g25abinQ,
        view = c("Longitude", "Latitude"),
        color = "heat", 
        plot.type = "contour",
        too.far = 0.1,
        se = -1, type = "response")

```

plot data
```{r}


ggplot(highStress21) + geom_boxplot(aes(x = Station, y = Anomaly, fill = Region)) + geom_hline(yintercept = 1, color = "orange") + theme_bw()
ggplot(highStress25)+ geom_tile(aes(x = Anomaly, y = Station, color = propDays))

ggplot(highStress25)+ geom_col(aes(x = Station, y = propDays, fill = Anomaly), position = position_dodge()) + scale_fill_viridis() + facet_wrap(~Region)

ggplot(highStress25)+ geom_jitter(aes(x = Longitude, y = Latitude, color = propDays),alpha = 0.5, size = 3, position = position_dodge()) + scale_color_viridis()

South <- ggplot(subset(highStress25, Region == "South"))+ geom_col(aes(x = Station, y = propDays, fill = Anomaly), position = position_dodge()) + scale_fill_viridis() + labs(title = "South")
SJ <- ggplot(subset(highStress25, Region == "San Joaquin"))+ geom_col(aes(x = Station, y = propDays, fill = Anomaly), position = position_dodge()) + scale_fill_viridis() + labs(title = "San Joaquin")

ND <- ggplot(subset(highStress25, Region == "North Delta"))+ geom_col(aes(x = Station, y = propDays, fill = Anomaly), position = position_dodge()) + scale_fill_viridis() + labs(title = "North Delta")

SR <- ggplot(subset(highStress25, Region == "Sac River"))+ geom_col(aes(x = Station, y = propDays, fill = Anomaly), position = position_dodge()) + scale_fill_viridis() + labs(title = "Sac River")

SB <- ggplot(subset(highStress25, Region == "Suisun Bay"))+ geom_col(aes(x = Station, y = propDays, fill = Anomaly), position = position_dodge()) + scale_fill_viridis() + labs(title = "Suisun Bay")
SM <- ggplot(subset(highStress25, Region == "Suisun Marsh"))+ geom_col(aes(x = Station, y = propDays, fill = Anomaly), position = position_dodge()) + scale_fill_viridis() + labs(title = "Suisun Marsh")

grid.arrange(ND, SR, South, SJ, SB, SM)
```

### Models for no recovery at 25
- binomial better
```{r}
g25NRabin <- gam(cbind(nDays, totalDays)~ te(Latitude, Longitude, Anomaly, d = c(2,1), bs = c("tp", "tp"), k = c(12,6)) ,  data = noRecov25, method= "REML", family = binomial)
summary(g25NRabin)

par(mfrow = c(2,2))
gam.check(g25NRabin)
par(mfrow = c(1,1))
plot.gam(g25NRabin)

# quasibinomial

g25NRabinQ <- gam(cbind(nDays, totalDays)~ te(Latitude, Longitude, Anomaly, d = c(2,1), bs = c("tp", "tp"), k = c(12,6)) ,  data = noRecov25, method= "REML", family = quasibinomial)
summary(g25NRabinQ)
par(mfrow = c(2,2))
gam.check(g25NRabinQ)
par(mfrow = c(1,1))
plot.gam(g25NRabinQ)


ggplot(noRecov25) + geom_histogram(aes(propDays)) + theme_bw() +theme(axis.text = element_text(size =15))
ggplot(highStress25) + geom_histogram(aes(propDays)) + theme_bw() + theme(axis.text = element_text(size =15))
```















## Mapping

### Prep Shapefiles
Read regions shapefile (shapefile of regions created for water temp)
Read delta shapefile in (shapefile of the Delta)
Read station latlons in, convert to sf

```{r}
library(sf)
regions = read_sf("RosieRegions/shpExport.shp")
regions = st_transform(regions, crs = 4326)

delta = read_sf("DeltaShapefile/hydro_delta_marsh.shp")
delta = st_transform(delta,crs=4326)
delta2 = dplyr::filter(delta,HNAME != "SAN FRANCISCO BAY", HNAME != "SAN PABLO BAY") 

stas = read.csv("Data/StationsMetadata.csv") %>%
  filter(Station != "DV7", Station != "RIP", Station != "RPN", Station != "RCS")%>%
  dplyr::select(Station,  Latitude, Longitude)

```



Create a convex hull around the points and buffer by 0.01
only predict in our station area
```{r}
ch = chull(stas$Longitude, stas$Latitude) #define hull boundaries
hull = stas[ch,]

library(sfheaders)
hullp = sf_polygon(
  obj = hull
  , x = "Longitude"
  , y = "Latitude"
)

st_crs(hullp) = 4326

chbuff = st_as_sf(hullp) %>%
  st_buffer(dist = 0.1)

# subset delta shapefile to area close to our stations
st_crs(delta) = 4326

deltabuff = st_buffer(delta, 400) %>%
  st_intersection(chbuff) # some warning messages

ggplot() + 
  geom_sf(data = deltabuff, fill = "blue", alpha = 0.5)

# save(deltabuff, file="deltabuffthick.Rdata")
load("deltabuffthick.Rdata")
```

Change station into sf
```{r}
coordinates(stas) = ~ Longitude + Latitude #change to sp
proj4string(stas) <- CRS("+proj=longlat +datum=NAD83") #changed this line from Rosie'sclass(stas)
stas = st_as_sf(stas) %>% st_transform(stas, crs=4326) #change to sf
```

### Create new data and make predictions 

This function creates new data based off of your data limits
- Make new lat/lons based off shapefile (delta regions)
- Make sure these are all on water
- expand grid for Anomaly data, join lat lons in
- standardize all variables (??)
- turn into sf
- again confirm in regions boundary (??)
```{r}
HD_pred<-function(Full_data=Data,
                  Delta_subregions = regions,
                  Delta_water=delta,
                  Stations = stas,
                  n=500, # 300 points x, 300  points y
                  AnomalyRange = -1:1
){
  
  # Create point locations on a grid for predictions
  Points<-st_make_grid(Delta_subregions, n=n)%>%
    st_as_sf(crs=st_crs(Delta_subregions))%>%
    st_join(Delta_water)%>% 
    
    # Joining a map of delta waterways (from my spacetools package) to ensure all these points are over water.
    st_coordinates()%>%
    as_tibble()%>%
    mutate(Location=1:nrow(.))%>%
    dplyr::select(Longitude=X, Latitude=Y, Location)
  
  # Create full dataset for predictions
  newdata<-expand.grid(Location=1:nrow(Points),
                       Anomaly = AnomalyRange)%>% # Create all combinations of predictor variables
    left_join(Points, by="Location")%>% #Add Lat/Longs to each location
    mutate(Latitude_s=(Latitude-mean(Full_data$Latitude, na.rm=T))/sd(Full_data$Latitude, na.rm=T), # Standardize each variable based on full dataset for model
           Longitude_s=(Longitude-mean(Full_data$Longitude, na.rm=T))/sd(Full_data$Longitude, na.rm=T),
           Anomaly_s = (Anomaly-mean(Full_data$Anomaly, na.rm=T))/sd(Full_data$Anomaly, na.rm=T)) %>%
    st_as_sf(coords=c("Longitude", "Latitude"), crs=4326, remove=FALSE)%>% # Turn into sf object
    
    st_transform(crs=st_crs(Delta_subregions))%>% # transform to crs of Delta shapefile
    
   # st_join(Delta_subregions, join = st_intersects)
  
  return(newdata)
}


```


#### Create data
Is the n specific to lat/lon? Creating 300 lats and lons based on your specifications? How to pick?

If you don't specify the numbers, it will use all available integers. 
```{r}
# * normal ----
newdata_21a <- HD_pred(Full_data=highStress21, n=500,
                       Anomaly = c(0,1)) 

newdata_25a <- HD_pred(Full_data=highStress25, n=300,
                       Anomaly = c(0,1))

# * no recovery ----
newdata_21NRa<- HD_pred(Full_data=noRecov21, n=500,
                       Anomaly = c(0,1))
newdata_25NRa <- HD_pred(Full_data = noRecov25, n = 500,
                       Anomaly = c(0,1))

```

#### Predictions with new data - use function above 
```{r}
# 21a
modelg21abin_predictions<-predict(g21abin, newdata=newdata_21a, type="response", se.fit=TRUE, discrete=T) # Create predictions
# Edit data frame
newdatag21abin<-newdata_21a%>%
  mutate(Prediction=modelg21abin_predictions$fit)%>%
  mutate(SE=modelg21abin_predictions$se.fit,
         L95=Prediction-SE*1.96,
         U95=Prediction+SE*1.96)
summary(newdatag21abin$Prediction)


# 25a
modelg25abin_predictions<-predict(g25abin, newdata=newdata_25a, type="response", se.fit=TRUE, discrete=T) # Create predictions
# Edit data frame
newdatag25abin<-newdata_25a%>%
  mutate(Prediction=modelg25abin_predictions$fit)%>%
  mutate(SE=modelg25abin_predictions$se.fit,
         L95=Prediction-SE*1.96,
         U95=Prediction+SE*1.96)

# * no recovery ----

# NR21a
modelg21NRabin_predictions<-predict(g21NRabin, newdata=newdata_21NRa, type="response", se.fit=TRUE, discrete=T) # Create predictions
# Edit data frame
newdatag21NRabin<-newdata_21NRa%>%
  mutate(Prediction=modelg21NRabin_predictions$fit)%>%
  mutate(SE=modelg21NRabin_predictions$se.fit,
         L95=Prediction-SE*1.96,
         U95=Prediction+SE*1.96)
summary(newdatag21NRabin$Prediction)


# NR25a
modelg25NRabin_predictions<-predict(g25NRabin, newdata=newdata_25NRa, type="response", se.fit=TRUE, discrete=T) # Create predictions
# Edit data frame
newdatag25NRabin<-newdata_25NRa%>%
  mutate(Prediction=modelg25NRabin_predictions$fit)%>%
  mutate(SE=modelg25NRabin_predictions$se.fit,
         L95=Prediction-SE*1.96,
         U95=Prediction+SE*1.96)

summary(newdatag25NRabin$Prediction)

```

Save files
```{r}
save(newdatag21abin, newdatag25abin, newdatag21NRabin,  newdatag25NRabin, file = "newdataPreds_annualanomaly_20210721.RData")

load("newdataPreds_annualanomaly_20210721.RData")
```

Out of function
```{r}
# Create point locations on a grid for predictions
  Points<-st_make_grid(regions, n=100)%>%
    st_as_sf(crs=st_crs(regions))%>%
    st_join(deltabuff) %>%
    
    # Joining a map of delta waterways (from my spacetools package) to ensure all these points are over water.
    st_coordinates()%>%
    as_tibble()%>%
    mutate(Location=1:nrow(.))%>%
    dplyr::select(Longitude=X, Latitude=Y, Location)


newdata<-expand.grid(Location=1:nrow(Points),
                     Anomaly = c(-2,0,2)) %>%
  left_join(Points, by="Location") %>% #Add Lat/Longs to each location
  mutate(Latitude_s=(Latitude-mean(highStress21$Latitude))/sd(highStress21$Latitude), # Standardize each variable based on full dataset for model
Longitude_s=(Longitude-mean(highStress21$Longitude, na.rm=T))/sd(highStress21$Longitude, na.rm=T),
           Anomaly_s = (Anomaly-mean(highStress21$Anomaly, na.rm=T))/sd(highStress21$Anomaly, na.rm=T)) %>%
    st_as_sf(coords=c("Longitude", "Latitude"), crs=4326, remove=FALSE)%>% # Turn into sf object
    st_transform(crs=st_crs(deltabuff))%>% # transform to crs of Delta shapefile
    st_join(regions, join = st_intersects)

```

Calculate proportion for Anomaly = 0 and Anomaly = 1
```{r}
regions$Region <- c("Suisun Marsh", "Suisun Bay","Sac River", "North Delta", "Far North", "San Joaquin" , "South") 
mapview::mapView(regions, zcol = "Region")
rownames(regions) <- regions$Region

intersections <- st_intersection(newdatag21abin, regions)
Prediction21 <- newdatag21abin %>%
  group_by(Anomaly)%>%
  summarize(mean(Prediction))

Prediction21NR <- newdatag21NRa%>%
  group_by(Anomaly)%>%
  summarize(mean(Prediction))




```






### Rasterize data

Function to rasterize data
- What does map() do? One map for each anomaly 
- st_rasterize will rasterize your data. dx = cell size x, dy = cell size y
  - Take your max x - min x and divide by number of cells, same with y
- What is exec(c) part?

- map = apply
for every unique Anomaly, we will rasterize data, where Anomaly = x (-2,0,2), select Prediction, rasterize area within delta

bang bang unquotes, bang bang bang (big bang) operator: unquotes several operators at once
```{r}
Rasterize_all <- function(data, var, out_crs=4326, n=100){
  var<-rlang::enquo(var)
  rlang::as_name(var)
  preds<-map(unique(data$Anomaly), 
             function(x) st_rasterize(data%>%
                                      filter(Anomaly==x)%>%
                                      dplyr::select(!!var),                 
                                      template=st_as_stars(st_bbox(delta2),
              dx=diff(st_bbox(delta2)[c(1, 3)])/n,                     dy=diff(st_bbox(delta2)[c(2, 4)])/n, values = NA_real_))%>%
               st_warp(crs=out_crs))
  return(preds)
  # Then bind all Anomalies together into 1 raster
  out <- exec(c, !!!preds, along=list(Anomaly=unique(data$Anomaly)))
  return(out)
}

```


Rasterize (use function above)
```{r}
# Create full rasterization of all predictions for interactive visualizations

rastered_preds21abin<-Rasterize_all(newdatag21abin, Prediction)
rastered_preds25abin<-Rasterize_all(newdatag25abin, Prediction)
rastered_preds21NRabin <- Rasterize_all(newdatag21NRabin, Prediction)
rastered_preds25NRabin <- Rasterize_all(newdatag25NRabin, Prediction)


# Same for SE

rastered_SE21abin<-Rasterize_all(newdatag21abin, SE)

```

Save raster files
```{r}
save(rastered_preds21abin, rastered_preds25abin, rastered_preds21NRabin, rastered_preds25NRabin, file = "RasteredPreds_20210714.RData")
```

### Start here if just want to plot
```{r}
load("deltabuffThick.RData")
load("RasteredPreds_20210629.RData")
```

Change coordinate reference system for data and deltabuff to UTM 10

```{r}
plot(rastered_preds21abin[[1]])

rastered_preds21abin[[1]] <- st_warp(rastered_preds21abin[[1]], crs = 32610)
rastered_preds21abin[[2]] <- st_warp(rastered_preds21abin[[2]], crs = 32610)
#rastered_preds21abin[[3]] <- st_warp(rastered_preds21abin[[3]], crs = 32610)
rastered_preds25abin[[1]] <- st_warp(rastered_preds25abin[[1]], crs = 32610)
rastered_preds25abin[[2]] <- st_warp(rastered_preds25abin[[2]], crs = 32610)
rastered_preds25abin[[3]] <- st_warp(rastered_preds25abin[[3]], crs = 32610)

rastered_preds21NRabin[[1]] <- st_warp(rastered_preds21NRabin[[1]], crs = 32610)
rastered_preds21NRabin[[2]] <- st_warp(rastered_preds21NRabin[[2]], crs = 32610)
#rastered_preds21NRabin[[3]] <- st_warp(rastered_preds21NRabin[[3]], crs = 32610)
rastered_preds25NRabin[[1]] <- st_warp(rastered_preds25NRabin[[1]], crs = 32610)
rastered_preds25NRabin[[2]] <- st_warp(rastered_preds25NRabin[[2]], crs = 32610)
#rastered_preds25NRabin[[3]] <- st_warp(rastered_preds25NRabin[[3]], crs = 32610)
deltabuff <- st_transform(deltabuff, crs = 32610)
```


### Plot raster
- Why is st_crop not working?

```{r}
raster_plot<-function(data, Anomaly, labels="All"){
  data = data[[Anomaly]]
 data = st_crop(data, deltabuff)
 # lims = c(min(data$Prediction, na.rm = T), max(data$Prediction, na.rm = T))
   ggplot()+
    geom_stars(data=data)+
   scale_x_continuous(breaks = seq(from = 550000, to = 670000, by = 40000))+
   # facet_wrap(~Date)+
    scale_fill_viridis_c(breaks = seq(from = 0, to = 0.35, by = 0.1), na.value="white",limits = c(0, 0.35))+
    coord_sf()+
    ylab("Latitude")+
    xlab("Longitude")+
    theme_bw() + 
    theme(axis.text = element_text(size = 12),
          axis.title = element_text(size = 13),
          plot.title = element_text(hjust = 0.5),
          legend.title = element_text(size = 13),
          legend.position = "right",
         # legend.spacing.x = unit(2, 'cm'),
          legend.text = element_text(size = 12)) +
      
          # plot.margin = margin(0,0,0,0, "cm"))
    #guides(fill = guide_colorbar(barwidth = 2))
        guides(fill=guide_colorbar(title="ProportionDays"))
}

```

Plot raster results
```{r}

plot21_avg <- raster_plot(rastered_preds21abin, 1) + ggtitle("Average year")
plot21_anom <- raster_plot(rastered_preds21abin, 2) + ggtitle("Warm  year (+1C)")
#raster_plot(rastered_preds21abin, 1) + ggtitle("propDays > 21 Anomaly = -2")

plot25_avg <- raster_plot(rastered_preds25abin, 1) + ggtitle("")
plot25_anom <- raster_plot(rastered_preds25abin, 2) + ggtitle("")
#raster_plot(rastered_preds25abin, 1) + ggtitle("propDays > 25 Anomaly = -2")

rastered_preds21NRabin[[2]]
range(rastered_preds21NRabin[[1]]$Prediction)

plot21NR_avg <- raster_plot(rastered_preds21NRabin, 1) + ggtitle("Anomaly = 0")
plot21NR_anom <- raster_plot(rastered_preds21NRabin, 2) + ggtitle("Anomaly = 1")
#raster_plot(rastered_preds21NRabin, 1) + ggtitle("propDaysNoRecov > 21 Anomaly = -2")

plot25NR_avg <- raster_plot(rastered_preds25NRabin, 1) + ggtitle("")
plot25NR_anom <- raster_plot(rastered_preds25NRabin, 2) + ggtitle("")
#raster_plot(rastered_preds25NRabin, 1) + ggtitle("propDaysNoRecov > 25 Anomaly = -2")

plot25NR_anom


```

```{r}
save( plot21_anom, plot21_avg, plot25_anom, plot25_avg,plot21NR_anom, plot21NR_avg, plot25NR_anom, plot25NR_avg, file = "finalplots_20210714.RData")

save(plot21_anom, plot21_avg, plot25_anom, plot25_avg, file = "finalplotsPart1_20210714.RData")
```

```{r}
library(gridExtra)
library(grid)
grid.arrange(plot21_avg, plot21_anom,
             plot25_avg, plot25_anom, nrow = 2)
grid.arrange(plot21NR_avg, plot21NR_anom,
             plot25NR_avg, plot25NR_anom, nrow = 2)
```


```{r}
ggplot() +
  geom_stars(data = rastered_preds21NRabin[[2]])  +
  scale_fill_viridis_c() +
  geom_sf(data = deltabuff, alpha = 0)
```

Bring raster code out of function - works!
```{r}
a <- st_crop(rastered_preds21abin[[2]], deltabuff)
a
plot(a)

rasterEx <- rastered_preds21abin[[2]] %>%
  st_crop(deltabuff)

lims = c(min(rasterEx$Prediction, na.rm = T), max(rasterEx$Prediction, na.rm = T))

 ggplot()+
    geom_stars(data=rasterEx)+
   # facet_wrap(~Date)+
    scale_fill_viridis_c(name="PropDays", na.value="white", limits = lims,
                        # labels= function(x) ifelse((x/2)==as.integer(x/2), as.character(x), ""),
                         guide = guide_colorbar(direction="horizontal", title.position = "top", barwidth = 10, ticks.linewidth = 2,
                                                barheight=1, title.hjust=0.5, label.position="bottom", label.theme=element_text(size=12), 
                                                title.theme=element_text(size=13)))+
    coord_sf()+
    ylab("Latitude")+
    xlab("Longitude")+
    theme_bw() + theme(legend.position = "top")
```



