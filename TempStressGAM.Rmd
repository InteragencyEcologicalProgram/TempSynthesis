---
title: "TempStressGAM"
author: "Catarina Pien"
date: "5/12/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---
1. Calculate temperature anomaly


Load packages
```{r}
library(tidyverse)
library(lubridate)
library(mgcv)

if (!require("rspatial")) devtools::install_github('rspatial/rspatial')
library(rspatial)
library( spgwr )
library(nlme)
library(boot)
library(itsadug)
library(raster)
library(stars)
```

1. Load data

- These datasets were created in TempHeatStress.Rmd based off tempDaily.rds
```{r}
latlon <- read_csv("Data/StationsMetadata.csv")%>%
  dplyr::select(c(Station, Latitude, Longitude))
heatDays250 <- read_csv("Data/heatDaysHighMedLow25.csv")
heatDays210 <- read_csv("Data/heatDaysHighLow21.csv")
noRecov250 <- read_csv("Data/noRecovery25.csv")
noRecov210 <- read_csv("Data/noRecovery21.csv")
tempDaily0 <- readRDS("Data/tempDaily.rds") %>%
  filter(WY>2008 & WY<2020)
# tempMon <- readRDS("Data/tempMonthly.rds") # if we want to look at seasonal differences
```

2. Calculate temperature anomaly: Calculate average temp over dataset. For each station, subtract annual mean temperature - 11-yr mean temperature
```{r}
mean11Years <- tempDaily0 %>%
  group_by(Station) %>%
  summarize(mean11 = round(mean(meanDaily),1))

tempAnnual0 <- tempDaily0 %>%
  group_by(Station, WY) %>%
  summarize(meanAnnual = round(mean(meanDaily),1),
            sdAnnual = round(sd(meanDaily),1))
  
tempAnnual <- tempAnnual0 %>% 
  left_join(mean11Years) %>%
  mutate(Anomaly = meanAnnual-mean11,
         AnomalyStd = Anomaly/sdAnnual)

# Divide anomaly by standard deviation?
Anomaly <- tempAnnual %>%
  dplyr::select(c(WY, Station, Anomaly, AnomalyStd))
```

3. Bring anomaly into datasets
```{r}
heatDays25 <- heatDays250 %>%
  left_join(Anomaly) %>%
  dplyr::select(-X1)

heatDays21 <- heatDays210 %>%
  left_join(Anomaly)%>%
  dplyr::select(-X1)
```

Filter to high stress/no recovery only
```{r}
highStress25 <- heatDays25 %>%
  filter(Stress == "High") %>%
  mutate(nDaysAdj = propDays*365) %>%
  left_join(latlon)

highStress21 <- heatDays21 %>%
  filter(Stress == "High")%>%
  mutate(nDaysAdj = propDays*365) %>%
  left_join(latlon)

noRecov25 <- noRecov250 %>%
  left_join(Anomaly) %>%
  dplyr::select(-X1) %>%
  filter(StressAllDay == "Y")%>%
  mutate(nDaysAdj = propDays*365) %>%
  left_join(latlon)

noRecov21 <- noRecov210 %>%
  left_join(Anomaly) %>%
  dplyr::select(-X1)%>%
  filter(StressAllDay == "Y")%>%
  mutate(nDaysAdj = propDays*365) %>%
  left_join(latlon)
```


Models for heat stress days at 21C 
- no family 
- binomial family
- beta family

```{r}
g21a <- gam(nDaysAdj~ te(Latitude, Longitude, Anomaly, d = c(2,1), bs = c("tp", "tp"), k = c(12,5)) ,  data = highStress21, method= "REML")

par(mfrow = c(2,2))
gam.check(g21a)
par(mfrow = c(1,1))
plot(g21a)
par(mfrow = c(1,1))
vis.gam(g21a,
        view = c("Longitude", "Latitude"),
        color = "heat", 
        plot.type = "contour",
        too.far = 0.1,
        se = -1)


g21abinProp <- gam(propDays~ te(Latitude, Longitude, Anomaly, d = c(2,1), bs = c("tp", "tp"), k = c(12,6)) , weights = totalDays, data = highStress21, method= "REML", family = binomial)
par(mfrow = c)

g21abin <- gam(cbind(nDays, totalDays)~ te(Latitude, Longitude, Anomaly, d = c(2,1), bs = c("tp", "tp"), k = c(12,6)) ,  data = highStress21, method= "REML", family = binomial)
summary(g21abin)

par(mfrow = c(2,2))
gam.check(g21abin)
par(mfrow = c(1,1))
plot(g21abin)
par(mfrow = c(1,1))
vis.gam(g21abin,
        view = c("Longitude", "Latitude"),
        color = "heat", 
        plot.type = "contour",
        too.far = 0.1,
        se = -1)
# Showing weird numbers (proportion = 1.1, 1.5)

g21abetar <- gam(propDays~ te(Latitude, Longitude, Anomaly, d = c(2,1), bs = c("tp", "tp"), k = c(12,6)) ,  data = highStress21, method= "REML", family = betar)

par(mfrow = c(2,2))
gam.check(g21abetar)
par(mfrow = c(1,1))
plot(g21abetar)
par(mfrow = c(1,1))
```

Standardized anomaly
```{r}
# Standardized anomaly
g21b <- gam(nDaysAdj~ te(Latitude, Longitude, AnomalyStd, d = c(2,1), bs = c("tp", "tp"), k = c(12,5)) , data = highStress21, method= "REML")
par(mfrow = c(2,2))
gam.check(g21b)

par(mfrow = c(1,1))
plot(g21b)
par(mfrow = c(1,1))
vis.gam(g21b,
        view = c("Longitude", "Latitude"),
        color = "heat", 
        plot.type = "contour",
        too.far = 0.1,
        se = -1)


g21bbin <- gam(cbind(nDays, totalDays)~ te(Latitude, Longitude, AnomalyStd, d = c(2,1), bs = c("tp", "tp"), k = c(12,6)) ,  data = highStress21, method= "REML", family = binomial)
summary(g21bbin)

par(mfrow = c(2,2))
gam.check(g21bbin)
par(mfrow = c(1,1))
plot(g21bbin)
par(mfrow = c(1,1))
vis.gam(g21bbin,
        view = c("Longitude", "Latitude"),
        color = "heat", 
        plot.type = "contour",
        too.far = 0.1,
        se = -1)
```


Models for no recovery at 21a
```{r}
g21NRa <- gam(nDaysAdj~ te(Latitude, Longitude, Anomaly, d = c(2,1), bs = c("tp", "tp"), k = c(15,5)) , data = noRecov21, method= "REML")

par(mfrow = c(2,2))
gam.check(g21NRa)

par(mfrow = c(1,1))
plot(g21NRa)
par(mfrow = c(1,1))
vis.gam(g21NRa,
        view = c("Longitude", "Latitude"),
        color = "heat", 
        plot.type = "contour",
        too.far = 0.1,
        se = -1)



```

No recovery 21b
```{r}
g21NRb <- gam(nDaysAdj~ te(Latitude, Longitude, AnomalyStd, d = c(2,1), bs = c("tp", "tp"), k = c(12,5)) , data = noRecov21, method= "REML")
par(mfrow = c(2,2))
gam.check(g21NRb)

par(mfrow = c(1,1))
plot(g21NRb)
par(mfrow = c(1,1))
vis.gam(g21NRb,
        view = c("Longitude", "Latitude"),
        color = "heat", 
        plot.type = "contour",
        too.far = 0.1,
        se = -1)
```

Mapping
Read regions shapefile (shapefile of regions created for water temp)
Read delta shapefile in (shapefile of the Delta)
Read station latlons in, convert to sf

```{r}
library(sf)
regions = read_sf("RosieRegions/shpExport.shp")
regions = st_transform(regions, crs = 4326)

delta = read_sf("DeltaShapefile/hydro_delta_marsh.shp")
delta = st_transform(delta,crs=4326)
delta2 = sf::as_Spatial(dplyr::filter(delta, HNAME != "SAN FRANCISCO BAY", HNAME != "SAN PABLO BAY"))

stas = read.csv("Data/StationsMetadata.csv") %>%
  filter(Station != "DV7", Station != "RIP", Station != "RPN", Station != "RCS")%>%
  dplyr::select(Station,  Latitude, Longitude)

```



Create a convex hull around the points and buffer by 0.01
only predict in our station area
```{r}
ch = chull(stas$Longitude, stas$Latitude) #define hull boundaries
hull = stas[ch,]

library(sfheaders)
hullp = sf_polygon(
  obj = hull
  , x = "Longitude"
  , y = "Latitude"
)

st_crs(hullp) = 4326

chbuff = st_as_sf(hullp) %>%
  st_buffer(dist = 0.02)

# subset delta shapefile to area close to our stations
deltabuff = st_buffer(delta, dist = 0.005) %>%
  st_intersection(chbuff) # some warning messages
```

Change station into sf
```{r}
coordinates(stas) = ~ Longitude + Latitude #change to sp
proj4string(stas) <- CRS("+proj=longlat +datum=NAD83") #changed this line from Rosie'sclass(stas)
stas = st_as_sf(stas) %>% st_transform(stas, crs=4326) #change to sf
```

### Create new data and make predictions 

This function creates new data based off of your data limits
- Make new lat/lons based off shapefile (delta regions)
- Make sure these are all on water
- expand grid for Anomaly data, join lat lons in
- standardize all variables (??)
- turn into sf
- again confirm in regions boundary (??)
```{r}
HD_pred<-function(Full_data=Data,
                  Delta_subregions = regions,
                  Delta_water=delta,
                  Stations = stas,
                  n=300, # 300 points x, 300  points y
                  AnomalyRange = -2:2
){
  
  # Create point locations on a grid for predictions
  Points<-st_make_grid(Delta_subregions, n=n)%>%
    st_as_sf(crs=st_crs(Delta_subregions))%>%
    st_join(Delta_water)%>% 
    
    # Joining a map of delta waterways (from my spacetools package) to ensure all these points are over water.
    st_coordinates()%>%
    as_tibble()%>%
    mutate(Location=1:nrow(.))%>%
    dplyr::select(Longitude=X, Latitude=Y, Location)
  
  # Create full dataset for predictions
  newdata<-expand.grid(Location=1:nrow(Points),
                       Anomaly = AnomalyRange)%>% # Create all combinations of predictor variables
    left_join(Points, by="Location")%>% #Add Lat/Longs to each location
    mutate(Latitude_s=(Latitude-mean(Full_data$Latitude, na.rm=T))/sd(Full_data$Latitude, na.rm=T), # Standardize each variable based on full dataset for model
           Longitude_s=(Longitude-mean(Full_data$Longitude, na.rm=T))/sd(Full_data$Longitude, na.rm=T),
           Anomaly_s = (Anomaly-mean(Full_data$Anomaly, na.rm=T))/sd(Full_data$Anomaly, na.rm=T)) %>%
    st_as_sf(coords=c("Longitude", "Latitude"), crs=4326, remove=FALSE)%>% # Turn into sf object
    
    st_transform(crs=st_crs(Delta_subregions))%>% # transform to crs of Delta shapefile
    
   # st_join(Delta_subregions, join = st_intersects)
  
  return(newdata)
}


```

#### Create data
Is the n specific to lat/lon? Creating 300 lats and lons based on your specifications? How to pick?

If you don't specify the numbers, it will use integers. 
```{r}
# * normal ----
newdata_21a <- HD_pred(Full_data=highStress21, n=300,
                       Anomaly = c(-2,0,2)) # does the warning message matter?

newdata_25a <- HD_pred(Full_data=highStress25, n=300)

# * no recovery ----
newdata_21NRa<- HD_pred(Full_data=noRecov21, n=300)
newdata_25NRa <- HD_pred(Full_data = noRecov25, n = 300)

```

#### Predictions with new data - use function above 
```{r}
# * normal ----

# 21a
modelg21a_predictions<-predict(g21a, newdata=newdata_21a, type="response", se.fit=TRUE, discrete=T) # Create predictions
# Edit data frame
newdatag21a<-newdata_21a%>%
  mutate(Prediction=modelg21a_predictions$fit)%>%
  mutate(SE=modelg21a_predictions$se.fit,
         L95=Prediction-SE*1.96,
         U95=Prediction+SE*1.96)

# * binomial models ----
# g21abin
modelg21abin_predictions<-predict(g21abin, newdata=newdata_21a, type="response", se.fit=TRUE, discrete=T) # Create predictions
# Edit data frame
newdatag21abin<-newdata_21a%>%
  mutate(Prediction=modelg21abin_predictions$fit)%>%
  mutate(SE=modelg21abin_predictions$se.fit,
         L95=Prediction-SE*1.96,
         U95=Prediction+SE*1.96)
summary(newdatag21abin$Prediction)

# g25abin


# * no recovery ----


```


# Out of function
```{r}
# Create point locations on a grid for predictions
  Points<-st_make_grid(regions, n=100)%>%
    st_as_sf(crs=st_crs(regions))%>%
    st_join(deltabuff) %>%
    
    # Joining a map of delta waterways (from my spacetools package) to ensure all these points are over water.
    st_coordinates()%>%
    as_tibble()%>%
    mutate(Location=1:nrow(.))%>%
    dplyr::select(Longitude=X, Latitude=Y, Location)


newdata<-expand.grid(Location=1:nrow(Points),
                     Anomaly = c(-2,0,2)) %>%
  left_join(Points, by="Location") %>% #Add Lat/Longs to each location
  mutate(Latitude_s=(Latitude-mean(highStress21$Latitude))/sd(highStress21$Latitude), # Standardize each variable based on full dataset for model
Longitude_s=(Longitude-mean(highStress21$Longitude, na.rm=T))/sd(highStress21$Longitude, na.rm=T),
           Anomaly_s = (Anomaly-mean(highStress21$Anomaly, na.rm=T))/sd(highStress21$Anomaly, na.rm=T)) %>%
    st_as_sf(coords=c("Longitude", "Latitude"), crs=4326, remove=FALSE)%>% # Turn into sf object
    st_transform(crs=st_crs(deltabuff))%>% # transform to crs of Delta shapefile
    st_join(Delta_subregions, join = st_intersects)

```


Function to rasterize data
- What does map() do? One map for each anomaly 
- st_rasterize will rasterize your data. dx = cell size x, dy = cell size y
  - Take your max x - min x and divide by number of cells, same with y
- What is exec(c) part?

# map = apply
for every unique Anomaly, we will rasterize data, where Anomaly = x (-2,0,2), select Prediction, rasterize area within delta

bang bang unquotes, bang bang bang (big bang) operator: unquotes several operators at once
```{r}
Rasterize_all <- function(data, var, out_crs=4326, n=100){
  var<-rlang::enquo(var)
  rlang::as_name(var)
  preds<-map(unique(data$Anomaly), 
             function(x) st_rasterize(data%>%
                                      filter(Anomaly==x)%>%
                                      dplyr::select(!!var),                 
                                      template=st_as_stars(st_bbox(delta2),
              dx=diff(st_bbox(delta2)[c(1, 3)])/n,                     dy=diff(st_bbox(delta2)[c(2, 4)])/n, values = NA_real_))%>%
               st_warp(crs=out_crs))
  return(preds)
  # Then bind all Anomalies together into 1 raster
  out <- exec(c, !!!preds, along=list(Anomaly=unique(data$Anomaly)))
  return(out)
}

```

Rasterize (use function above)
```{r}
# Create full rasterization of all predictions for interactive visualizations
rastered_preds21a<-Rasterize_all(newdatag21a, Prediction)
rastered_preds21abin<-Rasterize_all(newdatag21abin, Prediction)

# Same for SE
rastered_SE21a<-Rasterize_all(newdatag21a, Prediction)
rastered_SE21abin<-Rasterize_all(newdatag21abin, SE)
```


Plot raster
- What is [,,,Anomaly] and what are the matrices produced?

```{r}
raster_plot2<-function(data, Anomaly=2, labels="All"){
  data = data[,,,Anomaly]
  data = st_crop(data, deltabuff)
  ggplot()+
    geom_stars(data=data)+
   # facet_wrap(~Date)+
    scale_fill_viridis_c(name="PropDays", na.value="white", breaks=seq(0,1,by=.1), limits = c(0,1),
                        # labels= function(x) ifelse((x/2)==as.integer(x/2), as.character(x), ""),
                         guide = guide_colorbar(direction="horizontal", title.position = "top", barwidth = 10, ticks.linewidth = 2,
                                                barheight=1, title.hjust=0.5, label.position="bottom", label.theme=element_text(size=12), 
                                                title.theme=element_text(size=13)))+
    coord_sf()+
    ylab("Latitude")+
    xlab("Longitude")+
    theme_bw() + theme(legend.position = "top")
}

raster_plot2(rastered_preds21a) + ggtitle("propDays > 21")
raster_plot2(rastered_preds21abin, 3) + ggtitle("propDays > 21")
```

```{r}
rasterEx <- rastered_preds21abin[[3]] %>%
  st_crop(deltabuff)

 ggplot()+
    geom_stars(data=rasterEx)+
   # facet_wrap(~Date)+
    scale_fill_viridis_c(name="PropDays", na.value="white", breaks=seq(0,.5,by=.1), limits = c(0,.5),
                        # labels= function(x) ifelse((x/2)==as.integer(x/2), as.character(x), ""),
                         guide = guide_colorbar(direction="horizontal", title.position = "top", barwidth = 10, ticks.linewidth = 2,
                                                barheight=1, title.hjust=0.5, label.position="bottom", label.theme=element_text(size=12), 
                                                title.theme=element_text(size=13)))+
    coord_sf()+
    ylab("Latitude")+
    xlab("Longitude")+
    theme_bw() + theme(legend.position = "top")
```

