---
title: "Temperature cluster analysis"
author: "Rosie"
date: "7/16/2020"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lubridate)
library(tidyverse)
library(vegan)
temps = readRDS("Temp_filtered (1).rds")
```

## Cluster analysis

So, Larry was unceratain as to how to do cluster analysis when we "just have one variable". While it's true that we only have temperature to work with, if we really only just had one variable we could group stations with similar average temperatures and be done with it. However, we really do have a multivariate dataset because each station has different average temperatures at different times of year, and different variance in tempareture. We want to group stations with similar temperature regimes, rather than just similar averages.

Now, there are a number of different ways to describe the temperature regime, but I thought I would start by taking the average daily mean temperature over the past five years.

I used Cat's continuous data set rather than the descrete data set because it is a more balanced design where we will have a mean temperature for each day of the year and we know it was taken at the exact same spot.

```{r warning=FALSE, message=FALSE, fig.width= 12}

#first calculate the daily means
tempmean = temps %>%
  filter(Date > as.Date("2014-1-1"), Station != "RYF") %>%
  mutate(julian = yday(Date)) %>%
  group_by(Station, julian) %>%
  summarize(Temp = mean(Temp, na.rm = T))

#put it into wide format for the cluster analysis
tempwide = pivot_wider(tempmean, id_cols = c(Station), 
                       names_from = julian, values_from = Temp)

row.names(tempwide) = tempwide$Station

#calculate distance and cluster
tempdist = dist(tempwide, "euclidean")
tempfit = hclust(tempdist, method = "ward.D")
plot(tempfit, main = "Clusters based on daily ave temp", cex = 0.6)

```

## Or we could use monthly means, mins, and maxes

I haven't sat down to compare the monthly mins, means, and maxes with the daily means, but a quick look seems like they are pretty similar

```{r warning=FALSE, message=FALSE, fig.width=12}


#monthly mean, min, and max per year
tempmo = temps %>%
  filter(Date > as.Date("2014-1-1"), Station != "RYF") %>%
  mutate(Month = month(Date), Year = year(Date)) %>%
  group_by(Station, Month, Year) %>%
  summarize(Temp = mean(Temp, na.rm = T), min = min(Temp), max = max(Temp))

#average over five years
tempmo2 = tempmo %>%
  group_by(Station, Month) %>%
  summarize(Temp = mean(Temp, na.rm = T), min = mean(min, na.rm = T), max = mean(max, na.rm = T))

#put it into wide format for the cluster analysis
tempmowide = pivot_wider(tempmo2, id_cols = c(Station), 
                       names_from = Month, values_from = Temp)
tempmowide2 = pivot_wider(tempmo2, id_cols = c(Station), 
                         names_from = Month, values_from = min)
tempmowide3 = pivot_wider(tempmo2, id_cols = c(Station), 
                         names_from = Month, values_from = max)

tempmowide4 = cbind(tempmowide, tempmowide2[,-1], tempmowide3[,-1])

row.names(tempmowide4) = tempmowide4$Station

#calculate distance and cluster
tempdist3 = dist(tempmowide4, "euclidean")
tempfit3 = hclust(tempdist3, method = "ward.D")
plot(tempfit3, main = "Clusters based on monthly ave, min max", cex = 0.6)

```

I thought I'd look at a quick NMDS too, just for fun

```{r warning=FALSE, message=FALSE, echo=FALSE}
tempNMDS = metaMDS(tempdist3, trymax = 200)
plot(tempNMDS, type = "n")
text(tempNMDS, "sites", labels = tempmowide4$Station)

```



## CDEC stations

Now the question is whether teh clusters actually work out geographically. I'm going to have to spend some time with this map printed out and a highlighter to see how it lines up.

![CDEC stations included in analysis](CDEC_stations.jpg)

## Cutting down the trees

Now I can cut my trees into groups to see how they map out.

```{r}
cutday = as.data.frame(cutree(tempfit, k = c(2,4,6,12)))
cutday$Station = row.names(cutday)
```


## Plot

I trimmed the tree into different numbers of groups, so see what we get when we try to divide it into 2,4,6, or 12 regions.

```{r}

library("sf")
library(dplyr)
library(ggplot2)
library(leaflet)
library(scales)
library(ggmap)

#read in shapefile of the delta
delta = read_sf("deltashap/hydro_delta_marsh.shp")

#read in shapefile of EDSM regions
edsm = read_sf("EDSM_Subregions/EDSM_Subregions_03302020.shp")
edsm2 = read_sf("03302020_shape/EDSM_Subregions_03302020.shp")
#reference system is UTMs
st_crs(edsm) = 32610
st_crs(edsm2) = 32610
edsm = st_transform(edsm, 4326)

#for some reason they didn't include the strata in teh shapfile, so I"m attaching it seperately
EDSM = read.csv("C:/Users/rhartman/OneDrive - California Department of Water Resources/salinity control gates/SMSCG/EDSM_KDTR.csv")


foo1 =  sort(unique(EDSM$SubRegion))
foo2 = sort(unique(edsm$SubRegion))

foo3 = list(shapefile = foo2, EDI = foo1)


EDSM = mutate(EDSM, Date = mdy(Date)) %>%
  filter(year(Date) > 2018) %>%
  group_by( Region, SubRegion, Stratum) %>%
  summarize(count = length(Tow))

edsm = left_join(edsm, EDSM)

foo = select(as.data.frame(edsm), -geometry, -count)

#add lat/longs for the stations
stas = read.csv("StationLatLongs.csv")

cutday = merge(cutday, stas)
names(cutday) = c("Station", "grps2", "grps4", "grps6", "grps12", "Latitude","Longitude")

#turn it into a spatial object
stashap = st_as_sf(cutday,
                coords = c("Longitude", "Latitude"),
                crs = 4326)

gp4 = ggplot() +
  geom_sf(data = delta, alpha = 0.5)+
  geom_sf(data = stashap, mapping =aes(color = as.factor(grps4)))+
  theme_bw() + guides(color = FALSE) + 
  coord_sf(xlim = c(-122.2, -121), ylim = c(37.6, 38.8))+
  ggtitle("4 groups")

library(RColorBrewer)
mypal = c(brewer.pal(9, "Blues"), brewer.pal(9, "BuGn"), 
          brewer.pal(9, "Greys"), brewer.pal(9, "PuBu"), brewer.pal(9, "YlGn"))
gp6 = ggplot() +
  geom_sf(data = edsm, mapping = aes(fill = Region, color = Region), alpha = 0.5)+
  scale_fill_brewer(palette = "Set3")+
  geom_sf(data = delta, alpha = 0.5)+
  geom_sf(data = stashap, mapping =aes(color = as.factor(grps6)))+
  scale_color_brewer(palette = "Set1")+
  theme_bw() + guides(color = FALSE, fill = FALSE) + 
  coord_sf(xlim = c(-122.2, -121), ylim = c(37.6, 38.8))+
  ggtitle("6 groups")

gp6

gp6a = ggplot() +
  geom_sf(data = edsm, mapping = aes(fill = Region), alpha = 0.5)+
  geom_sf(data = delta, alpha = 0.5)+
  geom_sf(data = stashap, mapping =aes(color = as.factor(grps6)))+
  theme_bw() + guides(color = FALSE, fill = FALSE) + 
  #coord_sf(xlim = c(-122.2, -121), ylim = c(37.6, 38.8))+
  ggtitle("6 groups")

gp6a

gp12 = ggplot() +
  geom_sf(data = delta, alpha = 0.5)+
  geom_sf(data = stashap, mapping =aes(color = as.factor(grps12)))+
  theme_bw() + guides(color = FALSE) + 
  coord_sf(xlim = c(-122.2, -121), ylim = c(37.6, 38.8))+
  ggtitle("12 groups")

library(gridExtra)

foo = grid.arrange(gp4, gp6, gp12, nrow = 1, ncol = 3)

#ggsave("tempclusters.png",foo, device = "png", width = 12)

```
## Join with EDSM regions

I want to see how closely the EDSM regions map to my clusters. 

```{r}

spas = st_join(stashap, edsm)
stjoin = as.data.frame(spas)[,1:8]

regions = pivot_wider(stjoin, id_cols = c(Region, SubRegion), names_from = grps6, values_from = Station, values_fn = length)

```


